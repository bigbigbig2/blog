<template><p>æœ¬æ–‡ç« ä¸»è¦éƒ¨åˆ†ä¸ºhttps://www.postgresqltutorial.comç¿»è¯‘ç®€åŒ–çš„å­¦ä¹ ç¬”è®°</p>
<h2 id="_1-ç®€ä»‹" tabindex="-1"><a class="header-anchor" href="#_1-ç®€ä»‹" aria-hidden="true">#</a> 1.ç®€ä»‹</h2>
<p>L/pgSQLæ˜¯ä¸€ç§ç”¨äºPostgreSQLæ•°æ®åº“ç³»ç»Ÿçš„å¯è½½å…¥çš„è¿‡ç¨‹è¯­è¨€ã€‚</p>
<ul>
<li>å¯ä»¥è¢«ç”¨æ¥åˆ›å»ºå‡½æ•°å’Œè§¦å‘å™¨è¿‡ç¨‹</li>
<li>å¯¹SQLè¯­è¨€å¢åŠ æ§åˆ¶ç»“æ„</li>
<li>å¯ä»¥æ‰§è¡Œå¤æ‚è®¡ç®—</li>
<li>ç»§æ‰¿æ‰€æœ‰ç”¨æˆ·å®šä¹‰ç±»å‹ã€å‡½æ•°å’Œæ“ä½œç¬¦</li>
<li>å¯ä»¥è¢«å®šä¹‰ä¸ºå—æœåŠ¡å™¨ä¿¡ä»»</li>
<li>ä¾¿äºä½¿ç”¨</li>
</ul>
<h3 id="_1-ä½¿ç”¨pl-pgsqlçš„ä¼˜ç‚¹" tabindex="-1"><a class="header-anchor" href="#_1-ä½¿ç”¨pl-pgsqlçš„ä¼˜ç‚¹" aria-hidden="true">#</a> [1]ä½¿ç”¨PL/pgSQLçš„ä¼˜ç‚¹</h3>
<p>SQL æ˜¯ä¸€ç§æŸ¥è¯¢è¯­è¨€ï¼Œå¯è®©æ‚¨è½»æ¾åœ°ä»æ•°æ®åº“ä¸­æŸ¥è¯¢æ•°æ®ã€‚ä½†æ˜¯ï¼ŒPostgreSQL åªèƒ½å•ç‹¬æ‰§è¡Œ SQL è¯­å¥ã€‚</p>
<p>è¿™æ„å‘³ç€æ‚¨æœ‰å¤šä¸ªè¯­å¥ï¼Œæ‚¨éœ€è¦åƒè¿™æ ·ä¸€ä¸ªä¸€ä¸ªåœ°æ‰§è¡Œå®ƒä»¬ï¼š</p>
<ul>
<li>é¦–å…ˆï¼Œå‘ PostgreSQL æ•°æ®åº“æœåŠ¡å™¨å‘é€æŸ¥è¯¢ã€‚</li>
<li>æ¥ä¸‹æ¥ï¼Œç­‰å¾…å®ƒå¤„ç†ã€‚</li>
<li>ç„¶åï¼Œå¤„ç†ç»“æœé›†ã€‚</li>
<li>ä¹‹åï¼Œè¿›è¡Œä¸€äº›è®¡ç®—ã€‚</li>
<li>æœ€åï¼Œå‘ PostgreSQL æ•°æ®åº“æœåŠ¡å™¨å‘é€å¦ä¸€ä¸ªæŸ¥è¯¢å¹¶é‡å¤æ­¤è¿‡ç¨‹ã€‚</li>
</ul>
<p>æ­¤è¿‡ç¨‹ä¼šäº§ç”Ÿè¿›ç¨‹é—´é€šä¿¡å’Œç½‘ç»œå¼€é”€ã€‚</p>
<p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒPostgreSQL ä½¿ç”¨ PL/pgSQLã€‚</p>
<p>PL/pgSQL å°†å¤šä¸ªè¯­å¥åŒ…è£…åœ¨ä¸€ä¸ªå¯¹è±¡ä¸­å¹¶å°†å…¶å­˜å‚¨åœ¨ PostgreSQL æ•°æ®åº“æœåŠ¡å™¨ä¸Šã€‚</p>
<p>å› æ­¤ï¼Œæ‚¨å¯ä»¥å‘é€ä¸€æ¡è¯­å¥æ¥æ‰§è¡Œå­˜å‚¨åœ¨æœåŠ¡å™¨ä¸­çš„å¯¹è±¡ï¼Œè€Œä¸æ˜¯ä¸€ä¸€å‘é€å¤šä¸ªè¯­å¥åˆ°æœåŠ¡å™¨ã€‚è¿™ä½¿æ‚¨å¯ä»¥ï¼š</p>
<ul>
<li>å‡å°‘åº”ç”¨ç¨‹åºå’Œ PostgreSQL æ•°æ®åº“æœåŠ¡å™¨ä¹‹é—´çš„å¾€è¿”æ¬¡æ•°ã€‚</li>
<li>é¿å…åœ¨åº”ç”¨ç¨‹åºå’ŒæœåŠ¡å™¨ä¹‹é—´ä¼ è¾“å³æ—¶ç»“æœã€‚</li>
</ul>
<h3 id="_2-postgresql-pl-pgsql-çš„ç¼ºç‚¹" tabindex="-1"><a class="header-anchor" href="#_2-postgresql-pl-pgsql-çš„ç¼ºç‚¹" aria-hidden="true">#</a> [2]PostgreSQL PL/pgSQL çš„ç¼ºç‚¹</h3>
<p>é™¤äº†ä½¿ç”¨ PL/pgSQL çš„ä¼˜ç‚¹ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€äº›æ³¨æ„äº‹é¡¹ï¼š</p>
<ul>
<li>è½¯ä»¶å¼€å‘é€Ÿåº¦è¾ƒæ…¢ï¼Œå› ä¸º PL/pgSQL éœ€è¦è®¸å¤šå¼€å‘äººå‘˜ä¸å…·å¤‡çš„ä¸“ä¸šæŠ€èƒ½ã€‚</li>
<li>ç‰ˆæœ¬ç®¡ç†å›°éš¾ï¼Œè°ƒè¯•å›°éš¾ã€‚</li>
<li>å¯èƒ½æ— æ³•ç§»æ¤åˆ°å…¶ä»–æ•°æ®åº“ç®¡ç†ç³»ç»Ÿ</li>
</ul>
<h2 id="_2-ç¬¦å·å¼•ç”¨çš„å­—ç¬¦ä¸²å¸¸é‡" tabindex="-1"><a class="header-anchor" href="#_2-ç¬¦å·å¼•ç”¨çš„å­—ç¬¦ä¸²å¸¸é‡" aria-hidden="true">#</a> 2.$$ç¬¦å·å¼•ç”¨çš„å­—ç¬¦ä¸²å¸¸é‡</h2>
<p>å¦‚ä½•<code>$$</code>åœ¨ç”¨æˆ·å®šä¹‰çš„å‡½æ•°å’Œå­˜å‚¨è¿‡ç¨‹ä¸­ä½¿ç”¨ç¾å…ƒå¼•ç”¨çš„å­—ç¬¦ä¸²å¸¸é‡ ã€‚</p>
<p>åœ¨ PostgreSQL ä¸­ï¼Œä½¿ç”¨å•å¼•å·ä½œä¸ºå­—ç¬¦ä¸²å¸¸é‡ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token keyword">select</span> <span class="token string">'String constant'</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>å½“å­—ç¬¦ä¸²å¸¸é‡åŒ…å«å•å¼•å· ( <code>'</code>) æ—¶ï¼Œæ‚¨éœ€è¦é€šè¿‡åŠ å€å•å¼•å·æ¥å¯¹å…¶è¿›è¡Œè½¬ä¹‰ã€‚ä¾‹å¦‚ï¼š</p>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token keyword">select</span> <span class="token string">'I''m also a string constant'</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>PostgreSQL 8.0 ç‰ˆå¼•å…¥äº†ç¾å…ƒç¬¦å·å¼•ç”¨åŠŸèƒ½ï¼Œä½¿å­—ç¬¦ä¸²å¸¸é‡æ›´å…·å¯è¯»æ€§ã€‚</p>
<p>è¯­æ³•ï¼š</p>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>$tag$&lt;string_constant>$tag$
åœ¨æ­¤è¯­æ³•ä¸­ï¼Œtagæ˜¯å¯é€‰çš„ã€‚å®ƒå¯èƒ½åŒ…å«é›¶ä¸ªæˆ–å¤šä¸ªå­—ç¬¦ã€‚
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>åœ¨ä¸¤ä¸ª<code>$tag$</code>ä¹‹é—´ï¼Œä½ å¯ä»¥æ”¾ç½®ä»»ä½•å¸¦æœ‰å•å¼•å· ( <code>'</code>) å’Œåæ–œæ  ( <code>\</code>) çš„å­—ç¬¦ä¸²ã€‚ä¾‹å¦‚ï¼š</p>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token keyword">select</span> $$I'm a string constant that <span class="token keyword">contains</span> a backslash \$$<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2eb0622df1dc4f3197aea315069cc1e4~tplv-k3u1fbpfcp-zoom-1.image" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p>ä½¿ç”¨å¸¦æ ‡è®°çš„ç¾å…ƒå¼•å·å­—ç¬¦ä¸²å¸¸é‡è¯­æ³•ï¼š</p>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>SELECT $message$I'm a string constant that contains a backslash \$message$;
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6750ac6b8f08429bb1d3452c1d3d25eb~tplv-k3u1fbpfcp-zoom-1.image" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<h3 id="_1-åœ¨åŒ¿åå—ä¸­ä½¿ç”¨" tabindex="-1"><a class="header-anchor" href="#_1-åœ¨åŒ¿åå—ä¸­ä½¿ç”¨" aria-hidden="true">#</a> [1]åœ¨åŒ¿åå—ä¸­ä½¿ç”¨$$</h3>
<p>ä¸€ä¸ªç®€å•çš„PL/pgSQLåŒ¿åå—</p>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token keyword">do</span> 
<span class="token string">'declare
   film_count integer;
begin 
   select count(*) into film_count
   from film;
   raise notice ''The number of films: %'', film_count;
end;'</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>å—ä¸­çš„ä»£ç å¿…é¡»ç”¨å•å¼•å·æ‹¬èµ·æ¥ã€‚å¦‚æœå®ƒå†…éƒ¨æœ‰ä»»ä½•å•å¼•å·ï¼Œåˆ™éœ€è¦é€šè¿‡åƒè¿™æ ·å°†å…¶è½¬ä¹‰ï¼š</p>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>raise notice ''The number of films: %'', film_count;
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><h3 id="_2-åœ¨å‡½æ•°ä¸­ä½¿ç”¨" tabindex="-1"><a class="header-anchor" href="#_2-åœ¨å‡½æ•°ä¸­ä½¿ç”¨" aria-hidden="true">#</a> [2]åœ¨å‡½æ•°ä¸­ä½¿ç”¨$$</h3>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token keyword">create</span> <span class="token keyword">function</span> function_name<span class="token punctuation">(</span>param_list<span class="token punctuation">)</span> 
    <span class="token keyword">returns</span> datatype
<span class="token keyword">language</span> lang_name
<span class="token keyword">as</span> 
 <span class="token string">'function_body'</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>åœ¨è¿™ç§è¯­æ³•ä¸­ï¼Œ<code>function_body</code>æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²å¸¸é‡ã€‚ä¾‹å¦‚ï¼Œä»¥ä¸‹å‡½æ•°é€šè¿‡ id æŸ¥æ‰¾ç”µå½±ï¼š</p>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token keyword">create</span> <span class="token keyword">function</span> find_film_by_id<span class="token punctuation">(</span>
   id <span class="token keyword">int</span>
<span class="token punctuation">)</span> <span class="token keyword">returns</span> film 
<span class="token keyword">language</span> <span class="token keyword">sql</span>
<span class="token keyword">as</span> 
  <span class="token string">'select * from film 
   where film_id = id'</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>å¦‚æ‚¨æ‰€è§ï¼Œ<code>find_film_by_id()</code>å‡½æ•°çš„ä¸»ä½“ç”¨å•å¼•å·æ‹¬èµ·æ¥ã€‚</p>
<p>å¦‚æœå‡½æ•°æœ‰å¾ˆå¤šè¯­å¥ï¼Œå®ƒå°±ä¼šå˜å¾—æ›´éš¾é˜…è¯»ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ç¾å…ƒå¼•ç”¨çš„å­—ç¬¦ä¸²å¸¸é‡è¯­æ³•ï¼š</p>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token keyword">create</span> <span class="token keyword">function</span> find_film_by_id<span class="token punctuation">(</span>
   id <span class="token keyword">int</span>
<span class="token punctuation">)</span> <span class="token keyword">returns</span> film 
<span class="token keyword">language</span> <span class="token keyword">sql</span>
<span class="token keyword">as</span> 
$$
  <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> film 
  <span class="token keyword">where</span> film_id <span class="token operator">=</span> id<span class="token punctuation">;</span>  
$$<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="_2-åœ¨å­˜å‚¨è¿‡ç¨‹ä¸­ä½¿ç”¨" tabindex="-1"><a class="header-anchor" href="#_2-åœ¨å­˜å‚¨è¿‡ç¨‹ä¸­ä½¿ç”¨" aria-hidden="true">#</a> [2]åœ¨å­˜å‚¨è¿‡ç¨‹ä¸­ä½¿ç”¨$$</h3>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token keyword">create</span> <span class="token keyword">procedure</span> proc_name<span class="token punctuation">(</span>param_list<span class="token punctuation">)</span>
<span class="token keyword">language</span> lang_name
<span class="token keyword">as</span> $$
  <span class="token comment">-- stored procedure body</span>
$$
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h2 id="_3-pl-pgsql-å—ç»“æ„" tabindex="-1"><a class="header-anchor" href="#_3-pl-pgsql-å—ç»“æ„" aria-hidden="true">#</a> 3.PL/pgSQL å—ç»“æ„</h2>
<p>PL/pgSQL æ˜¯ä¸€ç§å—ç»“æ„è¯­è¨€ï¼Œå› æ­¤ï¼ŒPL/pgSQLå‡½æ•°æˆ–å­˜å‚¨è¿‡ç¨‹è¢«ç»„ç»‡æˆå—ã€‚</p>
<p>PL/pgSQL ä¸­å®Œæ•´å—çš„è¯­æ³•ï¼š</p>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token punctuation">[</span> <span class="token operator">&lt;&lt;</span>label<span class="token operator">>></span> <span class="token punctuation">]</span>
<span class="token punctuation">[</span> <span class="token keyword">declare</span>
    declarations <span class="token punctuation">]</span>
<span class="token keyword">begin</span>
    statements<span class="token punctuation">;</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token keyword">end</span> <span class="token punctuation">[</span> label <span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><blockquote>
<ul>
<li>æ¯ä¸ªå—æœ‰ä¸¤ä¸ªéƒ¨åˆ†ï¼šå£°æ˜å’Œæ­£æ–‡ã€‚å£°æ˜éƒ¨åˆ†æ˜¯å¯é€‰çš„ï¼Œè€Œæ­£æ–‡éƒ¨åˆ†æ˜¯å¿…éœ€çš„ã€‚å—ä»¥å…³é”®å­—<code>;</code>åçš„åˆ†å· ( ) ç»“æŸã€‚<code>END</code></li>
<li>ä¸€ä¸ªå—å¯èƒ½æœ‰ä¸€ä¸ªä½äºå¼€å¤´å’Œç»“å°¾çš„å¯é€‰æ ‡ç­¾labelã€‚<code>EXIT</code>å½“ä½ æƒ³åœ¨å—ä½“çš„è¯­å¥ä¸­æŒ‡å®šå®ƒæˆ–è€…å½“ä½ æƒ³é™å®šåœ¨å—ä¸­å£°æ˜çš„<a href="https://www.postgresqltutorial.com/plpgsql-variables/" target="_blank" rel="noopener noreferrer">å˜é‡</a>çš„åç§°æ—¶ï¼Œä½ å¯ä»¥ä½¿ç”¨å—æ ‡ç­¾</li>
<li>å£°æ˜éƒ¨åˆ†æ˜¯å£°æ˜åœ¨æ­£æ–‡ä¸­æ‰€ä½¿ç”¨çš„å˜é‡çš„åœ°æ–¹ã€‚å£°æ˜éƒ¨åˆ†ä¸­çš„æ¯æ¡è¯­å¥éƒ½ä»¥åˆ†å· ( <code>;</code>) ç»“æŸã€‚</li>
<li>æ­£æ–‡éƒ¨åˆ†æ˜¯æ”¾ç½®ä»£ç çš„åœ°æ–¹ã€‚æ­£æ–‡éƒ¨åˆ†ä¸­çš„æ¯ä¸ªè¯­å¥ä¹Ÿä»¥åˆ†å· (ğŸ˜‰ ç»“æŸã€‚</li>
<li></li>
</ul>
</blockquote>
<h3 id="_1-pl-pgsql-å—ç»“æ„ç¤ºä¾‹" tabindex="-1"><a class="header-anchor" href="#_1-pl-pgsql-å—ç»“æ„ç¤ºä¾‹" aria-hidden="true">#</a> [1]PL/pgSQL å—ç»“æ„ç¤ºä¾‹</h3>
<p>ä¸€ä¸ªåŒ¿åå—</p>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token keyword">do</span> $$ 
<span class="token operator">&lt;&lt;</span>first_block<span class="token operator">>></span>
<span class="token keyword">declare</span>
  film_count <span class="token keyword">integer</span> :<span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">begin</span>
   <span class="token comment">-- get the number of films</span>
   <span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> 
   <span class="token keyword">into</span> film_count
   <span class="token keyword">from</span> film<span class="token punctuation">;</span>
   <span class="token comment">-- display a message</span>
   raise notice <span class="token string">'The number of films is %'</span><span class="token punctuation">,</span> film_count<span class="token punctuation">;</span>
<span class="token keyword">end</span> first_block $$<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>NOTICE:  The current value of counter is 1
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><blockquote>
<ul>
<li>
<p>è¯¥<code>DO</code>è¯­å¥ä¸å±äºè¯¥å—ã€‚å®ƒç”¨äºæ‰§è¡ŒåŒ¿åå—ã€‚PostgreSQL<code>DO</code>ä» 9.0 ç‰ˆæœ¬å¼€å§‹å¼•å…¥è¯¥è¯­å¥ã€‚</p>
</li>
<li>
<p>åŒ¿åå—å¿…é¡»ç”¨å•å¼•å·æˆ–$$åŒ…èµ·æ¥</p>
</li>
</ul>
</blockquote>
<h3 id="_2-pl-pgsql-å­å—" tabindex="-1"><a class="header-anchor" href="#_2-pl-pgsql-å­å—" aria-hidden="true">#</a> [2]PL/pgSQL å­å—</h3>
<p>PL/pgSQL å…è®¸æ‚¨å°†ä¸€ä¸ªå—æ”¾ç½®åœ¨å¦ä¸€ä¸ªå—çš„ä¸»ä½“å†…ã€‚</p>
<p>åµŒå¥—åœ¨å¦ä¸€ä¸ªå—ä¸­çš„å—ç§°ä¸ºå­å—ã€‚åŒ…å«å­å—çš„å—ç§°ä¸ºå¤–å—ã€‚</p>
<p>ä¸‹å›¾è¯´æ˜äº†å¤–å—å’Œå­å—ï¼š</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/cc0c9cb456a9455fa35942c7a57c49bd~tplv-k3u1fbpfcp-zoom-1.image" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<blockquote>
<p>é€šå¸¸ï¼Œæ‚¨å°†ä¸€ä¸ªå¤§å—åˆ’åˆ†ä¸ºæ›´å°ä¸”æ›´å…·é€»è¾‘æ€§çš„å­å—ã€‚å­å—ä¸­çš„å˜é‡å¯ä»¥å…·æœ‰ä¸å¤–éƒ¨å—ä¸­çš„åç§°ç›¸åŒçš„åç§°ï¼Œå°½ç®¡è¿™ä¸æ˜¯ä¸€ä¸ªå¥½çš„åšæ³•ã€‚</p>
</blockquote>
<h3 id="_3-å°ç»“" tabindex="-1"><a class="header-anchor" href="#_3-å°ç»“" aria-hidden="true">#</a> [3]å°ç»“</h3>
<ul>
<li>PL/pgSQL æ˜¯ä¸€ç§å—ç»“æ„è¯­è¨€ã€‚å®ƒå°†ç¨‹åºç»„ç»‡æˆå—ã€‚</li>
<li>å—åŒ…å«ä¸¤éƒ¨åˆ†ï¼šå£°æ˜å’Œä¸»ä½“ã€‚å£°æ˜éƒ¨åˆ†æ˜¯å¯é€‰çš„ï¼Œè€Œæ­£æ–‡éƒ¨åˆ†æ˜¯å¼ºåˆ¶æ€§çš„ã€‚</li>
<li>å—å¯ä»¥åµŒå¥—ã€‚åµŒå¥—å—æ˜¯æ”¾ç½®åœ¨å¦ä¸€ä¸ªå—çš„ä¸»ä½“å†…çš„å—</li>
</ul>
<h2 id="_4-å˜é‡å’Œå¸¸é‡" tabindex="-1"><a class="header-anchor" href="#_4-å˜é‡å’Œå¸¸é‡" aria-hidden="true">#</a> 4.å˜é‡å’Œå¸¸é‡</h2>
<h3 id="_1-å˜é‡" tabindex="-1"><a class="header-anchor" href="#_1-å˜é‡" aria-hidden="true">#</a> [1]å˜é‡</h3>
<p>åœ¨ä½¿ç”¨å˜é‡ä¹‹å‰ï¼Œæ‚¨å¿…é¡»åœ¨<a href="https://www.postgresqltutorial.com/plpgsql-block-structure/" target="_blank" rel="noopener noreferrer">PL/pgSQL å—</a>çš„å£°æ˜éƒ¨åˆ†ä¸­å£°æ˜å®ƒ</p>
<p>å£°æ˜è¯­æ³•:</p>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>variable_name data_type [:= expression];
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><blockquote>
<ul>
<li>ä½¿ç”¨ç‰¹å®šæ•°æ®ç±»å‹ä¸å˜é‡ç›¸å…³è”ã€‚æ•°æ®ç±»å‹å¯ä»¥æ˜¯ä»»ä½•æœ‰æ•ˆçš„æ•°æ®ç±»å‹ï¼Œä¾‹å¦‚<a href="https://www.postgresqltutorial.com/postgresql-integer/" target="_blank" rel="noopener noreferrer">integer</a>ã€<a href="https://www.postgresqltutorial.com/postgresql-numeric/" target="_blank" rel="noopener noreferrer">numeric</a>ã€<a href="https://www.postgresqltutorial.com/postgresql-char-varchar-text/" target="_blank" rel="noopener noreferrer">varchar</a>å’Œ <a href="https://www.postgresqltutorial.com/postgresql-char-varchar-text/" target="_blank" rel="noopener noreferrer">char</a>ã€‚</li>
<li>å¯é€‰åœ°ä¸ºå˜é‡åˆ†é…é»˜è®¤å€¼ã€‚å¦‚æœä¸è¿™æ ·åšï¼Œå˜é‡çš„åˆå§‹å€¼ä¸º<code>NULL</code></li>
<li>å¯ä»¥ä½¿ç”¨<code>:=</code>æˆ–<code>=</code>èµ‹å€¼è¿ç®—ç¬¦æ¥åˆå§‹åŒ–å˜é‡å¹¶å°†å€¼åˆ†é…ç»™å˜é‡ã€‚</li>
</ul>
</blockquote>
<p>ç¤ºä¾‹ï¼š</p>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token keyword">do</span> $$ 
<span class="token keyword">declare</span>
   counter    <span class="token keyword">integer</span> :<span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
   first_name <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> :<span class="token operator">=</span> <span class="token string">'John'</span><span class="token punctuation">;</span>
   last_name  <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> :<span class="token operator">=</span> <span class="token string">'Doe'</span><span class="token punctuation">;</span>
   payment    <span class="token keyword">numeric</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> :<span class="token operator">=</span> <span class="token number">20.5</span><span class="token punctuation">;</span>
<span class="token keyword">begin</span> 
   raise notice <span class="token string">'% % % has been paid % USD'</span><span class="token punctuation">,</span> 
       counter<span class="token punctuation">,</span> 
	   first_name<span class="token punctuation">,</span> 
	   last_name<span class="token punctuation">,</span> 
	   payment<span class="token punctuation">;</span>
<span class="token keyword">end</span> $$<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/928382d7f5cc4151b29df7d25b54d9b1~tplv-k3u1fbpfcp-zoom-1.image" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token keyword">do</span> $$
<span class="token keyword">declare</span> 
	created_at <span class="token keyword">time</span> :<span class="token operator">=</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">begin</span> 
	raise notice <span class="token string">'%'</span><span class="token punctuation">,</span>created_at<span class="token punctuation">;</span>
	perform pg_sleep<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	raise notice <span class="token string">'%'</span><span class="token punctuation">,</span>created_at<span class="token punctuation">;</span>
<span class="token keyword">end</span> $$<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>NOTICE:  14:23:33.064008
NOTICE:  14:23:33.064008
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="_2-å¤åˆ¶æ•°æ®ç±»å‹" tabindex="-1"><a class="header-anchor" href="#_2-å¤åˆ¶æ•°æ®ç±»å‹" aria-hidden="true">#</a> [2]å¤åˆ¶æ•°æ®ç±»å‹</h3>
<p>ä½¿ç”¨%typeæ¥å¤åˆ¶è¡¨ä¸­æŸä¸ªå­—æ®µï¼ˆæˆ–æŸä¸ªå·²ç»å­˜åœ¨çš„å˜é‡ï¼‰çš„æ•°æ®ç±»å‹</p>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>variable_name table_name.column_name%type;
variable_name variable%type;
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>ç¤ºä¾‹ï¼š</p>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token keyword">do</span> $$ 
<span class="token keyword">declare</span>
   film_title film<span class="token punctuation">.</span>title<span class="token operator">%</span><span class="token keyword">type</span><span class="token punctuation">;</span>
   featured_title film_title<span class="token operator">%</span><span class="token keyword">type</span><span class="token punctuation">;</span>
<span class="token keyword">begin</span> 
   <span class="token comment">-- get title of the film id 100</span>
   <span class="token keyword">select</span> title
   <span class="token keyword">from</span> film
   <span class="token keyword">into</span> film_title
   <span class="token keyword">where</span> film_id <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>
   
   <span class="token comment">-- show the film title</span>
   raise notice <span class="token string">'Film title id 100: %s'</span><span class="token punctuation">,</span> film_title<span class="token punctuation">;</span>
<span class="token keyword">end</span><span class="token punctuation">;</span> $$
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h4 id="å—å’Œå­å—ä¸­çš„å˜é‡" tabindex="-1"><a class="header-anchor" href="#å—å’Œå­å—ä¸­çš„å˜é‡" aria-hidden="true">#</a> å—å’Œå­å—ä¸­çš„å˜é‡</h4>
<p>å½“æ‚¨åœ¨å­å—ä¸­å£°æ˜ä¸å¤–éƒ¨å—ä¸­çš„å¦ä¸€ä¸ªå˜é‡åŒåçš„å˜é‡æ—¶ï¼Œå¤–éƒ¨å—ä¸­çš„å˜é‡å°†éšè—åœ¨å­å—ä¸­ã€‚</p>
<p>å¦‚æœè¦è®¿é—®å¤–éƒ¨å—ä¸­çš„å˜é‡ï¼Œè¯·ä½¿ç”¨å—æ ‡ç­¾æ¥é™å®šå…¶åç§°ï¼Œå¦‚ä¸‹ä¾‹æ‰€ç¤ºï¼š</p>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token keyword">do</span> $$
<span class="token operator">&lt;&lt;</span>outer_block<span class="token operator">>></span>
<span class="token keyword">declare</span>
	counter <span class="token keyword">integer</span> :<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">begin</span> 
	counter :<span class="token operator">=</span>counter <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
	raise notice <span class="token string">'The current value of the counter is %'</span><span class="token punctuation">,</span>counter<span class="token punctuation">;</span>
	
	<span class="token keyword">declare</span> 
		counter <span class="token keyword">integer</span> :<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">begin</span> 
		counter :<span class="token operator">=</span>counter <span class="token operator">+</span><span class="token number">10</span><span class="token punctuation">;</span>
		raise notice <span class="token string">'Counter in the subblock is %'</span><span class="token punctuation">,</span>counter<span class="token punctuation">;</span>
		raise notice <span class="token string">'Counter in the outer block is %'</span><span class="token punctuation">,</span>outer_block<span class="token punctuation">.</span>counter<span class="token punctuation">;</span>
	<span class="token keyword">end</span><span class="token punctuation">;</span>
	
	raise notice <span class="token string">'Counter in the outer block is %'</span><span class="token punctuation">,</span>counter<span class="token punctuation">;</span>
<span class="token keyword">end</span> outer_block $$<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>NOTICE:  The current value of the counter is 1
NOTICE:  Counter in the subblock is 10
NOTICE:  Counter in the outer block is 1
NOTICE:  Counter in the outer block is 1
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><blockquote>
<ul>
<li>
<p>å†…éƒ¨å—ä¸å¤–éƒ¨å—å¯ä»¥åŒå</p>
</li>
<li>
<p>åœ¨å†…éƒ¨å—ä¸­ä½¿ç”¨å¤–éƒ¨å—çš„å˜é‡æ—¶ï¼Œéœ€è¦åŠ ä¸Šå¤–éƒ¨å—çš„è¡¨ç¤ºç¬¦</p>
</li>
</ul>
</blockquote>
<h3 id="_3-select-into" tabindex="-1"><a class="header-anchor" href="#_3-select-into" aria-hidden="true">#</a> [3]select into</h3>
<p>PostgreSQL<code>SELECT INTO</code>è¯­å¥åˆ›å»ºä¸€ä¸ªæ–°è¡¨å¹¶å°†æŸ¥è¯¢è¿”å›çš„æ•°æ®æ’å…¥åˆ°è¡¨ä¸­</p>
<p>ä¸å¸¸è§„<a href="https://www.postgresqltutorial.com/postgresql-select/" target="_blank" rel="noopener noreferrer"><code>SELECT</code></a>è¯­å¥ä¸åŒï¼Œè¯¥<code>SELECT INTO</code>è¯­å¥ä¸å‘å®¢æˆ·ç«¯è¿”å›ç»“æœ</p>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token keyword">SELECT</span>
    select_list
<span class="token keyword">INTO</span> <span class="token punctuation">[</span> <span class="token keyword">TEMPORARY</span> <span class="token operator">|</span> <span class="token keyword">TEMP</span> <span class="token operator">|</span> UNLOGGED <span class="token punctuation">]</span> <span class="token punctuation">[</span> <span class="token keyword">TABLE</span> <span class="token punctuation">]</span> new_table_name
<span class="token keyword">FROM</span>
    table_name
<span class="token keyword">WHERE</span>
    search_condition<span class="token punctuation">;</span>

</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><blockquote>
<ul>
<li>
<p>è¦ä½¿ç”¨ä»ç»“æœé›†æ´¾ç”Ÿçš„ç»“æ„å’Œæ•°æ®åˆ›å»ºæ–°è¡¨ï¼Œè¯·åœ¨<code>INTO</code>å…³é”®å­—åæŒ‡å®šæ–°è¡¨å</p>
</li>
<li>
<p><code>TEMP</code>or<code>TEMPORARY</code>å…³é”®å­—æ˜¯å¯é€‰çš„ï¼›å®ƒå…è®¸æ‚¨åˆ›å»ºä¸€ä¸ªä¸´æ—¶è¡¨</p>
</li>
<li>
<p>å¦‚æœå¯ç”¨çš„<code>UNLOGGED</code>å…³é”®å­—å°†ä½¿æ–°è¡¨æˆä¸ºæœªè®°å½•çš„è¡¨</p>
</li>
<li>
<p>ä¸èƒ½åœ¨ PL/pgSQL ä¸­ä½¿ç”¨<code>SELECT INTO</code>ï¼Œå› ä¸ºå®ƒå¯¹<code>INTO</code>å­å¥çš„è§£é‡Šä¸åŒã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨<code>CREATE TABLE AS</code>æä¾›æ¯”è¯­å¥æ›´å¤šåŠŸèƒ½çš„<code>SELECT INTO</code>è¯­å¥ã€‚</p>
</li>
</ul>
</blockquote>
<p><strong>ç¤ºä¾‹ï¼š</strong>(åˆ›å»ºä¸€ä¸ªæ–°è¡¨<code>film_r</code>)</p>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token keyword">SELECT</span>
    film_id<span class="token punctuation">,</span>
    title<span class="token punctuation">,</span>
    rental_rate
<span class="token keyword">INTO</span> <span class="token keyword">TABLE</span> film_r
<span class="token keyword">FROM</span>
    film
<span class="token keyword">WHERE</span>
    rating <span class="token operator">=</span> <span class="token string">'R'</span>
<span class="token operator">AND</span> rental_duration <span class="token operator">=</span> <span class="token number">5</span>
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span>
    title<span class="token punctuation">;</span>

</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>SELECT * FROM film_r;
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><p><strong>ç¤ºä¾‹ï¼š</strong>ï¼ˆåˆ›å»ºä¸€ä¸ªä¸´æ—¶è¡¨ï¼‰</p>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token keyword">SELECT</span>
    film_id<span class="token punctuation">,</span>
    title<span class="token punctuation">,</span>
    length 
<span class="token keyword">INTO</span> <span class="token keyword">TEMP</span> <span class="token keyword">TABLE</span> short_film
<span class="token keyword">FROM</span>
    film
<span class="token keyword">WHERE</span>
    length <span class="token operator">&lt;</span> <span class="token number">60</span>
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span>
    title<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="_4-è¡Œç±»å‹å˜é‡" tabindex="-1"><a class="header-anchor" href="#_4-è¡Œç±»å‹å˜é‡" aria-hidden="true">#</a> [4]è¡Œç±»å‹å˜é‡</h3>
<p>ä½¿ç”¨ PL/pgSQL è¡Œç±»å‹æ¥å£°æ˜ä¿å­˜ç»“æœé›†çš„å®Œæ•´è¡Œçš„è¡Œå˜é‡</p>
<p>è¦å­˜å‚¨è¯­å¥è¿”å›çš„ç»“æœé›†çš„æ•´è¡Œ<code>select into</code>ï¼Œè¯·ä½¿ç”¨è¡Œç±»å‹å˜é‡æˆ–è¡Œå˜é‡</p>
<p>æ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹è¯­æ³•å£°æ˜å…·æœ‰ä¸è¡¨ä¸­è¡Œçš„æ•°æ®ç±»å‹ç›¸åŒæ•°æ®ç±»å‹çš„å˜é‡ï¼š</p>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>row_variable table_name%ROWTYPE;
row_variable view_name%ROWTYPE;
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>è¦è®¿é—®è¡Œå˜é‡çš„å•ä¸ªå­—æ®µï¼Œè¯·ä½¿ç”¨ç‚¹è¡¨ç¤ºæ³• ( <code>.</code>)ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>row_variable.field_name
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><p><strong>ç¤ºä¾‹ï¼š</strong>ï¼ˆæ˜¾ç¤ºäº†æ¼”å‘˜ id 10 çš„åå­—å’Œå§“æ°ï¼‰</p>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token keyword">do</span> $$
<span class="token keyword">declare</span>
   selected_actor actor<span class="token operator">%</span>rowtype<span class="token punctuation">;</span>
<span class="token keyword">begin</span>
   <span class="token comment">-- select actor with id 10   </span>
   <span class="token keyword">select</span> <span class="token operator">*</span> 
   <span class="token keyword">from</span> actor
   <span class="token keyword">into</span> selected_actor   <span class="token comment">-- å°†æŸ¥è¯¢ç»“æœå­˜åˆ°è¿™ä¸ªè¡Œç±»å‹å˜é‡ä¸­</span>
   <span class="token keyword">where</span> actor_id <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>

   <span class="token comment">-- show the number of actor</span>
   raise notice <span class="token string">'The actor name is % %'</span><span class="token punctuation">,</span>
      selected_actor<span class="token punctuation">.</span>first_name<span class="token punctuation">,</span>
      selected_actor<span class="token punctuation">.</span>last_name<span class="token punctuation">;</span>
<span class="token keyword">end</span><span class="token punctuation">;</span> $$

</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h3 id="_5-è®°å½•ç±»å‹å˜é‡" tabindex="-1"><a class="header-anchor" href="#_5-è®°å½•ç±»å‹å˜é‡" aria-hidden="true">#</a> [5]è®°å½•ç±»å‹å˜é‡</h3>
<p>è®°å½•ç±»å‹å…è®¸æ‚¨å®šä¹‰å¯ä»¥ä¿å­˜ç»“æœé›†ä¸­å•è¡Œçš„å˜é‡</p>
<p><code>record</code>å˜é‡ç±»ä¼¼äºè¡Œç±»å‹å˜é‡ã€‚å®ƒåªèƒ½ä¿å­˜ç»“æœé›†çš„ä¸€è¡Œ</p>
<p>è¯­æ³•ï¼š<code>variable_name record;</code></p>
<p><strong>ç¤ºä¾‹1ï¼šï¼ˆä½¿ç”¨å¸¦æœ‰ select into è¯­å¥çš„è®°å½•ï¼‰</strong></p>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token keyword">do</span>
$$
<span class="token keyword">declare</span>
	rec record<span class="token punctuation">;</span>
<span class="token keyword">begin</span>
	<span class="token comment">-- select the film </span>
	<span class="token keyword">select</span> film_id<span class="token punctuation">,</span> title<span class="token punctuation">,</span> length 
	<span class="token keyword">into</span> rec
	<span class="token keyword">from</span> film
	<span class="token keyword">where</span> film_id <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">;</span>
	
	raise notice <span class="token string">'% % %'</span><span class="token punctuation">,</span> rec<span class="token punctuation">.</span>film_id<span class="token punctuation">,</span> rec<span class="token punctuation">.</span>title<span class="token punctuation">,</span> rec<span class="token punctuation">.</span>length<span class="token punctuation">;</span>   
	
<span class="token keyword">end</span><span class="token punctuation">;</span>
$$
<span class="token keyword">language</span> plpgsql<span class="token punctuation">;</span>

</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p><strong>ç¤ºä¾‹2ï¼šï¼ˆåœ¨forå¾ªç¯è¯­å¥ä¸­ä½¿ç”¨è®°å½•å˜é‡ï¼‰</strong></p>
<p>ä¸‹é¢å±•ç¤ºäº†å¦‚ä½•åœ¨<code>for loop</code>è¯­å¥ä¸­ä½¿ç”¨è®°å½•å˜é‡ï¼š</p>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token keyword">do</span>
$$
<span class="token keyword">declare</span>
	rec record<span class="token punctuation">;</span>
<span class="token keyword">begin</span>
	<span class="token keyword">for</span> rec <span class="token operator">in</span> <span class="token keyword">select</span> title<span class="token punctuation">,</span> length 
			<span class="token keyword">from</span> film 
			<span class="token keyword">where</span> length <span class="token operator">></span> <span class="token number">50</span>
			<span class="token keyword">order</span> <span class="token keyword">by</span> length
	<span class="token keyword">loop</span>
		raise notice <span class="token string">'% (%)'</span><span class="token punctuation">,</span> rec<span class="token punctuation">.</span>title<span class="token punctuation">,</span> rec<span class="token punctuation">.</span>length<span class="token punctuation">;</span>	
	<span class="token keyword">end</span> <span class="token keyword">loop</span><span class="token punctuation">;</span>
<span class="token keyword">end</span><span class="token punctuation">;</span>
$$
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>NOTICE:  Hall Cassidy (51)
NOTICE:  Champion Flatliners (51)
NOTICE:  Deep Crusade (51)
NOTICE:  Simon North (51)
NOTICE:  English Bulworth (51)
...
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><blockquote>
<ul>
<li>é¦–å…ˆï¼Œå£°æ˜ä¸€ä¸ªåä¸º r çš„å˜é‡ï¼Œå…¶ç±»å‹ä¸º<code>record</code>ã€‚</li>
<li>å…¶æ¬¡ï¼Œä½¿ç”¨è¯¥<code>for loop</code>è¯­å¥ä»<code>film</code>è¡¨ä¸­è·å–è¡Œï¼ˆåœ¨ç¤ºä¾‹æ•°æ®åº“ä¸­ï¼‰ã€‚è¯¥è¯­å¥åœ¨æ¯æ¬¡è¿­ä»£ä¸­å°†ç”±å’Œ<code>for loop</code>ç»„æˆçš„è¡Œåˆ†é…ç»™å˜é‡ã€‚titleï¼Œlengthï¼Œrec</li>
<li><code>rec.title</code>ä¸‰ã€ä½¿ç”¨ç‚¹è¡¨ç¤ºæ³•ï¼ˆå’Œ<code>rec.length</code>ï¼‰æ˜¾ç¤ºè®°å½•å˜é‡çš„å­—æ®µå†…å®¹</li>
</ul>
</blockquote>
<ul>
<li>è®°å½•æ˜¯ä¸€ä¸ªå ä½ç¬¦ï¼Œå¯ä»¥ä¿å­˜ç»“æœé›†çš„å•è¡Œã€‚</li>
<li>è®°å½•æ²¡æœ‰åƒè¡Œå˜é‡é‚£æ ·çš„é¢„å®šä¹‰ç»“æ„ã€‚å®ƒçš„ç»“æ„æ˜¯åœ¨æ‚¨ä¸ºå…¶åˆ†é…è¡Œæ—¶ç¡®å®šçš„ã€‚</li>
</ul>
<h3 id="_6-å¸¸é‡" tabindex="-1"><a class="header-anchor" href="#_6-å¸¸é‡" aria-hidden="true">#</a> [6]å¸¸é‡</h3>
<p>ä¸å˜é‡ä¸åŒï¼Œå¸¸é‡çš„å€¼ä¸€æ—¦åˆå§‹åŒ–å°±ä¸èƒ½æ›´æ”¹</p>
<p>å¸¸é‡ä½¿ä»£ç æ›´å…·å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§</p>
<p><strong>å®šä¹‰å¸¸é‡ï¼š</strong></p>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code>constant_name constant data_type :<span class="token operator">=</span> expression<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><p><strong>ç¤ºä¾‹ï¼š</strong></p>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token keyword">do</span> $$ 
<span class="token keyword">declare</span>
   vat constant <span class="token keyword">numeric</span> :<span class="token operator">=</span> <span class="token number">0.1</span><span class="token punctuation">;</span>
   net_price    <span class="token keyword">numeric</span> :<span class="token operator">=</span> <span class="token number">20.5</span><span class="token punctuation">;</span>
<span class="token keyword">begin</span>
   raise notice <span class="token string">'The selling price is %'</span><span class="token punctuation">,</span> net_price <span class="token operator">*</span> <span class="token punctuation">(</span> <span class="token number">1</span> <span class="token operator">+</span> vat <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">end</span> $$<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h2 id="_5-æŠ¥å‘Šæ¶ˆæ¯å’Œé”™è¯¯" tabindex="-1"><a class="header-anchor" href="#_5-æŠ¥å‘Šæ¶ˆæ¯å’Œé”™è¯¯" aria-hidden="true">#</a> 5.æŠ¥å‘Šæ¶ˆæ¯å’Œé”™è¯¯</h2>
<p>ä½¿ç”¨<code>raise</code>è¯­å¥æŠ¥å‘Šæ¶ˆæ¯å’Œå¼•å‘é”™è¯¯ï¼Œä½¿ç”¨è¯¥<code>assert</code>è¯­å¥å°†è°ƒè¯•æ£€æŸ¥æ’å…¥åˆ° PL/pgSQL å—ä¸­</p>
<h3 id="_1-æŠ¥å‘Šæ¶ˆæ¯" tabindex="-1"><a class="header-anchor" href="#_1-æŠ¥å‘Šæ¶ˆæ¯" aria-hidden="true">#</a> [1]æŠ¥å‘Šæ¶ˆæ¯</h3>
<p>è¦å¼•å‘æ¶ˆæ¯ï¼Œè¯·ä½¿ç”¨ä»¥ä¸‹<code>raise</code>è¯­å¥ï¼š</p>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>raise level format;
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>è®©æˆ‘ä»¬æ›´è¯¦ç»†åœ°æ£€æŸ¥è¯¥<code>raise</code>è¯­å¥ã€‚</p>
<h3 id="_2-ç­‰çº§" tabindex="-1"><a class="header-anchor" href="#_2-ç­‰çº§" aria-hidden="true">#</a> [2]ç­‰çº§</h3>
<p>è¯­å¥åé¢æ˜¯æŒ‡å®šé”™è¯¯ä¸¥é‡æ€§<code>raise</code>çš„é€‰é¡¹ã€‚<code>level</code></p>
<p>PostgreSQL æä¾›ä»¥ä¸‹çº§åˆ«ï¼š</p>
<ul>
<li><code>debug</code></li>
<li><code>log</code></li>
<li><code>notice</code></li>
<li><code>info</code></li>
<li><code>warning</code></li>
<li><code>exception</code></li>
</ul>
<p>å¦‚æœæ‚¨ä¸æŒ‡å®š<code>level</code>ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œè¯¥<code>raise</code>è¯­å¥å°†ä½¿ç”¨<code>exception</code> å¼•å‘é”™è¯¯å¹¶åœæ­¢å½“å‰äº‹åŠ¡çš„çº§åˆ«ã€‚</p>
<h3 id="_3-æ ¼å¼" tabindex="-1"><a class="header-anchor" href="#_3-æ ¼å¼" aria-hidden="true">#</a> [3]æ ¼å¼</h3>
<p>è¿™<code>format</code>æ˜¯ä¸€ä¸ªæŒ‡å®šæ¶ˆæ¯çš„å­—ç¬¦ä¸²ã€‚ä½¿ç”¨å°†ç”±å‚æ•°æ›¿æ¢çš„ç™¾åˆ†æ¯” ( ) å ä½ç¬¦<code>format</code>ã€‚<code>%</code></p>
<p>å ä½ç¬¦çš„æ•°é‡å¿…é¡»ä¸å‚æ•°çš„æ•°é‡ç›¸åŒï¼Œå¦åˆ™ PostgreSQL ä¼šæŠ¥é”™ï¼š</p>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>[Err] ERROR:  too many parameters specified for raiseä»£ç è¯­è¨€ï¼š CSS  ï¼ˆcss ï¼‰
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>ä»¥ä¸‹ç¤ºä¾‹è¯´æ˜äº†<code>raise</code>åœ¨å½“å‰æ—¶é—´æŠ¥å‘Šä¸åŒæ¶ˆæ¯çš„è¯­å¥ã€‚</p>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token keyword">do</span> $$ 
<span class="token keyword">begin</span> 
  raise info <span class="token string">'information message %'</span><span class="token punctuation">,</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
  raise log <span class="token string">'log message %'</span><span class="token punctuation">,</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  raise debug <span class="token string">'debug message %'</span><span class="token punctuation">,</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  raise warning <span class="token string">'warning message %'</span><span class="token punctuation">,</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  raise notice <span class="token string">'notice message %'</span><span class="token punctuation">,</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">end</span> $$<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>è¾“å‡ºï¼š
<img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/526ac613a29d4162a862628e936a1642~tplv-k3u1fbpfcp-zoom-1.image" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<blockquote>
<p>è¯·æ³¨æ„ï¼Œå¹¶éæ‰€æœ‰æ¶ˆæ¯éƒ½æŠ¥å‘Šç»™å®¢æˆ·ç«¯ã€‚PostgreSQL ä»…å°† ã€ å’Œ level æ¶ˆæ¯æŠ¥å‘Š<code>info</code>å›<code>warning</code>å®¢æˆ·<code>notice</code>ç«¯ã€‚è¿™ç”±<code>client_min_messages</code> é…ç½®<code>log_min_messages</code> å‚æ•°æ§åˆ¶</p>
</blockquote>
<h3 id="_4-å¼•å‘é”™è¯¯" tabindex="-1"><a class="header-anchor" href="#_4-å¼•å‘é”™è¯¯" aria-hidden="true">#</a> [4]å¼•å‘é”™è¯¯</h3>
<p>è¦å¼•å‘é”™è¯¯ï¼Œè¯·ä½¿ç”¨è¯­å¥<code>exception</code>åçš„çº§åˆ«ã€‚<code>raise</code>è¯·æ³¨æ„ï¼Œè¯¥<code>raise</code>è¯­å¥<code>exception</code>é»˜è®¤ä½¿ç”¨çº§åˆ«ã€‚</p>
<p>é™¤äº†å¼•å‘é”™è¯¯ä¹‹å¤–ï¼Œæ‚¨è¿˜å¯ä»¥ä½¿ç”¨ä»¥ä¸‹é™„åŠ å­å¥æ·»åŠ æ›´å¤šä¿¡æ¯ï¼š</p>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>using option = expression
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><p><code>option</code>å¯ä»¥æ˜¯ï¼š</p>
<ul>
<li><code>message</code>: è®¾ç½®é”™è¯¯ä¿¡æ¯</li>
<li><code>hint</code>ï¼šæä¾›æç¤ºä¿¡æ¯ï¼Œä»¥ä¾¿æ›´å®¹æ˜“å‘ç°é”™è¯¯çš„æ ¹æœ¬åŸå› ã€‚</li>
<li><code>detail</code>: æä¾›æœ‰å…³é”™è¯¯çš„è¯¦ç»†ä¿¡æ¯ã€‚</li>
<li><code>errcode</code>ï¼šè¯†åˆ«é”™è¯¯ä»£ç ï¼Œå¯ä»¥æ˜¯æ¡ä»¶åç§°ï¼Œä¹Ÿå¯ä»¥ç›´æ¥æ˜¯äº”å­—ç¬¦<code>SQLSTATE</code>ä»£ç ã€‚è¯·å‚é˜…<a href="https://www.postgresql.org/docs/current/static/errcodes-appendix.html" target="_blank" rel="noopener noreferrer">é”™è¯¯ä»£ç å’Œæ¡ä»¶åç§°è¡¨</a>ã€‚</li>
</ul>
<p>æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²å€¼çš„<code>expression</code>è¡¨è¾¾å¼ã€‚ä»¥ä¸‹ç¤ºä¾‹å¼•å‘é‡å¤çš„ç”µå­é‚®ä»¶é”™è¯¯æ¶ˆæ¯ï¼š</p>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token keyword">do</span> $$ 
<span class="token keyword">declare</span>
  email <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> :<span class="token operator">=</span> <span class="token string">'info@postgresqltutorial.com'</span><span class="token punctuation">;</span>
<span class="token keyword">begin</span> 
  <span class="token comment">-- check email for duplicate</span>
  <span class="token comment">-- ...</span>
  <span class="token comment">-- report duplicate email</span>
  raise exception <span class="token string">'duplicate email: %'</span><span class="token punctuation">,</span> email 
		<span class="token keyword">using</span> hint <span class="token operator">=</span> <span class="token string">'check the email again'</span><span class="token punctuation">;</span>
<span class="token keyword">end</span> $$<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/96cd19af3ee345e4a179ec8ffe701e7f~tplv-k3u1fbpfcp-zoom-1.image" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p>ä»¥ä¸‹ç¤ºä¾‹è¯´æ˜äº†å¦‚ä½•å¼•å‘ an<code>SQLSTATE</code>åŠå…¶å¯¹åº”çš„æ¡ä»¶ï¼š</p>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token keyword">do</span> $$ 
<span class="token keyword">begin</span> 
	<span class="token comment">--...</span>
	raise sqlstate <span class="token string">'2210b'</span><span class="token punctuation">;</span>
<span class="token keyword">end</span> $$<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token keyword">do</span> $$ 
<span class="token keyword">begin</span> 
	<span class="token comment">--...</span>
	raise invalid_regular_expression<span class="token punctuation">;</span>
<span class="token keyword">end</span> $$<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>ç°åœ¨æ‚¨å¯ä»¥ä½¿ç”¨<code>raise</code>è¯­å¥æ¥å¼•å‘æ¶ˆæ¯æˆ–æŠ¥å‘Šé”™è¯¯ã€‚</p>
<h3 id="_5-assert" tabindex="-1"><a class="header-anchor" href="#_5-assert" aria-hidden="true">#</a> [5]Assert</h3>
<p>PostgreSQL æ–­è¨€è¯­å¥ä»¥åŠå¦‚ä½•å°†å…¶ç”¨äºè°ƒè¯•ç›®çš„</p>
<blockquote>
<p>PostgreSQL<code>assert</code>ä» 9.5 ç‰ˆå¼€å§‹å¼•å…¥äº†è¯¥è¯­å¥ã€‚åœ¨ä½¿ç”¨ä¹‹å‰æ£€æŸ¥æ‚¨çš„ PostgreSQL ç‰ˆæœ¬ã€‚</p>
</blockquote>
<p>ä¸‹é¢è¯´æ˜äº†<code>assert</code>è¯­å¥çš„è¯­æ³•ï¼š</p>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code>assert condition <span class="token punctuation">[</span><span class="token punctuation">,</span> message<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>åœ¨è¿™ç§è¯­æ³•ä¸­ï¼š</p>
<h4 id="_1-æ¡ä»¶" tabindex="-1"><a class="header-anchor" href="#_1-æ¡ä»¶" aria-hidden="true">#</a> 1) æ¡ä»¶</h4>
<p>æ˜¯<code>condition</code>ä¸€ä¸ªå¸ƒå°”è¡¨è¾¾å¼ï¼Œé¢„æœŸæ€»æ˜¯è¿”å›<code>true</code>ã€‚</p>
<p>å¦‚æœ<code>condition</code>è®¡ç®—ç»“æœä¸º<code>true</code>ï¼Œåˆ™è¯¥<code>assert</code>è¯­å¥ä¸æ‰§è¡Œä»»ä½•æ“ä½œã€‚</p>
<p>å¦‚æœ<code>condition</code>è®¡ç®—ç»“æœä¸º<code>false</code>or <code>null</code>ï¼ŒPostgreSQL ä¼šå¼•å‘<code>assert_failure</code>å¼‚å¸¸ã€‚</p>
<h4 id="_2-ç•™è¨€" tabindex="-1"><a class="header-anchor" href="#_2-ç•™è¨€" aria-hidden="true">#</a> 2) ç•™è¨€</h4>
<p>è¯¥æ¶ˆæ¯æ˜¯å¯é€‰çš„ã€‚</p>
<p>å¦‚æœä½ ä¸é€šè¿‡<code>message</code>ï¼ŒPostgreSQL<code>assertion failed</code>é»˜è®¤ä½¿ç”¨â€œ â€æ¶ˆæ¯ã€‚å¦‚æœæ‚¨å°† ä¼ é€’<code>message</code>ç»™<code>assert</code>è¯­å¥ï¼Œå®ƒå°†ä½¿ç”¨å®ƒæ¥æ›¿æ¢é»˜è®¤æ¶ˆæ¯ã€‚</p>
<p>è¯·æ³¨æ„ï¼Œæ‚¨åº”è¯¥å°†è¯¥<code>assert</code>è¯­å¥ä»…ç”¨äºæ£€æµ‹é”™è¯¯ï¼Œè€Œä¸æ˜¯ç”¨äºæŠ¥å‘Šã€‚è¦æŠ¥å‘Šæ¶ˆæ¯æˆ–é”™è¯¯ï¼Œè¯·æ”¹ç”¨<code>raise</code>è¯­å¥ã€‚</p>
<h4 id="å¯ç”¨-ç¦ç”¨æ–­è¨€" tabindex="-1"><a class="header-anchor" href="#å¯ç”¨-ç¦ç”¨æ–­è¨€" aria-hidden="true">#</a> å¯ç”¨/ç¦ç”¨æ–­è¨€</h4>
<p>PostgreSQL æä¾›<code>plpgsql.check_asserts</code>é…ç½®å‚æ•°æ¥å¯ç”¨æˆ–ç¦ç”¨æ–­è¨€æµ‹è¯•ã€‚å¦‚æœå°†æ­¤å‚æ•°è®¾ç½®ä¸º<code>off</code>ï¼Œåˆ™ assert è¯­å¥å°†ä¸æ‰§è¡Œä»»ä½•æ“ä½œã€‚</p>
<p>ç¤ºä¾‹ï¼šä½¿ç”¨è¯¥<code>assert</code>è¯­å¥æ£€æŸ¥ç¤ºä¾‹æ•°æ®åº“<code>film</code>ä¸­çš„è¡¨æ˜¯å¦æœ‰æ•°æ®ï¼š</p>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token keyword">do</span> $$
<span class="token keyword">declare</span> 
   film_count <span class="token keyword">integer</span><span class="token punctuation">;</span>
<span class="token keyword">begin</span>
   <span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span>
   <span class="token keyword">into</span> film_count
   <span class="token keyword">from</span> film<span class="token punctuation">;</span>
   
   assert film_count <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'Film not found, check the film table'</span><span class="token punctuation">;</span>
<span class="token keyword">end</span>$$<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>å› ä¸ºç”µå½±è¡¨æœ‰æ•°æ®ï¼Œæ‰€ä»¥å—æ²¡æœ‰å‘å‡ºä»»ä½•æ¶ˆæ¯ã€‚</p>
<p>ä»¥ä¸‹ç¤ºä¾‹å‘å‡ºé”™è¯¯ï¼Œå› ä¸ºç”µå½±è¡¨ä¸­çš„ç”µå½±æ•°é‡ä¸å¤§äº<code>1,000</code>ã€‚</p>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token keyword">do</span> $$
<span class="token keyword">declare</span> 
   film_count <span class="token keyword">integer</span><span class="token punctuation">;</span>
<span class="token keyword">begin</span>
   <span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span>
   <span class="token keyword">into</span> film_count
   <span class="token keyword">from</span> film<span class="token punctuation">;</span>
   
   assert film_count <span class="token operator">></span> <span class="token number">1000</span><span class="token punctuation">,</span> <span class="token string">'1000 Film found, check the film table'</span><span class="token punctuation">;</span>
<span class="token keyword">end</span>$$<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f84de95d406c436c902575e4e777a86a~tplv-k3u1fbpfcp-zoom-1.image" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p>å°ç»“ï¼š</p>
<ul>
<li>ä½¿ç”¨è¯¥<code>assert</code>è¯­å¥å°†è°ƒè¯•æ£€æŸ¥æ·»åŠ åˆ° PL/pgSQL ä»£ç ã€‚</li>
<li>è¯¥<code>assert</code>è¯­å¥è¯„ä¼°<code>condition</code>é¢„æœŸä¸ºçš„ a å¹¶åœ¨æ¡ä»¶ä¸ºæˆ–<code>true</code>çš„æƒ…å†µä¸‹å‘å‡ºé”™è¯¯ã€‚<code>false``null</code></li>
<li>è¯¥<code>assert</code>è¯­å¥ä»…ç”¨äºæ£€æµ‹é”™è¯¯ã€‚è¦æŠ¥å‘Šæ™®é€šæ¶ˆæ¯å’Œé”™è¯¯ï¼Œè¯·æ”¹ç”¨è¯¥<code>raise</code>è¯­å¥ã€‚</li>
</ul>
<h2 id="_5-æ§åˆ¶ç»“æ„" tabindex="-1"><a class="header-anchor" href="#_5-æ§åˆ¶ç»“æ„" aria-hidden="true">#</a> 5.æ§åˆ¶ç»“æ„</h2>
<h3 id="_1-if" tabindex="-1"><a class="header-anchor" href="#_1-if" aria-hidden="true">#</a> [1]if</h3>
<p>PL/pgSQL æä¾›äº†ä¸‰ç§å½¢å¼çš„<code>if</code>è¯­å¥ã€‚</p>
<ul>
<li><code>if then</code></li>
<li><code>if then else</code></li>
<li><code>if then elsif</code></li>
</ul>
<h4 id="_1-pl-pgsql-if-then-è¯­å¥" tabindex="-1"><a class="header-anchor" href="#_1-pl-pgsql-if-then-è¯­å¥" aria-hidden="true">#</a> 1) PL/pgSQL if-then è¯­å¥</h4>
<p>ä¸‹é¢è¯´æ˜äº†è¯¥<code>if</code>è¯­å¥çš„æœ€ç®€å•å½¢å¼ï¼š</p>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token keyword">if</span> condition <span class="token keyword">then</span>
   statements<span class="token punctuation">;</span>
<span class="token keyword">end</span> <span class="token keyword">if</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6741ec70084c45959256a3b571e93b27~tplv-k3u1fbpfcp-zoom-1.image" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p>ä½¿ç”¨ç¤ºä¾‹ï¼š</p>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token keyword">do</span> $$
<span class="token keyword">declare</span>
  selected_film film<span class="token operator">%</span>rowtype<span class="token punctuation">;</span>
  input_film_id film<span class="token punctuation">.</span>film_id<span class="token operator">%</span><span class="token keyword">type</span> :<span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">begin</span>  

  <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> film
  <span class="token keyword">into</span> selected_film
  <span class="token keyword">where</span> film_id <span class="token operator">=</span> input_film_id<span class="token punctuation">;</span>
  
  <span class="token keyword">if</span> <span class="token operator">not</span> found <span class="token keyword">then</span>
     raise notice<span class="token string">'The film % could not be found'</span><span class="token punctuation">,</span> 
	    input_film_id<span class="token punctuation">;</span>
  <span class="token keyword">end</span> <span class="token keyword">if</span><span class="token punctuation">;</span>
<span class="token keyword">end</span> $$
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><blockquote>
<p>è¿™<code>found</code>æ˜¯ä¸€ä¸ªåœ¨ PL/pgSQL è¿‡ç¨‹è¯­è¨€ä¸­å¯ç”¨çš„å…¨å±€å˜é‡</p>
</blockquote>
<h4 id="_2-pl-pgsql-if-then-else-è¯­å¥" tabindex="-1"><a class="header-anchor" href="#_2-pl-pgsql-if-then-else-è¯­å¥" aria-hidden="true">#</a> 2) PL/pgSQL if-then-else è¯­å¥</h4>
<p>è¯­æ³•</p>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token keyword">if</span> condition <span class="token keyword">then</span>
  statements<span class="token punctuation">;</span>
<span class="token keyword">else</span>
  alternative<span class="token operator">-</span>statements<span class="token punctuation">;</span>
<span class="token keyword">END</span> <span class="token keyword">if</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>ç¤ºä¾‹ï¼š</p>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token keyword">do</span> $$
<span class="token keyword">declare</span>
  selected_film film<span class="token operator">%</span>rowtype<span class="token punctuation">;</span>
  input_film_id film<span class="token punctuation">.</span>film_id<span class="token operator">%</span><span class="token keyword">type</span> :<span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>
<span class="token keyword">begin</span>  

  <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> film
  <span class="token keyword">into</span> selected_film
  <span class="token keyword">where</span> film_id <span class="token operator">=</span> input_film_id<span class="token punctuation">;</span>
  
  <span class="token keyword">if</span> <span class="token operator">not</span> found <span class="token keyword">then</span>
     raise notice <span class="token string">'The film % could not be found'</span><span class="token punctuation">,</span> 
	    input_film_id<span class="token punctuation">;</span>
  <span class="token keyword">else</span>
     raise notice <span class="token string">'The film title is %'</span><span class="token punctuation">,</span> selected_film<span class="token punctuation">.</span>title<span class="token punctuation">;</span>
  <span class="token keyword">end</span> <span class="token keyword">if</span><span class="token punctuation">;</span>
<span class="token keyword">end</span> $$
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h4 id="_3-pl-pgsql-if-then-elsif-è¯­å¥" tabindex="-1"><a class="header-anchor" href="#_3-pl-pgsql-if-then-elsif-è¯­å¥" aria-hidden="true">#</a> 3) PL/pgSQL if-then-elsif è¯­å¥</h4>
<p>è¯­æ³•ï¼š</p>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token keyword">if</span> condition_1 <span class="token keyword">then</span>
  statement_1<span class="token punctuation">;</span>
elsif condition_2 <span class="token keyword">then</span>
  statement_2
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
elsif condition_n <span class="token keyword">then</span>
  statement_n<span class="token punctuation">;</span>
<span class="token keyword">else</span>
  <span class="token keyword">else</span><span class="token operator">-</span>statement<span class="token punctuation">;</span>
<span class="token keyword">end</span> <span class="token keyword">if</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>ç¤ºä¾‹ï¼š</p>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token keyword">do</span> $$
<span class="token keyword">declare</span>
   v_film film<span class="token operator">%</span>rowtype<span class="token punctuation">;</span>
   len_description <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">begin</span>  

  <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> film
  <span class="token keyword">into</span> v_film
  <span class="token keyword">where</span> film_id <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>
  
  <span class="token keyword">if</span> <span class="token operator">not</span> found <span class="token keyword">then</span>
     raise notice <span class="token string">'Film not found'</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span>
      <span class="token keyword">if</span> v_film<span class="token punctuation">.</span>length <span class="token operator">></span><span class="token number">0</span> <span class="token operator">and</span> v_film<span class="token punctuation">.</span>length <span class="token operator">&lt;=</span> <span class="token number">50</span> <span class="token keyword">then</span>
		 len_description :<span class="token operator">=</span> <span class="token string">'Short'</span><span class="token punctuation">;</span>
	  elsif v_film<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">50</span> <span class="token operator">and</span> v_film<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> <span class="token number">120</span> <span class="token keyword">then</span>
		 len_description :<span class="token operator">=</span> <span class="token string">'Medium'</span><span class="token punctuation">;</span>
	  elsif v_film<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">120</span> <span class="token keyword">then</span>
		 len_description :<span class="token operator">=</span> <span class="token string">'Long'</span><span class="token punctuation">;</span>
	  <span class="token keyword">else</span> 
		 len_description :<span class="token operator">=</span> <span class="token string">'N/A'</span><span class="token punctuation">;</span>
	  <span class="token keyword">end</span> <span class="token keyword">if</span><span class="token punctuation">;</span>
    
	  raise notice <span class="token string">'The % film is %.'</span><span class="token punctuation">,</span>
	     v_film<span class="token punctuation">.</span>title<span class="token punctuation">,</span>  
	     len_description<span class="token punctuation">;</span>
  <span class="token keyword">end</span> <span class="token keyword">if</span><span class="token punctuation">;</span>
<span class="token keyword">end</span> $$
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><h3 id="_2-caseè¯­å¥" tabindex="-1"><a class="header-anchor" href="#_2-caseè¯­å¥" aria-hidden="true">#</a> [2]caseè¯­å¥</h3>
<p><code>case</code>å£°æ˜æœ‰ä¸¤ç§å½¢å¼ï¼š</p>
<ul>
<li>ç®€å•çš„<code>case</code>é™ˆè¿°</li>
<li>æœç´¢<code>case</code>è¯­å¥</li>
</ul>
<blockquote>
<p>è¯·æ³¨æ„ï¼Œæ‚¨ä¸è¦æ··æ·†<code>case</code>è¯­å¥å’Œcase è¡¨è¾¾å¼ã€‚<code>case</code>è¡¨è¾¾å¼è®¡ç®—ä¸ºä¸€ä¸ªå€¼ï¼Œè€Œè¯­å¥<code>case</code>æ ¹æ®æ¡ä»¶é€‰æ‹©è¦æ‰§è¡Œçš„éƒ¨åˆ†ã€‚</p>
</blockquote>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token keyword">case</span> search<span class="token operator">-</span>expression
   <span class="token keyword">when</span> expression_1 <span class="token punctuation">[</span><span class="token punctuation">,</span> expression_2<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span> <span class="token keyword">then</span>
      <span class="token keyword">when</span><span class="token operator">-</span>statements
  <span class="token punctuation">[</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">]</span>
  <span class="token punctuation">[</span><span class="token keyword">else</span>
      <span class="token keyword">else</span><span class="token operator">-</span>statements <span class="token punctuation">]</span>
<span class="token keyword">END</span> <span class="token keyword">case</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h4 id="_1-ç®€å•çš„caseè¯­å¥" tabindex="-1"><a class="header-anchor" href="#_1-ç®€å•çš„caseè¯­å¥" aria-hidden="true">#</a> 1) ç®€å•çš„caseè¯­å¥</h4>
<p>ç¤ºä¾‹ï¼š</p>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token keyword">do</span> $$
<span class="token keyword">declare</span> 
	rate   film<span class="token punctuation">.</span>rental_rate<span class="token operator">%</span><span class="token keyword">type</span><span class="token punctuation">;</span>
	price_segment <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">begin</span>
    <span class="token comment">-- get the rental rate</span>
    <span class="token keyword">select</span> rental_rate <span class="token keyword">into</span> rate 
    <span class="token keyword">from</span> film 
    <span class="token keyword">where</span> film_id <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>
	
	<span class="token comment">-- assign the price segment</span>
	<span class="token keyword">if</span> found <span class="token keyword">then</span>
		<span class="token keyword">case</span> rate
		   <span class="token keyword">when</span> <span class="token number">0.99</span> <span class="token keyword">then</span>
              price_segment <span class="token operator">=</span>  <span class="token string">'Mass'</span><span class="token punctuation">;</span>
		   <span class="token keyword">when</span> <span class="token number">2.99</span> <span class="token keyword">then</span>
              price_segment <span class="token operator">=</span> <span class="token string">'Mainstream'</span><span class="token punctuation">;</span>
		   <span class="token keyword">when</span> <span class="token number">4.99</span> <span class="token keyword">then</span>
              price_segment <span class="token operator">=</span> <span class="token string">'High End'</span><span class="token punctuation">;</span>
		   <span class="token keyword">else</span>
	    	  price_segment <span class="token operator">=</span> <span class="token string">'Unspecified'</span><span class="token punctuation">;</span>
		   <span class="token keyword">end</span> <span class="token keyword">case</span><span class="token punctuation">;</span>
		raise notice <span class="token string">'%'</span><span class="token punctuation">,</span> price_segment<span class="token punctuation">;</span>  
    <span class="token keyword">end</span> <span class="token keyword">if</span><span class="token punctuation">;</span>
<span class="token keyword">end</span><span class="token punctuation">;</span> $$
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/217dc98b791d4786a9effad9cae375bc~tplv-k3u1fbpfcp-zoom-1.image" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<h4 id="_2-æ£€ç´¢æ¡ˆä¾‹é™ˆè¿°" tabindex="-1"><a class="header-anchor" href="#_2-æ£€ç´¢æ¡ˆä¾‹é™ˆè¿°" aria-hidden="true">#</a> 2) æ£€ç´¢æ¡ˆä¾‹é™ˆè¿°</h4>
<p>ä»¥ä¸‹è¯­æ³•æ˜¾ç¤ºäº†æœç´¢<code>case</code>è¯­å¥çš„è¯­æ³•ï¼š</p>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token keyword">case</span>
    <span class="token keyword">when</span> <span class="token keyword">boolean</span><span class="token operator">-</span>expression<span class="token operator">-</span><span class="token number">1</span> <span class="token keyword">then</span>
      statements
  <span class="token punctuation">[</span> <span class="token keyword">when</span> <span class="token keyword">boolean</span><span class="token operator">-</span>expression<span class="token operator">-</span><span class="token number">2</span> <span class="token keyword">then</span>
      statements
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">]</span>
  <span class="token punctuation">[</span> <span class="token keyword">else</span>
      statements <span class="token punctuation">]</span>
<span class="token keyword">end</span> <span class="token keyword">case</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>ç¤ºä¾‹ï¼š</p>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token keyword">do</span> $$ 
<span class="token keyword">declare</span>
    total_payment <span class="token keyword">numeric</span><span class="token punctuation">;</span> 
    service_level <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
<span class="token keyword">begin</span>
     <span class="token keyword">select</span> <span class="token function">sum</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span> <span class="token keyword">into</span> total_payment
     <span class="token keyword">from</span> Payment
     <span class="token keyword">where</span> customer_id <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span> 
	 
	 <span class="token keyword">if</span> found <span class="token keyword">then</span>
	    <span class="token keyword">case</span> 
		   <span class="token keyword">when</span> total_payment <span class="token operator">></span> <span class="token number">200</span> <span class="token keyword">then</span>
               service_level <span class="token operator">=</span> <span class="token string">'Platinum'</span> <span class="token punctuation">;</span>
           <span class="token keyword">when</span> total_payment <span class="token operator">></span> <span class="token number">100</span> <span class="token keyword">then</span>
	           service_level <span class="token operator">=</span> <span class="token string">'Gold'</span> <span class="token punctuation">;</span>
           <span class="token keyword">else</span>
               service_level <span class="token operator">=</span> <span class="token string">'Silver'</span> <span class="token punctuation">;</span>
        <span class="token keyword">end</span> <span class="token keyword">case</span><span class="token punctuation">;</span>
		raise notice <span class="token string">'Service Level: %'</span><span class="token punctuation">,</span> service_level<span class="token punctuation">;</span>
     <span class="token keyword">else</span>
	    raise notice <span class="token string">'Customer not found'</span><span class="token punctuation">;</span>
	 <span class="token keyword">end</span> <span class="token keyword">if</span><span class="token punctuation">;</span>
<span class="token keyword">end</span><span class="token punctuation">;</span> $$ 

</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><h3 id="_3-loopå¾ªç¯" tabindex="-1"><a class="header-anchor" href="#_3-loopå¾ªç¯" aria-hidden="true">#</a> [3]loopå¾ªç¯</h3>
<p><code>loop</code>é‡å¤æ‰§è¡Œä¸€æ®µä»£ç ï¼Œç›´åˆ°è¢«<code>exit</code>or<code>return</code>è¯­å¥ç»ˆæ­¢</p>
<p><strong>è¯­æ³•ï¼š</strong></p>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token operator">&lt;&lt;</span>label<span class="token operator">>></span>
<span class="token keyword">loop</span>
   statements<span class="token punctuation">;</span>
<span class="token keyword">end</span> <span class="token keyword">loop</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>é€šå¸¸ä½¿ç”¨<code>if</code>å¾ªç¯å†…çš„è¯­å¥æ¥æ ¹æ®å¦‚ä¸‹æ¡ä»¶ç»ˆæ­¢å®ƒï¼š</p>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token operator">&lt;&lt;</span>label<span class="token operator">>></span>
<span class="token keyword">loop</span>
   statements<span class="token punctuation">;</span>
   <span class="token keyword">if</span> condition <span class="token keyword">then</span>
      <span class="token keyword">exit</span><span class="token punctuation">;</span>
   <span class="token keyword">end</span> <span class="token keyword">if</span><span class="token punctuation">;</span>
<span class="token keyword">end</span> <span class="token keyword">loop</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>ä¹Ÿå¯ä»¥åµŒå¥—å¾ªç¯</p>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token operator">&lt;&lt;</span><span class="token keyword">outer</span><span class="token operator">>></span>
<span class="token keyword">loop</span> 
   statements<span class="token punctuation">;</span>
   <span class="token operator">&lt;&lt;</span><span class="token keyword">inner</span><span class="token operator">>></span>
   <span class="token keyword">loop</span>
     <span class="token comment">/* ... */</span>
     <span class="token keyword">exit</span> <span class="token operator">&lt;&lt;</span><span class="token keyword">inner</span><span class="token operator">>></span>
   <span class="token keyword">end</span> <span class="token keyword">loop</span><span class="token punctuation">;</span>
<span class="token keyword">end</span> <span class="token keyword">loop</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><blockquote>
<p>å½“æœ‰åµŒå¥—å¾ªç¯æ—¶ï¼Œéœ€è¦ä½¿ç”¨å¾ªç¯æ ‡ç­¾ï¼Œä»¥ä¾¿å¯ä»¥åœ¨<code>exit</code>and<code>continue</code>è¯­å¥ä¸­æŒ‡å®šå®ƒä»¥æŒ‡ç¤ºè¿™äº›è¯­å¥å¼•ç”¨å“ªä¸ªå¾ªç¯ã€‚</p>
</blockquote>
<p><strong>ç¤ºä¾‹ï¼š</strong></p>
<p>ä½¿ç”¨<code>loop</code>è¯­å¥æ¥è®¡ç®—æ–æ³¢é‚£å¥‘æ•°åˆ—</p>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token keyword">do</span> $$
<span class="token keyword">declare</span>
   n <span class="token keyword">integer</span>:<span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
   fib <span class="token keyword">integer</span> :<span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
   counter <span class="token keyword">integer</span> :<span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span> 
   i <span class="token keyword">integer</span> :<span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span> 
   j <span class="token keyword">integer</span> :<span class="token operator">=</span> <span class="token number">1</span> <span class="token punctuation">;</span>
<span class="token keyword">begin</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">then</span>
		fib :<span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span>
	<span class="token keyword">end</span> <span class="token keyword">if</span><span class="token punctuation">;</span> 
	<span class="token keyword">loop</span> 
		<span class="token keyword">exit</span> <span class="token keyword">when</span> counter <span class="token operator">=</span> n <span class="token punctuation">;</span> 
		counter :<span class="token operator">=</span> counter <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">;</span> 
		<span class="token keyword">select</span> j<span class="token punctuation">,</span> i <span class="token operator">+</span> j <span class="token keyword">into</span> i<span class="token punctuation">,</span>	j <span class="token punctuation">;</span>
	<span class="token keyword">end</span> <span class="token keyword">loop</span><span class="token punctuation">;</span> 
	fib :<span class="token operator">=</span> i<span class="token punctuation">;</span>
    raise notice <span class="token string">'%'</span><span class="token punctuation">,</span> fib<span class="token punctuation">;</span> 
<span class="token keyword">end</span><span class="token punctuation">;</span> $$
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h3 id="_4-whileå¾ªç¯" tabindex="-1"><a class="header-anchor" href="#_4-whileå¾ªç¯" aria-hidden="true">#</a> [4]whileå¾ªç¯</h3>
<p><code>while</code>å¾ªç¯è¯­å¥æ‰§è¡Œä»£ç å—ï¼Œç›´åˆ°æ¡ä»¶è®¡ç®—ä¸º<code>false</code>ã€‚</p>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token punctuation">[</span> <span class="token operator">&lt;&lt;</span>label<span class="token operator">>></span> <span class="token punctuation">]</span>
<span class="token keyword">while</span> condition <span class="token keyword">loop</span>
   statements<span class="token punctuation">;</span>
<span class="token keyword">end</span> <span class="token keyword">loop</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><strong>ç¤ºä¾‹ï¼šï¼ˆä½¿ç”¨<code>while</code>å¾ªç¯è¯­å¥æ¥æ˜¾ç¤ºè®¡æ•°å™¨çš„å€¼ï¼‰</strong></p>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token keyword">do</span> $$
<span class="token keyword">declare</span> 
   counter <span class="token keyword">integer</span> :<span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">begin</span>
   <span class="token keyword">while</span> counter <span class="token operator">&lt;</span> <span class="token number">5</span> <span class="token keyword">loop</span>
      raise notice <span class="token string">'Counter %'</span><span class="token punctuation">,</span> counter<span class="token punctuation">;</span>
	  counter :<span class="token operator">=</span> counter <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
   <span class="token keyword">end</span> <span class="token keyword">loop</span><span class="token punctuation">;</span>
<span class="token keyword">end</span>$$<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="_5-forå¾ªç¯" tabindex="-1"><a class="header-anchor" href="#_5-forå¾ªç¯" aria-hidden="true">#</a> [5]forå¾ªç¯</h3>
<p>ä¸‹é¢è¯´æ˜äº†åœ¨<code>for</code>æ•´æ•°èŒƒå›´å†…å¾ªç¯çš„å¾ªç¯è¯­å¥çš„è¯­æ³•ï¼š</p>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token punctuation">[</span> <span class="token operator">&lt;&lt;</span>label<span class="token operator">>></span> <span class="token punctuation">]</span>
<span class="token keyword">for</span> loop_counter <span class="token operator">in</span> <span class="token punctuation">[</span> reverse <span class="token punctuation">]</span> <span class="token keyword">from</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token keyword">to</span> <span class="token punctuation">[</span> <span class="token keyword">by</span> step <span class="token punctuation">]</span> <span class="token keyword">loop</span>
    statements
<span class="token keyword">end</span> <span class="token keyword">loop</span> <span class="token punctuation">[</span> label <span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>ç¤ºä¾‹ï¼š</p>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token keyword">do</span> $$
<span class="token keyword">begin</span>
   <span class="token keyword">for</span> counter <span class="token operator">in</span> <span class="token number">1.</span><span class="token number">.5</span> <span class="token keyword">loop</span>
	raise notice <span class="token string">'counter: %'</span><span class="token punctuation">,</span> counter<span class="token punctuation">;</span>
   <span class="token keyword">end</span> <span class="token keyword">loop</span><span class="token punctuation">;</span>
<span class="token keyword">end</span><span class="token punctuation">;</span> $$
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>NOTICE:  Counter: 1
NOTICE:  Counter: 2
NOTICE:  Counter: 3
NOTICE:  Counter: 4
NOTICE:  Counter: 5
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token keyword">do</span> $$
<span class="token keyword">begin</span>
   <span class="token keyword">for</span> counter <span class="token operator">in</span> reverse <span class="token number">5.</span><span class="token number">.1</span> <span class="token keyword">loop</span>
      raise notice <span class="token string">'counter: %'</span><span class="token punctuation">,</span> counter<span class="token punctuation">;</span>
   <span class="token keyword">end</span> <span class="token keyword">loop</span><span class="token punctuation">;</span>
<span class="token keyword">end</span><span class="token punctuation">;</span> $$
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>NOTICE:  Counter: 5
NOTICE:  Counter: 4
NOTICE:  Counter: 3
NOTICE:  Counter: 2
NOTICE:  Counter: 1
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token keyword">do</span> $$
<span class="token keyword">begin</span> 
  <span class="token keyword">for</span> counter <span class="token operator">in</span> <span class="token number">1.</span><span class="token number">.6</span> <span class="token keyword">by</span> <span class="token number">2</span> <span class="token keyword">loop</span>
    raise notice <span class="token string">'counter: %'</span><span class="token punctuation">,</span> counter<span class="token punctuation">;</span>
  <span class="token keyword">end</span> <span class="token keyword">loop</span><span class="token punctuation">;</span>
<span class="token keyword">end</span><span class="token punctuation">;</span> $$
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>NOTICE:  Counter 1
NOTICE:  Counter 3
NOTICE:  Counter 5
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h4 id="ä½¿ç”¨-pl-pgsql-for-å¾ªç¯æŸ¥è¯¢ç»“æœ" tabindex="-1"><a class="header-anchor" href="#ä½¿ç”¨-pl-pgsql-for-å¾ªç¯æŸ¥è¯¢ç»“æœ" aria-hidden="true">#</a> ä½¿ç”¨ PL/pgSQL for å¾ªç¯æŸ¥è¯¢ç»“æœ</h4>
<p>è¯­æ³•ï¼š</p>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token punctuation">[</span> <span class="token operator">&lt;&lt;</span>label<span class="token operator">>></span> <span class="token punctuation">]</span>
<span class="token keyword">for</span> target <span class="token operator">in</span> query <span class="token keyword">loop</span>
    statements
<span class="token keyword">end</span> <span class="token keyword">loop</span> <span class="token punctuation">[</span> label <span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>ç¤ºä¾‹ï¼š</p>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token keyword">do</span>
$$
<span class="token keyword">declare</span>
    f record<span class="token punctuation">;</span>
<span class="token keyword">begin</span>
    <span class="token keyword">for</span> f <span class="token operator">in</span> <span class="token keyword">select</span> title<span class="token punctuation">,</span> length 
	       <span class="token keyword">from</span> film 
	       <span class="token keyword">order</span> <span class="token keyword">by</span> length <span class="token keyword">desc</span><span class="token punctuation">,</span> title
	       <span class="token keyword">limit</span> <span class="token number">10</span> 
    <span class="token keyword">loop</span> 
	raise notice <span class="token string">'%(% mins)'</span><span class="token punctuation">,</span> f<span class="token punctuation">.</span>title<span class="token punctuation">,</span> f<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    <span class="token keyword">end</span> <span class="token keyword">loop</span><span class="token punctuation">;</span>
<span class="token keyword">end</span><span class="token punctuation">;</span>
$$
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>NOTICE:  Chicago North(185 mins)
NOTICE:  Control Anthem(185 mins)
NOTICE:  Darn Forrester(185 mins)
NOTICE:  Gangs Pride(185 mins)
NOTICE:  Home Pity(185 mins)
NOTICE:  Muscle Bright(185 mins)
NOTICE:  Pond Seattle(185 mins)
NOTICE:  Soldiers Evolution(185 mins)
NOTICE:  Sweet Brotherhood(185 mins)
NOTICE:  Worst Banger(185 mins)
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h4 id="ä½¿ç”¨-pl-pgsql-for-å¾ªç¯åŠ¨æ€æŸ¥è¯¢ç»“æœ" tabindex="-1"><a class="header-anchor" href="#ä½¿ç”¨-pl-pgsql-for-å¾ªç¯åŠ¨æ€æŸ¥è¯¢ç»“æœ" aria-hidden="true">#</a> ä½¿ç”¨ PL/pgSQL for å¾ªç¯åŠ¨æ€æŸ¥è¯¢ç»“æœ</h4>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token punctuation">[</span> <span class="token operator">&lt;&lt;</span>label<span class="token operator">>></span> <span class="token punctuation">]</span>
<span class="token keyword">for</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">execute</span> query_expression <span class="token punctuation">[</span> <span class="token keyword">using</span> query_param <span class="token punctuation">[</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">]</span> <span class="token punctuation">]</span> 
<span class="token keyword">loop</span>
    statements
<span class="token keyword">end</span> <span class="token keyword">loop</span> <span class="token punctuation">[</span> label <span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>ç¤ºä¾‹ï¼š</p>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token keyword">do</span> $$
<span class="token keyword">declare</span>
    <span class="token comment">-- sort by 1: title, 2: release year</span>
    sort_type <span class="token keyword">smallint</span> :<span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> 
	<span class="token comment">-- return the number of films</span>
	rec_count <span class="token keyword">int</span> :<span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
	<span class="token comment">-- use to iterate over the film</span>
	rec record<span class="token punctuation">;</span>
	<span class="token comment">-- dynamic query</span>
    query <span class="token keyword">text</span><span class="token punctuation">;</span>
<span class="token keyword">begin</span>
		
	query :<span class="token operator">=</span> <span class="token string">'select title, release_year from film '</span><span class="token punctuation">;</span>
	
	<span class="token keyword">if</span> sort_type <span class="token operator">=</span> <span class="token number">1</span> <span class="token keyword">then</span>
		query :<span class="token operator">=</span> query <span class="token operator">||</span> <span class="token string">'order by title'</span><span class="token punctuation">;</span>
	elsif sort_type <span class="token operator">=</span> <span class="token number">2</span> <span class="token keyword">then</span>
	  query :<span class="token operator">=</span> query <span class="token operator">||</span> <span class="token string">'order by release_year'</span><span class="token punctuation">;</span>
	<span class="token keyword">else</span> 
	   raise <span class="token string">'invalid sort type %s'</span><span class="token punctuation">,</span> sort_type<span class="token punctuation">;</span>
	<span class="token keyword">end</span> <span class="token keyword">if</span><span class="token punctuation">;</span>

	query :<span class="token operator">=</span> query <span class="token operator">||</span> <span class="token string">' limit $1'</span><span class="token punctuation">;</span>

	<span class="token keyword">for</span> rec <span class="token operator">in</span> <span class="token keyword">execute</span> query <span class="token keyword">using</span> rec_count
        <span class="token keyword">loop</span>
	     raise notice <span class="token string">'% - %'</span><span class="token punctuation">,</span> rec<span class="token punctuation">.</span>release_year<span class="token punctuation">,</span> rec<span class="token punctuation">.</span>title<span class="token punctuation">;</span>
	<span class="token keyword">end</span> <span class="token keyword">loop</span><span class="token punctuation">;</span>
<span class="token keyword">end</span><span class="token punctuation">;</span>
$$
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>NOTICE:  2006 - Academy Dinosaur
NOTICE:  2006 - Ace Goldfinger
NOTICE:  2006 - Adaptation Holes
NOTICE:  2006 - Affair Prejudice
NOTICE:  2006 - African Egg
NOTICE:  2006 - Agent Truman
NOTICE:  2006 - Airplane Sierra
NOTICE:  2006 - Airport Pollock
NOTICE:  2006 - Alabama Devil
NOTICE:  2006 - Aladdin Calendar
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="_6-exit" tabindex="-1"><a class="header-anchor" href="#_6-exit" aria-hidden="true">#</a> [6]exit</h3>
<p>è¯¥<code>exit</code>è¯­å¥å…è®¸æ‚¨ç»ˆæ­¢å¾ªç¯ï¼ŒåŒ…æ‹¬æ— loopå¾ªç¯ã€while å¾ªç¯å’Œfor å¾ªç¯</p>
<p>è¯­æ³•ï¼š</p>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>exit [label] [when boolean_expression]
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><blockquote>
<p>å¦‚æœä¸ä½¿ç”¨æ ‡ç­¾ï¼Œ<code>exit</code>è¯­å¥å°†ç»ˆæ­¢å½“å‰å¾ªç¯</p>
</blockquote>
<p>ä»¥ä¸‹è¯­å¥æ˜¯ç­‰æ•ˆçš„ï¼š</p>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>exit when counter > 10;
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>if counter > 10 then
   exit;
end if;
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><code>exit when</code>ç»å¯¹æ›´å¹²å‡€ï¼Œæ›´çŸ­</p>
<p><strong>ç¤ºä¾‹ï¼š</strong></p>
<h4 id="_1-ä½¿ç”¨-pl-pgsql-exit-è¯­å¥ç»ˆæ­¢loop" tabindex="-1"><a class="header-anchor" href="#_1-ä½¿ç”¨-pl-pgsql-exit-è¯­å¥ç»ˆæ­¢loop" aria-hidden="true">#</a> 1) ä½¿ç”¨ PL/pgSQL Exit è¯­å¥ç»ˆæ­¢loop</h4>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token keyword">do</span>
$$
<span class="token keyword">declare</span> 
   i <span class="token keyword">int</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
   j <span class="token keyword">int</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">begin</span>
  <span class="token operator">&lt;&lt;</span>outer_loop<span class="token operator">>></span>
  <span class="token keyword">loop</span> 
     i <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
     <span class="token keyword">exit</span> <span class="token keyword">when</span> i <span class="token operator">></span> <span class="token number">3</span><span class="token punctuation">;</span>
	 <span class="token comment">-- inner loop</span>
	 j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
     <span class="token operator">&lt;&lt;</span>inner_loop<span class="token operator">>></span>
     <span class="token keyword">loop</span> 
		j <span class="token operator">=</span> j <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token keyword">exit</span> <span class="token keyword">when</span> j <span class="token operator">></span> <span class="token number">3</span><span class="token punctuation">;</span>
		raise notice <span class="token string">'(i,j): (%,%)'</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> j<span class="token punctuation">;</span>
	 <span class="token keyword">end</span> <span class="token keyword">loop</span> inner_loop<span class="token punctuation">;</span>
  <span class="token keyword">end</span> <span class="token keyword">loop</span> outer_loop<span class="token punctuation">;</span>
<span class="token keyword">end</span><span class="token punctuation">;</span>
$$
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>NOTICE:  (i,j): (1,1)
NOTICE:  (i,j): (1,2)
NOTICE:  (i,j): (1,3)
NOTICE:  (i,j): (2,1)
NOTICE:  (i,j): (2,2)
NOTICE:  (i,j): (2,3)
NOTICE:  (i,j): (3,1)
NOTICE:  (i,j): (3,2)
NOTICE:  (i,j): (3,3)
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h4 id="_2-ä½¿ç”¨-pl-pgsql-exit-è¯­å¥é€€å‡ºä¸€ä¸ªå—" tabindex="-1"><a class="header-anchor" href="#_2-ä½¿ç”¨-pl-pgsql-exit-è¯­å¥é€€å‡ºä¸€ä¸ªå—" aria-hidden="true">#</a> 2) ä½¿ç”¨ PL/pgSQL Exit è¯­å¥é€€å‡ºä¸€ä¸ªå—</h4>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token keyword">do</span>
$$
<span class="token keyword">begin</span>
  
  <span class="token operator">&lt;&lt;</span>simple_block<span class="token operator">>></span>  
   <span class="token keyword">begin</span>
  	 <span class="token keyword">exit</span> simple_block<span class="token punctuation">;</span>
         <span class="token comment">-- for demo purposes</span>
	 raise notice <span class="token string">'%'</span><span class="token punctuation">,</span> <span class="token string">'unreachable!'</span><span class="token punctuation">;</span>
   <span class="token keyword">end</span><span class="token punctuation">;</span>
   raise notice <span class="token string">'%'</span><span class="token punctuation">,</span> <span class="token string">'End of block'</span><span class="token punctuation">;</span>
<span class="token keyword">end</span><span class="token punctuation">;</span>
$$
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>NOTICE:  End of block
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><h3 id="_7-continue" tabindex="-1"><a class="header-anchor" href="#_7-continue" aria-hidden="true">#</a> [7]continue</h3>
<p><code>continue</code>è¯­å¥è·³è¿‡æŸæ¬¡å¾ªç¯çš„å½“å‰è¿­ä»£å¹¶è·³è½¬åˆ°ä¸‹ä¸€ä¸ªè¿­ä»£</p>
<p>è¯¥<code>continue</code>è¯­å¥å¯ç”¨äºå„ç§å¾ªç¯ï¼ŒåŒ…æ‹¬æ— æ¡ä»¶å¾ªç¯ã€while å¾ªç¯)å’Œfor å¾ªç¯</p>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>continue [loop_label] [when condition]
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><blockquote>
<p><code>loop_label</code>å’Œ<code>when condition</code>æ˜¯å¯é€‰çš„</p>
</blockquote>
<p>ç¤ºä¾‹ï¼š</p>
<p>ä»¥ä¸‹ç¤ºä¾‹ä½¿ç”¨<code>continue</code>æ— æ¡ä»¶å¾ªç¯ä¸­çš„è¯­å¥æ‰“å°å‡º 1 åˆ° 10 çš„å¥‡æ•°ï¼š</p>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token keyword">do</span>
$$
<span class="token keyword">declare</span>
   counter <span class="token keyword">int</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">begin</span>
  <span class="token keyword">loop</span>
     counter <span class="token operator">=</span> counter <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
	 <span class="token comment">-- exit the loop if counter > 10</span>
	 <span class="token keyword">exit</span> <span class="token keyword">when</span> counter <span class="token operator">></span> <span class="token number">10</span><span class="token punctuation">;</span>
	 <span class="token comment">-- skip the current iteration if counter is an even number</span>
	 <span class="token keyword">continue</span> <span class="token keyword">when</span> <span class="token function">mod</span><span class="token punctuation">(</span>counter<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	 <span class="token comment">-- print out the counter</span>
	 raise notice <span class="token string">'%'</span><span class="token punctuation">,</span> counter<span class="token punctuation">;</span>
  <span class="token keyword">end</span> <span class="token keyword">loop</span><span class="token punctuation">;</span>
<span class="token keyword">end</span><span class="token punctuation">;</span>
$$
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>è¾“å‡ºï¼š</p>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>NOTICE:  1
NOTICE:  3
NOTICE:  5
NOTICE:  7
NOTICE:  9
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h2 id="_7-ç”¨æˆ·è‡ªå®šä¹‰å‡½æ•°" tabindex="-1"><a class="header-anchor" href="#_7-ç”¨æˆ·è‡ªå®šä¹‰å‡½æ•°" aria-hidden="true">#</a> 7.ç”¨æˆ·è‡ªå®šä¹‰å‡½æ•°</h2>
<h3 id="_1-åˆ›å»ºå‡½æ•°" tabindex="-1"><a class="header-anchor" href="#_1-åˆ›å»ºå‡½æ•°" aria-hidden="true">#</a> [1]åˆ›å»ºå‡½æ•°</h3>
<p>ç”¨æˆ·å¯ä»¥ä½¿ç”¨create functionå®šä¹‰ä¸€ä¸ªæ–°çš„å‡½æ•°</p>
<p><strong>è¯­æ³•ï¼š</strong></p>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token keyword">create</span> <span class="token punctuation">[</span><span class="token operator">or</span> <span class="token keyword">replace</span><span class="token punctuation">]</span> <span class="token keyword">function</span> function_name<span class="token punctuation">(</span>param_list<span class="token punctuation">)</span>
   <span class="token keyword">returns</span> return_type 
   <span class="token keyword">language</span> plpgsql
  <span class="token keyword">as</span>
$$
<span class="token keyword">declare</span> 
<span class="token comment">-- variable declaration</span>
<span class="token keyword">begin</span>
 <span class="token comment">-- logic</span>
<span class="token keyword">end</span><span class="token punctuation">;</span>
$$
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><blockquote>
<ul>
<li>ä½¿ç”¨<code>language plpgsql</code>æŒ‡å®šå‡½æ•°çš„è¿‡ç¨‹è¯­è¨€ã€‚è¯·æ³¨æ„ï¼ŒPostgreSQL æ”¯æŒè®¸å¤šè¿‡ç¨‹è¯­è¨€ï¼Œè€Œä¸ä»…ä»…æ˜¯<code>plpgsql</code></li>
<li>æœ€åä½¿ç”¨$$åœ¨å‡½æ•°åé¢å®šä¹‰ä¸€ä¸ªå—</li>
</ul>
</blockquote>
<p><strong>ç¤ºä¾‹ï¼š</strong></p>
<p>åˆ›å»ºäº†ä¸€ä¸ªå‡½æ•°æ¥è®¡ç®—é•¿åº¦åœ¨<code>len_from</code>å’Œ<code>len_to</code>å‚æ•°ä¹‹é—´çš„ç”µå½±</p>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token keyword">create</span> <span class="token keyword">function</span> get_film_count<span class="token punctuation">(</span>len_from <span class="token keyword">int</span><span class="token punctuation">,</span> len_to <span class="token keyword">int</span><span class="token punctuation">)</span>
<span class="token keyword">returns</span> <span class="token keyword">int</span>
<span class="token keyword">language</span> plpgsql
<span class="token keyword">as</span>
$$
<span class="token keyword">declare</span>
   film_count <span class="token keyword">integer</span><span class="token punctuation">;</span>
<span class="token keyword">begin</span>
   <span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> 
   <span class="token keyword">into</span> film_count
   <span class="token keyword">from</span> film
   <span class="token keyword">where</span> length <span class="token operator">between</span> len_from <span class="token operator">and</span> len_to<span class="token punctuation">;</span>
   
   <span class="token keyword">return</span> film_count<span class="token punctuation">;</span>
<span class="token keyword">end</span><span class="token punctuation">;</span>
$$<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><blockquote>
<ul>
<li>
<p>è¯¥å‡½æ•°<code>get_film_count</code>æœ‰ä¸¤ä¸ªä¸»è¦éƒ¨åˆ†ï¼šæ ‡é¢˜å’Œæ­£æ–‡</p>
</li>
<li>
<p>åœ¨å—çš„æœ«å°¾ï¼Œä½¿ç”¨<code>return</code>è¯­å¥è¿”å›<code>film_count</code>ç»™å‡½æ•°
<img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/73f1aa6044d3481094f5647f09f36a9d~tplv-k3u1fbpfcp-zoom-1.image" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
</li>
</ul>
</blockquote>
<p>è°ƒç”¨ç”¨æˆ·è‡ªå®šä¹‰å‡½æ•°ï¼š</p>
<p>PostgreSQL ä¸ºæ‚¨æä¾›äº†ä¸‰ç§è°ƒç”¨ç”¨æˆ·å®šä¹‰å‡½æ•°çš„æ–¹æ³•ï¼š</p>
<ul>
<li>ä½¿ç”¨ä½ç½®ç¬¦å·</li>
<li>ä½¿ç”¨å‘½åç¬¦å·</li>
<li>ä½¿ç”¨æ··åˆç¬¦å·ã€‚</li>
</ul>
<p><strong>1) ä½¿ç”¨ä½ç½®ç¬¦å·</strong></p>
<p>è¦ä½¿ç”¨ä½ç½®ç¬¦å·è°ƒç”¨å‡½æ•°ï¼Œæ‚¨éœ€è¦ä»¥ä¸å‚æ•°ç›¸åŒçš„é¡ºåºæŒ‡å®šå‚æ•°ã€‚ä¾‹å¦‚ï¼š</p>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token keyword">select</span> get_film_count<span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">,</span><span class="token number">90</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>è¾“å‡ºï¼š</p>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code> get_film_count
----------------
            325
(1 row)
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><strong>2) ä½¿ç”¨å‘½åç¬¦å·</strong></p>
<p>ä¸‹é¢æ˜¾ç¤ºäº†å¦‚ä½•<code>get_film_count</code>ä½¿ç”¨ä½ç½®è¡¨ç¤ºæ³•è°ƒç”¨å‡½æ•°ï¼š</p>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token keyword">select</span> get_film_count<span class="token punctuation">(</span>
    len_from <span class="token operator">=</span><span class="token operator">></span> <span class="token number">40</span><span class="token punctuation">,</span> 
     len_to <span class="token operator">=</span><span class="token operator">></span> <span class="token number">90</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>è¾“å‡ºï¼š</p>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code> get_film_count
----------------
            325
(1 row)
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>åœ¨å‘½åç¬¦å·ä¸­ï¼Œæ‚¨ä½¿ç”¨<code>=&gt;</code>åˆ†éš”å‚æ•°çš„åç§°å’Œå®ƒçš„å€¼ã€‚</p>
<p>ä¸ºäº†å‘åå…¼å®¹ï¼ŒPostgreSQL æ”¯æŒåŸºäº<code>:=</code>ä»¥ä¸‹çš„æ—§è¯­æ³•ï¼š</p>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token keyword">select</span> get_film_count<span class="token punctuation">(</span>
    len_from :<span class="token operator">=</span> <span class="token number">40</span><span class="token punctuation">,</span> 
    len_to :<span class="token operator">=</span> <span class="token number">90</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><strong>3) ä½¿ç”¨æ··åˆç¬¦å·</strong></p>
<p>æ··åˆç¬¦å·æ˜¯ä½ç½®ç¬¦å·å’Œå‘½åç¬¦å·çš„ç»„åˆã€‚ä¾‹å¦‚ï¼š</p>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token keyword">select</span> get_film_count<span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">,</span> len_to <span class="token operator">=</span><span class="token operator">></span> <span class="token number">90</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>è¯·æ³¨æ„ï¼Œæ‚¨ä¸èƒ½åœ¨ä½ç½®å‚æ•°ä¹‹å‰ä½¿ç”¨å‘½åå‚æ•°ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token keyword">select</span> get_film_count<span class="token punctuation">(</span>len_from <span class="token operator">=</span><span class="token operator">></span> <span class="token number">40</span><span class="token punctuation">,</span> <span class="token number">90</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>é”™è¯¯ï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>ERROR:  positional argument cannot follow named argument
LINE <span class="token number">1</span>: <span class="token keyword">select</span> get_film_count<span class="token punctuation">(</span>len_from <span class="token operator">=</span><span class="token operator">></span> <span class="token number">40</span>, <span class="token number">90</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="_2-å‡½æ•°å‚æ•°æ¨¡å¼" tabindex="-1"><a class="header-anchor" href="#_2-å‡½æ•°å‚æ•°æ¨¡å¼" aria-hidden="true">#</a> [2]å‡½æ•°å‚æ•°æ¨¡å¼</h3>
<p>å‚æ•°æ¨¡å¼å†³å®šäº†å‚æ•°çš„è¡Œä¸ºã€‚PL/pgSQL æ”¯æŒä¸‰ç§å‚æ•°æ¨¡å¼ï¼š<code>in</code>ã€<code>out</code>å’Œ<code>inout</code>. å¦‚æœæ‚¨æœªæ˜ç¡®æŒ‡å®šå‚æ•°ï¼Œåˆ™é»˜è®¤æƒ…å†µä¸‹é‡‡ç”¨<code>in</code>æ¨¡å¼</p>
<table>
<thead>
<tr>
<th style="text-align:left">in</th>
<th style="text-align:left">out</th>
<th style="text-align:left">inout</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">é»˜è®¤</td>
<td style="text-align:left">æ˜ç¡®æŒ‡å®š</td>
<td style="text-align:left">æ˜ç¡®æŒ‡å®š</td>
</tr>
<tr>
<td style="text-align:left">å°†å€¼ä¼ é€’ç»™å‡½æ•°</td>
<td style="text-align:left">ä»å‡½æ•°è¿”å›ä¸€ä¸ªå€¼</td>
<td style="text-align:left">å°†å€¼ä¼ é€’ç»™å‡½æ•°å¹¶è¿”å›æ›´æ–°çš„å€¼ã€‚</td>
</tr>
<tr>
<td style="text-align:left"><code>in</code>å‚æ•°çš„ä½œç”¨ç±»ä¼¼äºå¸¸é‡</td>
<td style="text-align:left"><code>out</code>å‚æ•°å°±åƒæœªåˆå§‹åŒ–çš„å˜é‡</td>
<td style="text-align:left"><code>inout</code>å‚æ•°å°±åƒä¸€ä¸ªåˆå§‹åŒ–çš„å˜é‡</td>
</tr>
<tr>
<td style="text-align:left">æ— æ³•èµ‹å€¼</td>
<td style="text-align:left">å¿…é¡»èµ‹å€¼</td>
<td style="text-align:left">åº”è¯¥èµ‹å€¼</td>
</tr>
</tbody>
</table>
<h4 id="_1-inæ¨¡å¼" tabindex="-1"><a class="header-anchor" href="#_1-inæ¨¡å¼" aria-hidden="true">#</a> 1ï¼‰inæ¨¡å¼</h4>
<p>ç¤ºä¾‹ï¼šä»¥ä¸‹å‡½æ•°é€šè¿‡ id æŸ¥æ‰¾ç”µå½±å¹¶è¿”å›ç”µå½±çš„æ ‡é¢˜ï¼š</p>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token keyword">create</span> <span class="token operator">or</span> <span class="token keyword">replace</span> <span class="token keyword">function</span> find_film_by_id<span class="token punctuation">(</span>p_film_id <span class="token keyword">int</span><span class="token punctuation">)</span>
<span class="token keyword">returns</span> <span class="token keyword">varchar</span>
<span class="token keyword">language</span> plpgsql
<span class="token keyword">as</span> $$
<span class="token keyword">declare</span>
   film_title film<span class="token punctuation">.</span>title<span class="token operator">%</span><span class="token keyword">type</span><span class="token punctuation">;</span>
<span class="token keyword">begin</span>
  <span class="token comment">-- find film title by id</span>
  <span class="token keyword">select</span> title 
  <span class="token keyword">into</span> film_title
  <span class="token keyword">from</span> film
  <span class="token keyword">where</span> film_id <span class="token operator">=</span> p_film_id<span class="token punctuation">;</span>
  
  <span class="token keyword">if</span> <span class="token operator">not</span> found <span class="token keyword">then</span>
     raise <span class="token string">'Film with id % not found'</span><span class="token punctuation">,</span> p_film_id<span class="token punctuation">;</span>
  <span class="token keyword">end</span> <span class="token keyword">if</span><span class="token punctuation">;</span>
  
  <span class="token keyword">return</span> title<span class="token punctuation">;</span>
  
<span class="token keyword">end</span><span class="token punctuation">;</span>$$
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><blockquote>
<p>å› ä¸ºæˆ‘ä»¬æ²¡æœ‰æŒ‡å®š<code>p_film_id</code>å‚æ•°çš„æ¨¡å¼ï¼Œæ‰€ä»¥å®ƒ<code>in</code>é»˜è®¤é‡‡ç”¨æ¨¡å¼ã€‚</p>
</blockquote>
<h4 id="_2-outæ¨¡å¼" tabindex="-1"><a class="header-anchor" href="#_2-outæ¨¡å¼" aria-hidden="true">#</a> 2ï¼‰outæ¨¡å¼</h4>
<p>å°†å‚æ•°ä½œä¸ºè¾“å‡º</p>
<p><code>out</code>å‚æ•°åœ¨éœ€è¦è¿”å›å¤šä¸ªå€¼çš„å‡½æ•°ä¸­éå¸¸æœ‰ç”¨ã€‚</p>
<p>ç¤ºä¾‹ï¼šï¼ˆå®šä¹‰äº†<code>get_film_stat</code>å…·æœ‰ä¸‰ä¸ª<code>out</code>å‚æ•°çš„å‡½æ•°ï¼‰</p>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token keyword">create</span> <span class="token operator">or</span> <span class="token keyword">replace</span> <span class="token keyword">function</span> get_film_stat<span class="token punctuation">(</span>
    <span class="token keyword">out</span> min_len <span class="token keyword">int</span><span class="token punctuation">,</span>
    <span class="token keyword">out</span> max_len <span class="token keyword">int</span><span class="token punctuation">,</span>
    <span class="token keyword">out</span> avg_len <span class="token keyword">numeric</span><span class="token punctuation">)</span> 
<span class="token keyword">language</span> plpgsql
<span class="token keyword">as</span> $$
<span class="token keyword">begin</span>  
  <span class="token keyword">select</span> <span class="token function">min</span><span class="token punctuation">(</span>length<span class="token punctuation">)</span><span class="token punctuation">,</span>
         <span class="token function">max</span><span class="token punctuation">(</span>length<span class="token punctuation">)</span><span class="token punctuation">,</span>
		 <span class="token function">avg</span><span class="token punctuation">(</span>length<span class="token punctuation">)</span>::<span class="token keyword">numeric</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token keyword">into</span> min_len<span class="token punctuation">,</span> max_len<span class="token punctuation">,</span> avg_len
  <span class="token keyword">from</span> film<span class="token punctuation">;</span>

<span class="token keyword">end</span><span class="token punctuation">;</span>$$
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token keyword">select</span> get_film_stat<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/90cb8882af64492bbd5333ff6bba8868~tplv-k3u1fbpfcp-zoom-1.image" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p>è¯¥å‡½æ•°çš„è¾“å‡ºæ˜¯ä¸€æ¡è®°å½•ã€‚è¦å°†è¾“å‡ºåˆ†éš”ä¸ºåˆ—ï¼Œè¯·ä½¿ç”¨ä»¥ä¸‹è¯­å¥ï¼š</p>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> get_film_stat<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/cb5649b4668d44f49820ee87008f602c~tplv-k3u1fbpfcp-zoom-1.image" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<h4 id="_3-inoutæ¨¡å¼" tabindex="-1"><a class="header-anchor" href="#_3-inoutæ¨¡å¼" aria-hidden="true">#</a> 3ï¼‰inoutæ¨¡å¼</h4>
<p><code>inout</code>æ¨¡å¼æ˜¯ç»„åˆ<code>in</code>å’Œ<code>out</code>æ¨¡å¼ã€‚</p>
<p>è¿™æ„å‘³ç€è°ƒç”¨è€…å¯ä»¥å°†å‚æ•°ä¼ é€’ç»™å‡½æ•°ã€‚è¯¥å‡½æ•°æ›´æ”¹å‚æ•°å¹¶è¿”å›æ›´æ–°åçš„å€¼ã€‚</p>
<p>ä»¥ä¸‹<code>swap</code>å‡½æ•°æ¥å—ä¸¤ä¸ªæ•´æ•°åŠå…¶å€¼ï¼š</p>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token keyword">create</span> <span class="token operator">or</span> <span class="token keyword">replace</span> <span class="token keyword">function</span> swap<span class="token punctuation">(</span>
	<span class="token keyword">inout</span> x <span class="token keyword">int</span><span class="token punctuation">,</span>
	<span class="token keyword">inout</span> y <span class="token keyword">int</span>
<span class="token punctuation">)</span> 
<span class="token keyword">language</span> plpgsql	
<span class="token keyword">as</span> $$
<span class="token keyword">begin</span>
   <span class="token keyword">select</span> x<span class="token punctuation">,</span>y <span class="token keyword">into</span> y<span class="token punctuation">,</span>x<span class="token punctuation">;</span>
<span class="token keyword">end</span><span class="token punctuation">;</span> $$<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>è°ƒç”¨å‡½æ•°ï¼š</p>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> swap<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6eae78ecdbcf4f77826479f7e5dd5d91~tplv-k3u1fbpfcp-zoom-1.image" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<h3 id="_3-å‡½æ•°é‡è½½" tabindex="-1"><a class="header-anchor" href="#_3-å‡½æ•°é‡è½½" aria-hidden="true">#</a> [3]å‡½æ•°é‡è½½</h3>
<p>PostgreSQL å…è®¸å¤šä¸ªå‡½æ•°å…±äº«ç›¸åŒçš„åç§°ï¼Œåªè¦å®ƒä»¬å…·æœ‰ä¸åŒçš„å‚æ•°</p>
<p>å¦‚æœä¸¤ä¸ªæˆ–å¤šä¸ªå‡½æ•°å…±äº«ç›¸åŒçš„åç§°ï¼Œåˆ™å‡½æ•°åç§°å°†è¢«é‡è½½</p>
<p>å½“æ‚¨å¯ä»¥è°ƒç”¨é‡è½½å‡½æ•°æ—¶ï¼ŒPostgreSQL ä¼šæ ¹æ®å‡½æ•°å‚æ•°åˆ—è¡¨é€‰æ‹©æœ€ä½³å€™é€‰å‡½æ•°æ¥æ‰§è¡Œã€‚</p>
<p>ä»¥ä¸‹<code>get_rental_duration()</code>å‡½æ•°è¿”å›æŒ‡å®šå®¢æˆ·çš„æ€»ç§Ÿèµå¤©æ•°ï¼š</p>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token keyword">create</span> <span class="token operator">or</span> <span class="token keyword">replace</span> <span class="token keyword">function</span> get_rental_duration<span class="token punctuation">(</span>
	p_customer_id <span class="token keyword">integer</span>
<span class="token punctuation">)</span>
<span class="token keyword">returns</span> <span class="token keyword">integer</span> 
<span class="token keyword">language</span> plpgsql
<span class="token keyword">as</span> $$
<span class="token keyword">declare</span> 
	rental_duration <span class="token keyword">integer</span><span class="token punctuation">;</span> 
<span class="token keyword">begin</span>
	<span class="token keyword">select</span> 
		<span class="token function">sum</span><span class="token punctuation">(</span> extract<span class="token punctuation">(</span><span class="token keyword">day</span> <span class="token keyword">from</span> return_date <span class="token operator">-</span> rental_date<span class="token punctuation">)</span><span class="token punctuation">)</span> 
	<span class="token keyword">into</span> rental_duration 
    <span class="token keyword">from</span> rental 
	<span class="token keyword">where</span> customer_id <span class="token operator">=</span> p_customer_id<span class="token punctuation">;</span>

	<span class="token keyword">return</span> rental_duration<span class="token punctuation">;</span>
<span class="token keyword">end</span><span class="token punctuation">;</span> $$
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>è¯¥<code>get_rental_function</code>å‡½æ•°å…·æœ‰<code>p_customer_id</code>ä½œä¸º<code>in</code>å‚æ•°ã€‚</p>
<p>ä»¥ä¸‹è¿”å›å®¢æˆ· id 232 çš„ç§Ÿèµå¤©æ•°ï¼š</p>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>SELECT get_rental_duration(232);
 get_rental_duration
---------------------
                  90
(1 row)
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>å‡è®¾æ‚¨æƒ³äº†è§£å®¢æˆ·ä»ç‰¹å®šæ—¥æœŸåˆ°ç°åœ¨çš„ç§ŸèµæœŸé™ã€‚</p>
<p>ä¸ºæ­¤ï¼Œæ‚¨å¯ä»¥<code>p_from_date</code>åœ¨<code>get_retal_duration()</code>å‡½æ•°ä¸­å†æ·»åŠ ä¸€ä¸ªå‚æ•°ã€‚æˆ–è€…æ‚¨å¯ä»¥å¼€å‘ä¸€ä¸ªå…·æœ‰ç›¸åŒåç§°ä½†æœ‰ä¸¤ä¸ªå‚æ•°çš„æ–°å‡½æ•°ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token keyword">create</span> <span class="token operator">or</span> <span class="token keyword">replace</span> <span class="token keyword">function</span> get_rental_duration<span class="token punctuation">(</span>
	p_customer_id <span class="token keyword">integer</span><span class="token punctuation">,</span> 
	p_from_date <span class="token keyword">date</span>
<span class="token punctuation">)</span>
<span class="token keyword">returns</span> <span class="token keyword">integer</span> 
<span class="token keyword">language</span> plpgsql
<span class="token keyword">as</span> $$
<span class="token keyword">declare</span> 
	rental_duration <span class="token keyword">integer</span><span class="token punctuation">;</span>
<span class="token keyword">begin</span>
	<span class="token comment">-- get the rental duration based on customer_id </span>
	<span class="token comment">-- and rental date</span>
	<span class="token keyword">select</span> <span class="token function">sum</span><span class="token punctuation">(</span> extract<span class="token punctuation">(</span> <span class="token keyword">day</span> <span class="token keyword">from</span> return_date <span class="token operator">+</span> <span class="token string">'12:00:00'</span> <span class="token operator">-</span> rental_date<span class="token punctuation">)</span><span class="token punctuation">)</span> 
	<span class="token keyword">into</span> rental_duration
	<span class="token keyword">from</span> rental 
	<span class="token keyword">where</span> customer_id <span class="token operator">=</span> p_customer_id <span class="token operator">and</span> 
		  rental_date <span class="token operator">>=</span> p_from_date<span class="token punctuation">;</span>
	
	<span class="token comment">-- return the rental duration in days</span>
	<span class="token keyword">return</span> rental_duration<span class="token punctuation">;</span>
<span class="token keyword">end</span><span class="token punctuation">;</span> $$

</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>æ­¤å‡½æ•°ä¸ç¬¬ä¸€ä¸ªå‡½æ•°åŒåï¼Œåªæ˜¯å®ƒæœ‰ä¸¤ä¸ªå‚æ•°ã€‚</p>
<p>æ¢å¥è¯è¯´ï¼Œ<code>get_rental_duration(integer)</code> å‡½æ•°è¢«å‡½æ•°é‡è½½äº†<code>get_rental_duration(integer,date)</code>ã€‚</p>
<p>ä»¥ä¸‹è¯­å¥è¿”å›å®¢æˆ· ID çš„ç§Ÿç”¨æœŸé™ï¼Œ<code>232</code>å› ä¸º<code>July 1st 2005</code>ï¼š</p>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>SELECT get_rental_duration(232,'2005-07-01');ä»£ç è¯­è¨€ï¼š SQLï¼ˆç»“æ„åŒ–æŸ¥è¯¢è¯­è¨€ï¼‰ ï¼ˆsql ï¼‰
 get_rental_duration
---------------------
                  85
(1 row)
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>è¯·æ³¨æ„ï¼Œå¦‚æœæ‚¨çœç•¥ç¬¬äºŒä¸ªå‚æ•°ï¼ŒPostgreSQL å°†è°ƒç”¨<code>get_rental_duration(integer)</code>å…·æœ‰ä¸€ä¸ªå‚æ•°çš„å‡½æ•°ã€‚</p>
<h4 id="å‡½æ•°é‡è½½å’Œé»˜è®¤å€¼" tabindex="-1"><a class="header-anchor" href="#å‡½æ•°é‡è½½å’Œé»˜è®¤å€¼" aria-hidden="true">#</a> å‡½æ•°é‡è½½å’Œé»˜è®¤å€¼</h4>
<p>åœ¨<code>get_rental_duration(integer,date)</code>å‡½æ•°ä¸­ï¼Œå¦‚æœè¦ä¸ºç¬¬äºŒä¸ªå‚æ•°è®¾ç½®é»˜è®¤å€¼ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token keyword">create</span> <span class="token operator">or</span> <span class="token keyword">replace</span> <span class="token keyword">function</span> get_rental_duration<span class="token punctuation">(</span>
	p_customer_id <span class="token keyword">integer</span><span class="token punctuation">,</span> 
	p_from_date <span class="token keyword">date</span> <span class="token keyword">default</span> <span class="token string">'2005-01-01'</span>
<span class="token punctuation">)</span>
<span class="token keyword">returns</span> <span class="token keyword">integer</span>
<span class="token keyword">language</span> plpgsql
<span class="token keyword">as</span> $$
<span class="token keyword">declare</span> 
	rental_duration <span class="token keyword">integer</span><span class="token punctuation">;</span>
<span class="token keyword">begin</span>
	<span class="token keyword">select</span> <span class="token function">sum</span><span class="token punctuation">(</span> 
		extract<span class="token punctuation">(</span> <span class="token keyword">day</span> <span class="token keyword">from</span> return_date <span class="token operator">+</span> <span class="token string">'12:00:00'</span> <span class="token operator">-</span> rental_date<span class="token punctuation">)</span>
	<span class="token punctuation">)</span> 
	<span class="token keyword">into</span> rental_duration
	<span class="token keyword">from</span> rental 
	<span class="token keyword">where</span> customer_id<span class="token operator">=</span> p_customer_id <span class="token operator">and</span> 
		  rental_date <span class="token operator">>=</span> p_from_date<span class="token punctuation">;</span>
	 
	<span class="token keyword">return</span> rental_duration<span class="token punctuation">;</span>

<span class="token keyword">end</span><span class="token punctuation">;</span> $$ä»£ç è¯­è¨€ï¼š <span class="token keyword">SQL</span>ï¼ˆç»“æ„åŒ–æŸ¥è¯¢è¯­è¨€ï¼‰ ï¼ˆ<span class="token keyword">sql</span> ï¼‰
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>ä»¥ä¸‹è°ƒç”¨è¯¥<code>get_rental_duration()</code>å‡½æ•°å¹¶ä¼ é€’å®¢æˆ· ID 232ï¼š</p>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token keyword">SELECT</span> get_rental_duration<span class="token punctuation">(</span><span class="token number">232</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>PostgreSQL å‘å‡ºé”™è¯¯ï¼š</p>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>ERROR:  function get_rental_duration(integer) is not unique
LINE 1: SELECT get_rental_duration(232);
               ^
HINT:  Could not choose the best candidate function. You might need to add explicit type casts.
SQL state: 42725
Character: 
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒPostgreSQL æ— æ³•é€‰æ‹©æœ€ä½³å€™é€‰å‡½æ•°æ¥æ‰§è¡Œ</p>
<p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ‚¨å…·æœ‰ä¸‰ä¸ªåŠŸèƒ½ï¼š</p>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>get_rental_duration(p_customer_id integer);
get_rental_duration(p_customer_id integer, p_from_date date)
get_rental_duration(p_customer_id integer, p_from_date date default '2005-01-01'
)
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>PostgreSQL ä¸çŸ¥é“åº”è¯¥æ‰§è¡Œç¬¬ä¸€ä¸ªå‡½æ•°è¿˜æ˜¯ç¬¬ä¸‰ä¸ªå‡½æ•°</p>
<p>æ‰€ä»¥ï¼šå½“ä½ é‡è½½ä¸€ä¸ªå‡½æ•°æ—¶ï¼Œä½ åº”è¯¥æ€»æ˜¯è®©å®ƒä»¬çš„å‚æ•°åˆ—è¡¨æ˜¯å”¯ä¸€çš„</p>
<h3 id="_4-è¿”å›è¡¨çš„å‡½æ•°" tabindex="-1"><a class="header-anchor" href="#_4-è¿”å›è¡¨çš„å‡½æ•°" aria-hidden="true">#</a> [4]è¿”å›è¡¨çš„å‡½æ•°</h3>
<p>è¦å®šä¹‰è¿”å›è¡¨çš„å‡½æ•°ï¼Œè¯·ä½¿ç”¨ä»¥ä¸‹å½¢å¼çš„create functionè¯­å¥ï¼š</p>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token keyword">create</span> <span class="token operator">or</span> <span class="token keyword">replace</span> <span class="token keyword">function</span> function_name <span class="token punctuation">(</span>
   parameter_list
<span class="token punctuation">)</span> 
<span class="token keyword">returns</span> <span class="token keyword">table</span> <span class="token punctuation">(</span> column_list <span class="token punctuation">)</span> 
<span class="token keyword">language</span> plpgsql
<span class="token keyword">as</span> $$
<span class="token keyword">declare</span> 
<span class="token comment">-- variable declaration</span>
<span class="token keyword">begin</span>
<span class="token comment">-- body</span>
<span class="token keyword">end</span><span class="token punctuation">;</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>æ­¤è¯­æ³•å…è®¸æ‚¨è¿”å›å…·æœ‰æŒ‡å®šåˆ—åˆ—è¡¨çš„è¡¨ï¼Œè€Œä¸æ˜¯è¿”å›å•ä¸ªå€¼ï¼š</p>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>returns table ( column_list )
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>ä½¿ç”¨<code>film</code>è¡¨è¿›è¡Œæ¼”ç¤ºï¼šï¼ˆä½¿ç”¨äº†ILIKE è¿ç®—ç¬¦è¿”å›å…¶æ ‡é¢˜ä¸ç‰¹å®šæ¨¡å¼åŒ¹é…çš„æ‰€æœ‰ç”µå½±ï¼‰</p>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token keyword">create</span> <span class="token operator">or</span> <span class="token keyword">replace</span> <span class="token keyword">function</span> get_film <span class="token punctuation">(</span>
  p_pattern <span class="token keyword">varchar</span>
<span class="token punctuation">)</span> 
	<span class="token keyword">returns</span> <span class="token keyword">table</span> <span class="token punctuation">(</span>
		film_title <span class="token keyword">varchar</span><span class="token punctuation">,</span>
		film_release_year <span class="token keyword">int</span>
	<span class="token punctuation">)</span> 
	<span class="token keyword">language</span> plpgsql
<span class="token keyword">as</span> $$
<span class="token keyword">begin</span>
	<span class="token keyword">return</span> query 
		<span class="token keyword">select</span>
			title<span class="token punctuation">,</span>
			release_year::<span class="token keyword">integer</span>
		<span class="token keyword">from</span>
			film
		<span class="token keyword">where</span>
			title <span class="token operator">ilike</span> p_pattern<span class="token punctuation">;</span>
<span class="token keyword">end</span><span class="token punctuation">;</span>$$
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><blockquote>
<ul>
<li>
<p>è¿™<code>get_film(varchar)</code>æ¥å—ä¸€ä¸ªå‚æ•°ï¼Œè¯¥å‚æ•°<code>p_pattern</code>æ˜¯æ‚¨æƒ³è¦ä¸ç”µå½±æ ‡é¢˜åŒ¹é…çš„æ¨¡å¼</p>
</li>
<li>
<p>è¯¥å‡½æ•°è¿”å›ä¸€ä¸ªæŸ¥è¯¢ï¼Œè¯¥æŸ¥è¯¢æ˜¯ select è¯­å¥çš„ç»“æœ</p>
</li>
<li>
<p>é›†ä¸­çš„åˆ—çš„æ•°æ®ç±»å‹å¿…é¡»ä¸<code>returns table</code>å­å¥åå®šä¹‰çš„è¡¨ä¸­çš„åˆ—ç›¸åŒ</p>
</li>
</ul>
</blockquote>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> get_film <span class="token punctuation">(</span><span class="token string">'Al%'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/19a92de5c6d140aeb5422ed1db0556da~tplv-k3u1fbpfcp-zoom-1.image" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p>åœ¨å®è·µä¸­ï¼Œæ‚¨é€šå¸¸åœ¨å°†æ¯ä¸€è¡Œé™„åŠ åˆ°å‡½æ•°çš„ç»“æœé›†ä¸­ä¹‹å‰å¯¹å…¶è¿›è¡Œå¤„ç†ï¼š</p>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token keyword">create</span> <span class="token operator">or</span> <span class="token keyword">replace</span> <span class="token keyword">function</span> get_film <span class="token punctuation">(</span>
	p_pattern <span class="token keyword">varchar</span><span class="token punctuation">,</span>
	p_year <span class="token keyword">int</span>
<span class="token punctuation">)</span> 
<span class="token keyword">returns</span> <span class="token keyword">table</span> <span class="token punctuation">(</span>
	film_title <span class="token keyword">varchar</span><span class="token punctuation">,</span>
	film_release_year <span class="token keyword">int</span>
<span class="token punctuation">)</span> 
<span class="token keyword">language</span> plpgsql
<span class="token keyword">as</span> $$
<span class="token keyword">declare</span> 
    var_r record<span class="token punctuation">;</span>
<span class="token keyword">begin</span>
	<span class="token keyword">for</span> var_r <span class="token operator">in</span><span class="token punctuation">(</span>
            <span class="token keyword">select</span> title<span class="token punctuation">,</span> release_year 
            <span class="token keyword">from</span> film 
	     <span class="token keyword">where</span> title <span class="token operator">ilike</span> p_pattern <span class="token operator">and</span> 
		    release_year <span class="token operator">=</span> p_year
        <span class="token punctuation">)</span> <span class="token keyword">loop</span>  film_title :<span class="token operator">=</span> upper<span class="token punctuation">(</span>var_r<span class="token punctuation">.</span>title<span class="token punctuation">)</span> <span class="token punctuation">;</span> 
		film_release_year :<span class="token operator">=</span> var_r<span class="token punctuation">.</span>release_year<span class="token punctuation">;</span>
           <span class="token keyword">return</span> <span class="token keyword">next</span><span class="token punctuation">;</span>
	<span class="token keyword">end</span> <span class="token keyword">loop</span><span class="token punctuation">;</span>
<span class="token keyword">end</span><span class="token punctuation">;</span> $$ 
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†<code>get_film(varchar,int)</code>æ¥å—ä¸¤ä¸ªå‚æ•°çš„ï¼š</p>
<ul>
<li><code>p_pattern</code>ç”¨äºæœç´¢ç”µå½±ã€‚</li>
<li><code>p_year</code> æ˜¯ç”µå½±çš„å‘è¡Œå¹´ä»½ã€‚</li>
</ul>
<p>åœ¨å‡½æ•°ä½“ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨<code>for loop</code>è¯­å¥é€è¡Œå¤„ç†æŸ¥è¯¢ã€‚</p>
<p>è¯¥<code>return next</code>è¯­å¥å°†ä¸€è¡Œæ·»åŠ åˆ°å‡½æ•°çš„è¿”å›è¡¨ä¸­ã€‚</p>
<p>ä¸‹é¢è¯´æ˜å¦‚ä½•è°ƒç”¨è¯¥<code>get_film()</code>å‡½æ•°ï¼š</p>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> get_film <span class="token punctuation">(</span><span class="token string">'%er'</span><span class="token punctuation">,</span> <span class="token number">2006</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8914546500a34deda39dbaf41e84d946~tplv-k3u1fbpfcp-zoom-1.image" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<h3 id="_5-åˆ é™¤å‡½æ•°" tabindex="-1"><a class="header-anchor" href="#_5-åˆ é™¤å‡½æ•°" aria-hidden="true">#</a> [5]åˆ é™¤å‡½æ•°</h3>
<p>åˆ é™¤è¯­æ³•ï¼š</p>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token keyword">drop</span> <span class="token keyword">function</span> <span class="token punctuation">[</span><span class="token keyword">if</span> <span class="token keyword">exists</span><span class="token punctuation">]</span> function_name<span class="token punctuation">(</span>argument_list<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token keyword">cascade</span> <span class="token operator">|</span> <span class="token keyword">restrict</span><span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><blockquote>
<ul>
<li>å½“å‡½æ•°æœ‰ä»»ä½•ä¾èµ–å¯¹è±¡ï¼ˆä¾‹å¦‚æ“ä½œç¬¦æˆ–è§¦å‘å™¨ï¼‰æ—¶ï¼Œä¸èƒ½ç›´æ¥åˆ é™¤è¯¥å‡½æ•°ã€‚</li>
<li>è¦åˆ é™¤å‡½æ•°åŠå…¶ä¾èµ–å¯¹è±¡ï¼Œæ‚¨éœ€è¦æŒ‡å®š<code>cascade</code>é€‰é¡¹ã€‚<code>drop function</code>withé€‰é¡¹å°†<code>cacade</code>é€’å½’åœ°åˆ é™¤å‡½æ•°ã€å®ƒçš„ä¾èµ–å¯¹è±¡ä»¥åŠä¾èµ–äºè¿™äº›å¯¹è±¡çš„å¯¹è±¡ï¼Œä¾æ­¤ç±»æ¨ã€‚</li>
<li>é»˜è®¤æƒ…å†µä¸‹ï¼Œè¯¥<code>drop function</code>è¯­å¥ä½¿ç”¨<code>restrict</code>å½“å‡½æ•°å…·æœ‰ä»»ä½•ä¾èµ–å¯¹è±¡æ—¶æ‹’ç»åˆ é™¤å‡½æ•°çš„é€‰é¡¹ã€‚</li>
</ul>
</blockquote>
<p>è¦ä½¿ç”¨å•ä¸ªè¯­å¥åˆ é™¤å¤šä¸ªå‡½æ•°ï¼Œè¯·åœ¨å…³é”®å­—<code>drop function</code>åæŒ‡å®šä¸€ä¸ªä»¥é€—å·åˆ†éš”çš„å‡½æ•°åç§°åˆ—è¡¨ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š<code>drop function</code></p>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token keyword">drop</span> <span class="token keyword">function</span> <span class="token punctuation">[</span><span class="token keyword">if</span> <span class="token keyword">exists</span><span class="token punctuation">]</span> function1<span class="token punctuation">,</span> function2<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><h2 id="_8-å¼‚å¸¸å¤„ç†" tabindex="-1"><a class="header-anchor" href="#_8-å¼‚å¸¸å¤„ç†" aria-hidden="true">#</a> 8.å¼‚å¸¸å¤„ç†</h2>
<p>å­¦ä¹ å¦‚ä½•åœ¨ PL/pgSQL ä¸­æ•è· PostgreSQL å¼‚å¸¸</p>
<p>å½“å—ä¸­å‘ç”Ÿé”™è¯¯æ—¶ï¼ŒPostgreSQL å°†ä¸­æ­¢å—çš„æ‰§è¡Œä»¥åŠå‘¨å›´çš„äº‹åŠ¡ã€‚</p>
<p>è¦ä»é”™è¯¯ä¸­æ¢å¤ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨å—<code>exception</code>ä¸­çš„å­å¥<code>begin...end</code>ã€‚</p>
<p>ä¸‹é¢è¯´æ˜äº†<code>exception</code>å­å¥çš„è¯­æ³•ï¼š</p>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token operator">&lt;&lt;</span>label<span class="token operator">>></span>
<span class="token keyword">declare</span>
<span class="token keyword">begin</span>
    statements<span class="token punctuation">;</span>
exception
    <span class="token keyword">when</span> condition <span class="token punctuation">[</span><span class="token operator">or</span> condition<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span> <span class="token keyword">then</span>
       handle_exception<span class="token punctuation">;</span>
   <span class="token punctuation">[</span><span class="token keyword">when</span> condition <span class="token punctuation">[</span><span class="token operator">or</span> condition<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span> <span class="token keyword">then</span>
       handle_exception<span class="token punctuation">;</span><span class="token punctuation">]</span>
   <span class="token punctuation">[</span><span class="token keyword">when</span> others <span class="token keyword">then</span>
       handle_other_exceptions<span class="token punctuation">;</span>
   <span class="token punctuation">]</span>
<span class="token keyword">end</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p><strong>ç¤ºä¾‹ï¼š</strong></p>
<h3 id="_1-å¤„ç†-no-data-found-å¼‚å¸¸ç¤ºä¾‹" tabindex="-1"><a class="header-anchor" href="#_1-å¤„ç†-no-data-found-å¼‚å¸¸ç¤ºä¾‹" aria-hidden="true">#</a> [1]å¤„ç† no_data_found å¼‚å¸¸ç¤ºä¾‹</h3>
<p>ä»¥ä¸‹ç¤ºä¾‹å‘å‡ºé”™è¯¯ï¼Œå› ä¸º id ä¸º 2000 çš„ç”µå½±ä¸å­˜åœ¨ã€‚</p>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token keyword">do</span>
$$
<span class="token keyword">declare</span>
	rec record<span class="token punctuation">;</span>
	v_film_id <span class="token keyword">int</span> <span class="token operator">=</span> <span class="token number">2000</span><span class="token punctuation">;</span>
<span class="token keyword">begin</span>
	<span class="token comment">-- select a film </span>
	<span class="token keyword">select</span> film_id<span class="token punctuation">,</span> title 
	<span class="token keyword">into</span> strict rec
	<span class="token keyword">from</span> film
	<span class="token keyword">where</span> film_id <span class="token operator">=</span> v_film_id<span class="token punctuation">;</span>
<span class="token keyword">end</span><span class="token punctuation">;</span>
$$
<span class="token keyword">language</span> plpgsql<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>è¾“å‡ºï¼š</p>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>ERROR:  query returned no rows
CONTEXT:  PL/pgSQL function inline_code_block line 6 at SQL statement
SQL state: P0002ä»£ç è¯­è¨€ï¼š Shell Session  ï¼ˆshell ï¼‰
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>ä»¥ä¸‹ç¤ºä¾‹ä½¿ç”¨è¯¥<code>exception</code>å­å¥æ•è·<code>no_data_found</code>å¼‚å¸¸å¹¶æŠ¥å‘Šæ›´æœ‰æ„ä¹‰çš„æ¶ˆæ¯ï¼š</p>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token keyword">do</span>
$$
<span class="token keyword">declare</span>
	rec record<span class="token punctuation">;</span>
	v_film_id <span class="token keyword">int</span> <span class="token operator">=</span> <span class="token number">2000</span><span class="token punctuation">;</span>
<span class="token keyword">begin</span>
	<span class="token comment">-- select a film </span>
	<span class="token keyword">select</span> film_id<span class="token punctuation">,</span> title 
	<span class="token keyword">into</span> strict rec
	<span class="token keyword">from</span> film
	<span class="token keyword">where</span> film_id <span class="token operator">=</span> v_film_id<span class="token punctuation">;</span>
        <span class="token comment">-- catch exception</span>
	exception 
	   <span class="token keyword">when</span> no_data_found <span class="token keyword">then</span> 
	      raise exception <span class="token string">'film % not found'</span><span class="token punctuation">,</span> v_film_id<span class="token punctuation">;</span>
<span class="token keyword">end</span><span class="token punctuation">;</span>
$$
<span class="token keyword">language</span> plpgsql<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>è¾“å‡ºï¼š</p>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>ERROR:  film 2000 not found
CONTEXT:  PL/pgSQL function inline_code_block line 14 at RAISE
SQL state: P0001
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="_2-å¤„ç†-too-many-rows-å¼‚å¸¸ç¤ºä¾‹" tabindex="-1"><a class="header-anchor" href="#_2-å¤„ç†-too-many-rows-å¼‚å¸¸ç¤ºä¾‹" aria-hidden="true">#</a> [2]å¤„ç† too_many_rows å¼‚å¸¸ç¤ºä¾‹</h3>
<p>ä»¥ä¸‹ç¤ºä¾‹è¯´æ˜äº†å¦‚ä½•å¤„ç†<code>too_many_rows</code>å¼‚å¸¸ï¼š</p>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token keyword">do</span>
$$
<span class="token keyword">declare</span>
	rec record<span class="token punctuation">;</span>
<span class="token keyword">begin</span>
	<span class="token comment">-- select film </span>
	<span class="token keyword">select</span> film_id<span class="token punctuation">,</span> title 
	<span class="token keyword">into</span> strict rec
	<span class="token keyword">from</span> film
	<span class="token keyword">where</span> title <span class="token operator">LIKE</span> <span class="token string">'A%'</span><span class="token punctuation">;</span>
	
	exception 
	   <span class="token keyword">when</span> too_many_rows <span class="token keyword">then</span>
	      raise exception <span class="token string">'Search query returns too many rows'</span><span class="token punctuation">;</span>
<span class="token keyword">end</span><span class="token punctuation">;</span>
$$
<span class="token keyword">language</span> plpgsql<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>è¾“å‡ºï¼š</p>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>ERROR:  Search query returns too many rows
CONTEXT:  PL/pgSQL function inline_code_block line 15 at RAISE
SQL state: P0001
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œ<code>too_many_rows</code>å‘ç”Ÿå¼‚å¸¸æ˜¯å› ä¸ºè¯¥<code>select into</code>è¯­å¥è¿”å›å¤šè¡Œï¼Œè€Œå®ƒåº”è¯¥è¿”å›ä¸€è¡Œã€‚</p>
<h3 id="_3-å¤„ç†å¤šä¸ªå¼‚å¸¸" tabindex="-1"><a class="header-anchor" href="#_3-å¤„ç†å¤šä¸ªå¼‚å¸¸" aria-hidden="true">#</a> [3]å¤„ç†å¤šä¸ªå¼‚å¸¸</h3>
<p>ä»¥ä¸‹ç¤ºä¾‹è¯´æ˜äº†å¦‚ä½•æ•è·å¤šä¸ªå¼‚å¸¸ï¼š</p>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token keyword">do</span>
$$
<span class="token keyword">declare</span>
	rec record<span class="token punctuation">;</span>
	v_length <span class="token keyword">int</span> <span class="token operator">=</span> <span class="token number">90</span><span class="token punctuation">;</span>
<span class="token keyword">begin</span>
	<span class="token comment">-- select a film </span>
	<span class="token keyword">select</span> film_id<span class="token punctuation">,</span> title 
	<span class="token keyword">into</span> strict rec
	<span class="token keyword">from</span> film
	<span class="token keyword">where</span> length <span class="token operator">=</span> v_length<span class="token punctuation">;</span>
	
        <span class="token comment">-- catch exception</span>
	exception 
	   <span class="token keyword">when</span> sqlstate <span class="token string">'P0002'</span> <span class="token keyword">then</span> 
	      raise exception <span class="token string">'film with length % not found'</span><span class="token punctuation">,</span> v_length<span class="token punctuation">;</span>
	   <span class="token keyword">when</span> sqlstate <span class="token string">'P0003'</span> <span class="token keyword">then</span> 
	      raise exception <span class="token string">'The with length % is not unique'</span><span class="token punctuation">,</span> v_length<span class="token punctuation">;</span>
<span class="token keyword">end</span><span class="token punctuation">;</span>
$$
<span class="token keyword">language</span> plpgsql<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>è¾“å‡ºï¼š</p>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>ERROR:  The with length 90 is not unique
CONTEXT:  PL/pgSQL function inline_code_block line 17 at RAISE
SQL state: P0001
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="_4-å°†å¼‚å¸¸å¤„ç†ä¸º-sqlstate-ä»£ç " tabindex="-1"><a class="header-anchor" href="#_4-å°†å¼‚å¸¸å¤„ç†ä¸º-sqlstate-ä»£ç " aria-hidden="true">#</a> [4]å°†å¼‚å¸¸å¤„ç†ä¸º SQLSTATE ä»£ç </h3>
<p>ä»¥ä¸‹ç¤ºä¾‹ä¸ä¸Šé¢çš„ç¤ºä¾‹ç›¸åŒï¼Œåªæ˜¯å®ƒä½¿ç”¨<code>SQLSTATE</code>ä»£ç è€Œä¸æ˜¯æ¡ä»¶åç§°ï¼š</p>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token keyword">do</span>
$$
<span class="token keyword">declare</span>
	rec record<span class="token punctuation">;</span>
	v_length <span class="token keyword">int</span> <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">;</span>
<span class="token keyword">begin</span>
	<span class="token comment">-- select a film </span>
	<span class="token keyword">select</span> film_id<span class="token punctuation">,</span> title 
	<span class="token keyword">into</span> strict rec
	<span class="token keyword">from</span> film
	<span class="token keyword">where</span> length <span class="token operator">=</span> v_length<span class="token punctuation">;</span>
	
        <span class="token comment">-- catch exception</span>
	exception 
	   <span class="token keyword">when</span> sqlstate <span class="token string">'P0002'</span> <span class="token keyword">then</span> 
	      raise exception <span class="token string">'film with length % not found'</span><span class="token punctuation">,</span> v_length<span class="token punctuation">;</span>
	   <span class="token keyword">when</span> sqlstate <span class="token string">'P0003'</span> <span class="token keyword">then</span> 
	      raise exception <span class="token string">'The with length % is not unique'</span><span class="token punctuation">,</span> v_length<span class="token punctuation">;</span>
<span class="token keyword">end</span><span class="token punctuation">;</span>
$$
<span class="token keyword">language</span> plpgsql<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>è¾“å‡ºï¼š</p>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>ERROR:  film with length 30 not found
CONTEXT:  PL/pgSQL function inline_code_block line 15 at RAISE
SQL state: P0001
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h2 id="_9-å­˜å‚¨è¿‡ç¨‹" tabindex="-1"><a class="header-anchor" href="#_9-å­˜å‚¨è¿‡ç¨‹" aria-hidden="true">#</a> 9.å­˜å‚¨è¿‡ç¨‹</h2>
<h3 id="_1-åˆ›å»ºå­˜å‚¨è¿‡ç¨‹" tabindex="-1"><a class="header-anchor" href="#_1-åˆ›å»ºå­˜å‚¨è¿‡ç¨‹" aria-hidden="true">#</a> [1]åˆ›å»ºå­˜å‚¨è¿‡ç¨‹</h3>
<p>åœ¨ç”¨æˆ·å®šä¹‰çš„å‡½æ•°ä¸­ï¼Œä¸èƒ½å¯åŠ¨äº‹åŠ¡ï¼Œå¹¶æäº¤æˆ–å›æ»šå®ƒ</p>
<p>PostgreSQL 11 å¼•å…¥äº†æ”¯æŒäº‹åŠ¡çš„å­˜å‚¨è¿‡ç¨‹</p>
<p><code>create procedure</code>è¯­å¥çš„åŸºæœ¬è¯­æ³•ï¼š</p>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token keyword">create</span> <span class="token punctuation">[</span><span class="token operator">or</span> <span class="token keyword">replace</span><span class="token punctuation">]</span> <span class="token keyword">procedure</span> procedure_name<span class="token punctuation">(</span>parameter_list<span class="token punctuation">)</span>
<span class="token keyword">language</span> plpgsql
<span class="token keyword">as</span> $$
<span class="token keyword">declare</span>
<span class="token comment">-- variable declaration</span>
<span class="token keyword">begin</span>
<span class="token comment">-- stored procedure body</span>
<span class="token keyword">end</span><span class="token punctuation">;</span> $$
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><blockquote>
<ul>
<li>
<p>å­˜å‚¨è¿‡ç¨‹ä¸­çš„å‚æ•°å¯ä»¥æœ‰<code>in</code>å’Œ<code>inout</code>æ¨¡å¼ã€‚ä»–ä»¬ä¸èƒ½æœ‰<code>out</code>æ¨¡å¼</p>
</li>
<li>
<p>å­˜å‚¨è¿‡ç¨‹ä¸è¿”å›å€¼ã€‚æ‚¨ä¸èƒ½<code>return</code>åœ¨å­˜å‚¨è¿‡ç¨‹ä¸­ä½¿ç”¨å¸¦æœ‰å€¼çš„è¯­å¥</p>
</li>
<li>
<p>ä½†æ˜¯ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä¸å¸¦å€¼çš„returnæ¥åœæ­¢å­˜å‚¨è¿‡ç¨‹</p>
</li>
<li>
<p>å¦‚æœè¦ä»å­˜å‚¨è¿‡ç¨‹ä¸­è¿”å›å€¼ï¼Œå¯ä»¥å°†å‚æ•°ä¸<code>inout</code>æ¨¡å¼ä¸€èµ·ä½¿ç”¨</p>
</li>
</ul>
</blockquote>
<p>ç¤ºä¾‹ï¼š</p>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> accounts<span class="token punctuation">;</span>

<span class="token keyword">create</span> <span class="token keyword">table</span> accounts <span class="token punctuation">(</span>
    id <span class="token keyword">int</span> generated <span class="token keyword">by</span> <span class="token keyword">default</span> <span class="token keyword">as</span> <span class="token keyword">identity</span><span class="token punctuation">,</span>
    name <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
    balance <span class="token keyword">dec</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
    <span class="token keyword">primary</span> <span class="token keyword">key</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">insert</span> <span class="token keyword">into</span> accounts<span class="token punctuation">(</span>name<span class="token punctuation">,</span>balance<span class="token punctuation">)</span>
<span class="token keyword">values</span><span class="token punctuation">(</span><span class="token string">'Bob'</span><span class="token punctuation">,</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">insert</span> <span class="token keyword">into</span> accounts<span class="token punctuation">(</span>name<span class="token punctuation">,</span>balance<span class="token punctuation">)</span>
<span class="token keyword">values</span><span class="token punctuation">(</span><span class="token string">'Alice'</span><span class="token punctuation">,</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8a4e185a9e5041178c1eace8db38ab92~tplv-k3u1fbpfcp-zoom-1.image" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p>ä¸‹é¢çš„ç¤ºä¾‹åˆ›å»ºä¸€ä¸ªåä¸ºçš„å­˜å‚¨è¿‡ç¨‹<code>transfer</code>ï¼Œå°†æŒ‡å®šé‡‘é¢çš„èµ„é‡‘ä»ä¸€ä¸ªå¸æˆ·è½¬ç§»åˆ°å¦ä¸€ä¸ªå¸æˆ·ã€‚</p>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token keyword">create</span> <span class="token operator">or</span> <span class="token keyword">replace</span> <span class="token keyword">procedure</span> transfer<span class="token punctuation">(</span>
   sender <span class="token keyword">int</span><span class="token punctuation">,</span>
   receiver <span class="token keyword">int</span><span class="token punctuation">,</span> 
   amount <span class="token keyword">dec</span>
<span class="token punctuation">)</span>
<span class="token keyword">language</span> plpgsql    
<span class="token keyword">as</span> $$
<span class="token keyword">begin</span>
    <span class="token comment">-- subtracting the amount from the sender's account </span>
    <span class="token keyword">update</span> accounts 
    <span class="token keyword">set</span> balance <span class="token operator">=</span> balance <span class="token operator">-</span> amount 
    <span class="token keyword">where</span> id <span class="token operator">=</span> sender<span class="token punctuation">;</span>

    <span class="token comment">-- adding the amount to the receiver's account</span>
    <span class="token keyword">update</span> accounts 
    <span class="token keyword">set</span> balance <span class="token operator">=</span> balance <span class="token operator">+</span> amount 
    <span class="token keyword">where</span> id <span class="token operator">=</span> receiver<span class="token punctuation">;</span>

    <span class="token keyword">commit</span><span class="token punctuation">;</span>
<span class="token keyword">end</span><span class="token punctuation">;</span>$$
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h3 id="_2-è°ƒç”¨å­˜å‚¨è¿‡ç¨‹" tabindex="-1"><a class="header-anchor" href="#_2-è°ƒç”¨å­˜å‚¨è¿‡ç¨‹" aria-hidden="true">#</a> [2]è°ƒç”¨å­˜å‚¨è¿‡ç¨‹</h3>
<p>è¦è°ƒç”¨å­˜å‚¨è¿‡ç¨‹ï¼Œè¯·ä½¿ç”¨<code>CALL</code>å¦‚ä¸‹è¯­å¥ï¼š</p>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token keyword">call</span> stored_procedure_name<span class="token punctuation">(</span>argument_list<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>ä¾‹å¦‚ï¼Œæ­¤è¯­å¥è°ƒç”¨<code>transfer</code>å­˜å‚¨è¿‡ç¨‹<code>$1,000</code>ä» Bob çš„å¸æˆ·è½¬ç§»åˆ° Alice çš„å¸æˆ·ã€‚</p>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token keyword">call</span> transfer<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><h3 id="_3-åˆ é™¤å­˜å‚¨è¿‡ç¨‹" tabindex="-1"><a class="header-anchor" href="#_3-åˆ é™¤å­˜å‚¨è¿‡ç¨‹" aria-hidden="true">#</a> [3]åˆ é™¤å­˜å‚¨è¿‡ç¨‹</h3>
<p>åˆ é™¤è¯­æ³•ï¼š</p>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token keyword">drop</span> <span class="token keyword">procedure</span> <span class="token punctuation">[</span><span class="token keyword">if</span> <span class="token keyword">exists</span><span class="token punctuation">]</span> procedure_name <span class="token punctuation">(</span>argument_list<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token keyword">cascade</span> <span class="token operator">|</span> <span class="token keyword">restrict</span><span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><blockquote>
<p>ä½¿ç”¨<code>cascade</code>é€‰é¡¹åˆ é™¤å­˜å‚¨è¿‡ç¨‹åŠå…¶ä¾èµ–å¯¹è±¡ä»¥åŠä¾èµ–äºè¿™äº›å¯¹è±¡çš„å¯¹è±¡ç­‰ç­‰ã€‚é»˜è®¤é€‰é¡¹æ˜¯<code>restrict</code>åœ¨å­˜å‚¨è¿‡ç¨‹æœ‰ä»»ä½•ä¾èµ–å¯¹è±¡çš„æƒ…å†µä¸‹æ‹’ç»åˆ é™¤å®ƒã€‚</p>
</blockquote>
<p>è¦åˆ é™¤å¤šä¸ªå­˜å‚¨è¿‡ç¨‹ï¼Œè¯·åœ¨ drop procedure å…³é”®å­—ä¹‹åæŒ‡å®šå­˜å‚¨è¿‡ç¨‹åç§°çš„é€—å·åˆ—è¡¨ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>drop procedure [if exists] name1, name2, ...;
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><h2 id="_10-cursoræ¸¸æ ‡" tabindex="-1"><a class="header-anchor" href="#_10-cursoræ¸¸æ ‡" aria-hidden="true">#</a> 10.Cursoræ¸¸æ ‡</h2>
<p>æ¸¸æ ‡æ˜¯SQL çš„ä¸€ç§æ•°æ®è®¿é—®æœºåˆ¶ ï¼Œæ¸¸æ ‡æ˜¯ä¸€ç§å¤„ç†æ•°æ®çš„æ–¹æ³•ã€‚ä¼—æ‰€å‘¨çŸ¥ï¼Œä½¿ç”¨SQLçš„selectæŸ¥è¯¢æ“ä½œè¿”å›çš„ç»“æœæ˜¯ä¸€ä¸ªåŒ…å«ä¸€è¡Œæˆ–è€…æ˜¯å¤šè¡Œçš„æ•°æ®é›†ï¼Œå¦‚æœæˆ‘ä»¬è¦å¯¹æŸ¥è¯¢çš„ç»“æœå†è¿›è¡ŒæŸ¥è¯¢ï¼Œæ¯”å¦‚ï¼ˆæŸ¥çœ‹ç»“æœçš„ç¬¬ä¸€è¡Œã€ä¸‹ä¸€è¡Œã€æœ€åä¸€è¡Œã€å‰åè¡Œç­‰ç­‰æ“ä½œï¼‰ç®€å•çš„é€šè¿‡selectè¯­å¥æ˜¯æ— æ³•å®Œæˆçš„ï¼Œå› ä¸ºè¿™æ—¶å€™ç´¢è¦æŸ¥è¯¢çš„ç»“æœä¸æ˜¯æ•°æ®è¡¨ï¼Œè€Œæ˜¯å·²ç»æŸ¥è¯¢å‡ºæ¥çš„ç»“æœé›†ã€‚æ¸¸æ ‡å°±æ˜¯é’ˆå¯¹è¿™ç§æƒ…å†µè€Œå‡ºç°çš„ã€‚</p>
<p>PL/pgSQL æ¸¸æ ‡å…è®¸æ‚¨å°è£…æŸ¥è¯¢å¹¶ä¸€æ¬¡å¤„ç†æ¯ä¸€è¡Œ</p>
<p>å°†å¤§å‹ç»“æœé›†åˆ’åˆ†ä¸ºå¤šä¸ªéƒ¨åˆ†å¹¶å•ç‹¬å¤„ç†æ¯ä¸ªéƒ¨åˆ†æ—¶ï¼Œæ¨èä½¿ç”¨æ¸¸æ ‡ã€‚å¦‚æœä¸€æ¬¡å¤„ç†ï¼Œå¯èƒ½ä¼šå‡ºç°å†…å­˜æº¢å‡ºé”™è¯¯ï¼Œè€Œä¸”ï¼Œä½ å¯ä»¥å¼€å‘ä¸€ä¸ªè¿”å›å¯¹æ¸¸æ ‡çš„å¼•ç”¨çš„å‡½æ•°ã€‚è¿™æ˜¯ä»å‡½æ•°è¿”å›å¤§å‹ç»“æœé›†çš„æœ‰æ•ˆæ–¹æ³•ã€‚å‡½æ•°çš„è°ƒç”¨è€…å¯ä»¥æ ¹æ®æ¸¸æ ‡å¼•ç”¨å¤„ç†ç»“æœé›†ã€‚</p>
<p>åœ¨PostgreSQLä¸­ä½¿ç”¨æ¸¸æ ‡çš„å…·ä½“ï¼š</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b03d3937aeba48fa9bb6768ab67bfc6a~tplv-k3u1fbpfcp-zoom-1.image" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<ul>
<li><strong>å£°æ˜ä¸€ä¸ªæ¸¸æ ‡</strong>---è¦è®¿é—®æ¸¸æ ‡ï¼Œä½ éœ€è¦åœ¨å—çš„å£°æ˜éƒ¨åˆ†ä¸­å£°æ˜æ¸¸æ ‡å˜é‡ï¼Œæ¸¸æ ‡å˜é‡çš„ç±»å‹ä¸ºrefcursor</li>
<li><strong>æ‰“å¼€æ¸¸æ ‡</strong>---</li>
<li>ç„¶åï¼Œå°†ç»“æœé›†ä¸­çš„è¡Œæå–åˆ°ç›®æ ‡ä¸­ã€‚</li>
<li>ä¹‹åï¼Œæ£€æŸ¥æ˜¯å¦è¿˜æœ‰æ›´å¤šè¡Œè¦è·å–ã€‚å¦‚æœæ˜¯ï¼Œè½¬æ­¥éª¤3ï¼Œå¦åˆ™è½¬æ­¥éª¤5ã€‚</li>
<li>æœ€åï¼Œå…³é—­å…‰æ ‡</li>
</ul>
<h3 id="_1-å£°æ˜æ¸¸æ ‡" tabindex="-1"><a class="header-anchor" href="#_1-å£°æ˜æ¸¸æ ‡" aria-hidden="true">#</a> [1]å£°æ˜æ¸¸æ ‡</h3>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token comment">-- å£°æ˜æ¸¸æ ‡</span>
<span class="token keyword">declare</span> my_cursor refcursor<span class="token punctuation">;</span>
<span class="token comment">-- æˆ–è€…åœ¨æŸ¥è¯¢è¯­å¥ä¸­å£°æ˜</span>
cursor_name <span class="token punctuation">[</span> <span class="token punctuation">[</span><span class="token keyword">no</span><span class="token punctuation">]</span> scroll <span class="token punctuation">]</span> <span class="token keyword">cursor</span> <span class="token punctuation">[</span><span class="token punctuation">(</span> name datatype<span class="token punctuation">,</span> name <span class="token keyword">data</span> <span class="token keyword">type</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token keyword">for</span> query
<span class="token comment">-- NO SCROLL æ¸¸æ ‡ä¸èƒ½å‘åæ»šåŠ¨</span>
<span class="token comment">-- ç¤ºä¾‹</span>
<span class="token keyword">declare</span>
    cur_films  <span class="token keyword">cursor</span> <span class="token keyword">for</span> <span class="token comment">-- cur_filmsæ˜¯å°è£…è¡¨ä¸­æ‰€æœ‰è¡Œçš„æ¸¸æ ‡film</span>
		<span class="token keyword">select</span> <span class="token operator">*</span> 
		<span class="token keyword">from</span> film<span class="token punctuation">;</span>
    cur_films2 <span class="token keyword">cursor</span> <span class="token punctuation">(</span><span class="token keyword">year</span> <span class="token keyword">integer</span><span class="token punctuation">)</span> <span class="token keyword">for</span>  <span class="token comment">-- cur_films2å°è£…äº†å…·æœ‰ç‰¹å®šå‘è¡Œå¹´ä»½çš„ç”µå½±ã€‚film</span>
		<span class="token keyword">select</span> <span class="token operator">*</span> 
		<span class="token keyword">from</span> film 
		<span class="token keyword">where</span> release_year <span class="token operator">=</span> <span class="token keyword">year</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h3 id="_2-æ‰“å¼€æ¸¸æ ‡" tabindex="-1"><a class="header-anchor" href="#_2-æ‰“å¼€æ¸¸æ ‡" aria-hidden="true">#</a> [2]æ‰“å¼€æ¸¸æ ‡</h3>
<p>æ‰“å¼€æ¸¸æ ‡åˆ†ä¸ºæ‰“å¼€ç»‘å®šæ¸¸æ ‡å’Œæœªç»‘å®šæ¸¸æ ‡</p>
<p>æ‰“å¼€æœªç»‘å®šæ¸¸æ ‡ï¼š</p>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token comment">-- æ‰“å¼€æœªç»‘å®šæ¸¸æ ‡</span>
<span class="token keyword">OPEN</span> unbound_cursor_variable <span class="token punctuation">[</span> <span class="token punctuation">[</span> <span class="token keyword">NO</span> <span class="token punctuation">]</span> SCROLL <span class="token punctuation">]</span> <span class="token keyword">FOR</span> query<span class="token punctuation">;</span> 

<span class="token comment">-- å› ä¸ºæœªç»‘å®šæ¸¸æ ‡å˜é‡åœ¨æˆ‘ä»¬å£°æ˜å®ƒæ—¶æ²¡æœ‰ç»‘å®šåˆ°ä»»ä½•æŸ¥è¯¢ï¼Œæ‰€ä»¥æˆ‘ä»¬å¿…é¡»åœ¨æ‰“å¼€å®ƒæ—¶æŒ‡å®šæŸ¥è¯¢</span>
<span class="token keyword">open</span> my_cursor <span class="token keyword">for</span> 
	<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> city 
	<span class="token keyword">where</span> country <span class="token operator">=</span> p_country<span class="token punctuation">;</span>
	
<span class="token comment">-- PostgreSQL å…è®¸æ‚¨æ‰“å¼€æ¸¸æ ‡å¹¶å°†å…¶ç»‘å®šåˆ°åŠ¨æ€æŸ¥è¯¢	</span>
<span class="token keyword">open</span> unbound_cursor_variable<span class="token punctuation">[</span> <span class="token punctuation">[</span> <span class="token keyword">no</span> <span class="token punctuation">]</span> scroll <span class="token punctuation">]</span> 
<span class="token keyword">for</span> <span class="token keyword">execute</span> query_string <span class="token punctuation">[</span><span class="token keyword">using</span> expression <span class="token punctuation">[</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">]</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token comment">-- ç¤ºä¾‹ï¼šä½¿ç”¨å‚æ•°sort_fieldå¯¹è¡Œè¿›è¡Œæ’åºçš„åŠ¨æ€æŸ¥è¯¢</span>
query :<span class="token operator">=</span> <span class="token string">'select * from city order by $1'</span><span class="token punctuation">;</span>
<span class="token keyword">open</span> cur_city <span class="token keyword">for</span> <span class="token keyword">execute</span> query <span class="token keyword">using</span> sort_field<span class="token punctuation">;</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>æ‰“å¼€ç»‘å®šæ¸¸æ ‡ï¼š</p>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token comment">-- æ‰“å¼€ç»‘å®šæ¸¸æ ‡</span>
<span class="token keyword">open</span> cursor_variable<span class="token punctuation">[</span> <span class="token punctuation">(</span>name:<span class="token operator">=</span><span class="token keyword">value</span><span class="token punctuation">,</span>name:<span class="token operator">=</span><span class="token keyword">value</span><span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">-- ç¤ºä¾‹</span>
<span class="token keyword">open</span> cur_films<span class="token punctuation">;</span>
<span class="token keyword">open</span> cur_films2<span class="token punctuation">(</span><span class="token keyword">year</span>:<span class="token operator">=</span><span class="token number">2005</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="_3-ä½¿ç”¨æ¸¸æ ‡" tabindex="-1"><a class="header-anchor" href="#_3-ä½¿ç”¨æ¸¸æ ‡" aria-hidden="true">#</a> [3]ä½¿ç”¨æ¸¸æ ‡</h3>
<p>æ‰“å¼€æ¸¸æ ‡åï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>FETCH</code>ã€<code>MOVE</code>ã€<code>UPDATE</code>æˆ–<code>DELETE</code>è¯­å¥å¯¹å…¶è¿›è¡Œæ“ä½œ</p>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token comment">-- è·å–ä¸‹ä¸€è¡Œ</span>
<span class="token keyword">fetch</span> <span class="token punctuation">[</span> direction { <span class="token keyword">from</span> <span class="token operator">|</span> <span class="token operator">in</span> } <span class="token punctuation">]</span> cursor_variable <span class="token keyword">into</span> target_variable<span class="token punctuation">;</span>
<span class="token comment">-- é»˜è®¤æƒ…å†µä¸‹ï¼Œå¦‚æœæ‚¨æœªæ˜ç¡®æŒ‡å®šæ–¹å‘ï¼Œåˆ™å…‰æ ‡å°†è·å–ä¸‹ä¸€è¡Œnextã€‚ä»¥ä¸‹å¯¹æ¸¸æ ‡æœ‰æ•ˆï¼š</span>
<span class="token comment">-- next </span>
<span class="token comment">-- last </span>
<span class="token comment">-- prior</span>
<span class="token comment">-- first</span>
<span class="token comment">-- absolute count</span>
<span class="token comment">-- relative count</span>
<span class="token comment">-- forward</span>
<span class="token comment">-- backward</span>

<span class="token comment">-- ç¤ºä¾‹</span>
<span class="token keyword">fetch</span> cur_films <span class="token keyword">into</span> row_film<span class="token punctuation">;</span>
<span class="token keyword">fetch</span> <span class="token keyword">last</span> <span class="token keyword">from</span> row_film <span class="token keyword">into</span> title<span class="token punctuation">,</span> release_year<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h3 id="_4-ç§»åŠ¨å…‰æ ‡" tabindex="-1"><a class="header-anchor" href="#_4-ç§»åŠ¨å…‰æ ‡" aria-hidden="true">#</a> [4]ç§»åŠ¨å…‰æ ‡</h3>
<p>å¦‚æœæ‚¨åªæƒ³ç§»åŠ¨å…‰æ ‡è€Œä¸æ£€ç´¢ä»»ä½•è¡Œï¼Œåˆ™ä½¿ç”¨è¯¥<code>MOVE</code>è¯­å¥ã€‚<code>FETCH</code>æ–¹å‘æ¥å—ä¸è¯­å¥ç›¸åŒçš„å€¼</p>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token comment">-- ç§»åŠ¨è¯­æ³•</span>
move <span class="token punctuation">[</span> direction { <span class="token keyword">from</span> <span class="token operator">|</span> <span class="token operator">in</span> } <span class="token punctuation">]</span> cursor_variable<span class="token punctuation">;</span>

<span class="token comment">-- ç¤ºä¾‹</span>
move cur_films2<span class="token punctuation">;</span>
move <span class="token keyword">last</span> <span class="token keyword">from</span> cur_films<span class="token punctuation">;</span>
move relative <span class="token operator">-</span><span class="token number">1</span> <span class="token keyword">from</span> cur_films<span class="token punctuation">;</span>
move forward <span class="token number">3</span> <span class="token keyword">from</span> cur_films<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="_5-åˆ é™¤æˆ–æ›´æ–°è¡Œ" tabindex="-1"><a class="header-anchor" href="#_5-åˆ é™¤æˆ–æ›´æ–°è¡Œ" aria-hidden="true">#</a> [5]åˆ é™¤æˆ–æ›´æ–°è¡Œ</h3>
<p>å®šä½æ¸¸æ ‡åï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>DELETE WHERE CURRENT OF</code>or<code>UPDATE WHERE CURRENT OF</code>è¯­å¥åˆ é™¤æˆ–æ›´æ–°æ¸¸æ ‡æ ‡è¯†çš„è¡Œï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token comment">-- æ›´æ–°ã€åˆ é™¤è¡Œè¯­æ³•</span>
<span class="token keyword">update</span> table_name 
<span class="token keyword">set</span> <span class="token keyword">column</span> <span class="token operator">=</span> <span class="token keyword">value</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
<span class="token keyword">where</span> <span class="token keyword">current</span> <span class="token keyword">of</span> cursor_variable<span class="token punctuation">;</span>

<span class="token keyword">delete</span> <span class="token keyword">from</span> table_name 
<span class="token keyword">where</span> <span class="token keyword">current</span> <span class="token keyword">of</span> cursor_variable<span class="token punctuation">;</span>

<span class="token comment">-- ç¤ºä¾‹</span>
<span class="token keyword">update</span> film 
<span class="token keyword">set</span> release_year <span class="token operator">=</span> p_year 
<span class="token keyword">where</span> <span class="token keyword">current</span> <span class="token keyword">of</span> cur_films<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h3 id="_6-å…³é—­æ¸¸æ ‡" tabindex="-1"><a class="header-anchor" href="#_6-å…³é—­æ¸¸æ ‡" aria-hidden="true">#</a> [6]å…³é—­æ¸¸æ ‡</h3>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token keyword">close</span> cursor_variable<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><h3 id="_7-ç»¼åˆç¤ºä¾‹" tabindex="-1"><a class="header-anchor" href="#_7-ç»¼åˆç¤ºä¾‹" aria-hidden="true">#</a> [7]ç»¼åˆç¤ºä¾‹</h3>
<p>åˆ›å»ºä¸€ä¸ªå‡½æ•°ï¼Œåœ¨è¿™ä¸ªå‡½æ•°å†…ä½¿ç”¨æ¸¸æ ‡å®ç°æŸ¥æ‰¾2006å‘è¡Œå¹´ä»½çš„ç”µå½±å¹¶ä¸”ç”µå½±åä¸­åŒ…å«fulçš„ä¿¡æ¯</p>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token keyword">select</span> title<span class="token punctuation">,</span> release_year <span class="token keyword">from</span> film <span class="token keyword">where</span> release_year <span class="token operator">=</span> <span class="token number">2006</span><span class="token punctuation">;</span> <span class="token comment">-- æœ‰ä¸€åƒæ¡ç»“æœ</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2375bef827804de59d64a8e3c02c497e~tplv-k3u1fbpfcp-zoom-1.image" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token keyword">create</span> <span class="token operator">or</span> <span class="token keyword">replace</span> <span class="token keyword">function</span> get_film_titles<span class="token punctuation">(</span>p_year <span class="token keyword">integer</span><span class="token punctuation">)</span>
   <span class="token keyword">returns</span> <span class="token keyword">text</span> <span class="token keyword">as</span> $$
<span class="token keyword">declare</span> 
	 titles <span class="token keyword">text</span> <span class="token keyword">default</span> <span class="token string">''</span><span class="token punctuation">;</span>
	 rec_film   record<span class="token punctuation">;</span>
	 cur_films <span class="token keyword">cursor</span><span class="token punctuation">(</span>p_year <span class="token keyword">integer</span><span class="token punctuation">)</span> <span class="token comment">-- æŸ¥è¯¢æŸå¹´ä»½çš„ç”µå½±</span>
		 <span class="token keyword">for</span> <span class="token keyword">select</span> title<span class="token punctuation">,</span> release_year
		 <span class="token keyword">from</span> film
		 <span class="token keyword">where</span> release_year <span class="token operator">=</span> p_year<span class="token punctuation">;</span>
<span class="token keyword">begin</span>
   <span class="token comment">-- æ‰“å¼€æ¸¸æ ‡</span>
   <span class="token keyword">open</span> cur_films<span class="token punctuation">(</span>p_year<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
   <span class="token keyword">loop</span>
    <span class="token comment">-- fetch row into the film ä½¿ç”¨æ¸¸æ ‡ å°†å°†æŸ¥è¯¢ç»“æœæŒ¨ä¸ªå¤„ç†</span>
      <span class="token keyword">fetch</span> cur_films <span class="token keyword">into</span> rec_film<span class="token punctuation">;</span>
    <span class="token comment">-- exit when no more row to fetch</span>
      <span class="token keyword">exit</span> <span class="token keyword">when</span> <span class="token operator">not</span> found<span class="token punctuation">;</span>

    <span class="token comment">-- build the output</span>
      <span class="token keyword">if</span> rec_film<span class="token punctuation">.</span>title <span class="token operator">like</span> <span class="token string">'%ful%'</span> <span class="token keyword">then</span> 
         titles :<span class="token operator">=</span> titles <span class="token operator">||</span> <span class="token string">','</span> <span class="token operator">||</span> rec_film<span class="token punctuation">.</span>title <span class="token operator">||</span> <span class="token string">':'</span> <span class="token operator">||</span> rec_film<span class="token punctuation">.</span>release_year<span class="token punctuation">;</span>
      <span class="token keyword">end</span> <span class="token keyword">if</span><span class="token punctuation">;</span>
   <span class="token keyword">end</span> <span class="token keyword">loop</span><span class="token punctuation">;</span>
  
   <span class="token comment">-- close the cursor</span>
   <span class="token keyword">close</span> cur_films<span class="token punctuation">;</span>

   <span class="token keyword">return</span> titles<span class="token punctuation">;</span>
<span class="token keyword">end</span><span class="token punctuation">;</span> $$

<span class="token keyword">language</span> plpgsql<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token keyword">select</span> get_film_titles<span class="token punctuation">(</span><span class="token number">2006</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b84158f48fb143fda401709032e72180~tplv-k3u1fbpfcp-zoom-1.image" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<h2 id="_11-è§¦å‘å™¨" tabindex="-1"><a class="header-anchor" href="#_11-è§¦å‘å™¨" aria-hidden="true">#</a> 11.è§¦å‘å™¨</h2>
<p>å‚è€ƒï¼šhttps://www.postgresqltutorial.com/postgresql-plpgsql/</p>
<h3 id="_1-è§¦å‘å™¨ç®€ä»‹" tabindex="-1"><a class="header-anchor" href="#_1-è§¦å‘å™¨ç®€ä»‹" aria-hidden="true">#</a> [1]è§¦å‘å™¨ç®€ä»‹</h3>
<p>PostgreSQL è§¦å‘å™¨æ˜¯æ¯å½“ä¸è¡¨å…³è”çš„äº‹ä»¶å‘ç”Ÿæ—¶è‡ªåŠ¨è°ƒç”¨çš„å‡½æ•°ã€‚äº‹ä»¶å¯ä»¥æ˜¯ä»¥ä¸‹ä»»ä½•ä¸€ç§ï¼š<code>INSERT</code>ã€<code>UPDATE</code>ã€<code>DELETE</code>æˆ–<code>TRUNCATE</code></p>
<p>è§¦å‘å™¨æ˜¯ä¸è¡¨å…³è”çš„ç‰¹æ®Šç”¨æˆ·å®šä¹‰å‡½æ•°ã€‚è¦åˆ›å»ºæ–°è§¦å‘å™¨ï¼Œé¦–å…ˆå®šä¹‰ä¸€ä¸ªè§¦å‘å™¨å‡½æ•°ï¼Œç„¶åå°†æ­¤è§¦å‘å™¨å‡½æ•°ç»‘å®šåˆ°ä¸€ä¸ªè¡¨ã€‚è§¦å‘å™¨å’Œç”¨æˆ·è‡ªå®šä¹‰å‡½æ•°çš„åŒºåˆ«åœ¨äºè§¦å‘å™¨åœ¨è§¦å‘äº‹ä»¶å‘ç”Ÿæ—¶è‡ªåŠ¨è°ƒç”¨ã€‚</p>
<p>PostgreSQL æä¾›ä¸¤ç§ä¸»è¦ç±»å‹çš„è§¦å‘å™¨ï¼š<strong>è¡Œçº§è§¦å‘å™¨</strong>å’Œ<strong>è¯­å¥çº§è§¦å‘å™¨</strong>ã€‚è¿™ä¸¤ç§çš„åŒºåˆ«åœ¨äºè§¦å‘å™¨è¢«è°ƒç”¨çš„æ¬¡æ•°å’Œæ—¶é—´ã€‚</p>
<p>ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨å‘å‡ºä¸€æ¡<code>UPDATE</code>å½±å“ 20 è¡Œçš„è¯­å¥ï¼Œåˆ™è¡Œçº§è§¦å‘å™¨å°†è¢«è°ƒç”¨ 20 æ¬¡ï¼Œè€Œè¯­å¥çº§è§¦å‘å™¨å°†è¢«è°ƒç”¨ 1 æ¬¡ã€‚</p>
<p>æ‚¨å¯ä»¥æŒ‡å®šè§¦å‘å™¨æ˜¯åœ¨äº‹ä»¶<strong>ä¹‹å‰</strong>è¿˜æ˜¯<strong>ä¹‹å</strong>è°ƒç”¨ã€‚å¦‚æœè§¦å‘å™¨åœ¨äº‹ä»¶ä¹‹å‰è°ƒç”¨ï¼Œå®ƒå¯ä»¥è·³è¿‡å½“å‰è¡Œçš„æ“ä½œï¼Œç”šè‡³æ›´æ”¹æ­£åœ¨æ›´æ–°æˆ–æ’å…¥çš„è¡Œã€‚å¦‚æœåœ¨äº‹ä»¶ä¹‹åè°ƒç”¨è§¦å‘å™¨ï¼Œåˆ™è§¦å‘å™¨å¯ä»¥ä½¿ç”¨æ‰€æœ‰æ›´æ”¹ã€‚</p>
<p>è§¦å‘å™¨åœ¨å„ç§åº”ç”¨ç¨‹åºè®¿é—®æ•°æ®åº“çš„æƒ…å†µä¸‹å¾ˆæœ‰ç”¨ï¼Œå¹¶ä¸”æ‚¨å¸Œæœ›åœ¨ä¿®æ”¹è¡¨æ•°æ®æ—¶è‡ªåŠ¨è¿è¡Œçš„æ•°æ®åº“ä¸­ä¿æŒè·¨åŠŸèƒ½ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨æƒ³ä¿ç•™æ•°æ®å†å²è®°å½•è€Œä¸è¦æ±‚åº”ç”¨ç¨‹åºå…·æœ‰æ£€æŸ¥æ¯ä¸ªäº‹ä»¶çš„é€»è¾‘ï¼Œä¾‹å¦‚<code>INSERT</code>æˆ–<code>UDPATE</code>ã€‚</p>
<p>æ‚¨è¿˜å¯ä»¥ä½¿ç”¨è§¦å‘å™¨æ¥ç»´æŠ¤å¤æ‚çš„æ•°æ®å®Œæ•´æ€§è§„åˆ™ï¼Œé™¤äº†åœ¨æ•°æ®åº“çº§åˆ«ä¹‹å¤–ï¼Œæ‚¨æ— æ³•åœ¨å…¶ä»–åœ°æ–¹å®ç°è¿™äº›è§„åˆ™ã€‚ä¾‹å¦‚ï¼Œå½“å‘<code>customer</code>è¡¨ä¸­æ·»åŠ æ–°è¡Œæ—¶ï¼Œè¿˜å¿…é¡»åœ¨é“¶è¡Œå’Œä¿¡ç”¨è¡¨ä¸­åˆ›å»ºå…¶ä»–è¡Œã€‚</p>
<p>ä½¿ç”¨è§¦å‘å™¨çš„ä¸»è¦ç¼ºç‚¹æ˜¯æ‚¨å¿…é¡»çŸ¥é“è§¦å‘å™¨çš„å­˜åœ¨å¹¶äº†è§£å…¶é€»è¾‘æ‰èƒ½å¼„æ¸…æ¥šæ•°æ®æ›´æ”¹æ—¶çš„å½±å“ã€‚</p>
<p>å°½ç®¡ PostgreSQL å®ç°äº† SQL æ ‡å‡†ï¼Œä½† PostgreSQL ä¸­çš„è§¦å‘å™¨å…·æœ‰ä¸€äº›ç‰¹å®šçš„åŠŸèƒ½ï¼š</p>
<ul>
<li>PostgreSQL è§¦å‘ <code>TRUNCATE</code>äº‹ä»¶çš„è§¦å‘å™¨ã€‚</li>
<li>PostgreSQL å…è®¸æ‚¨åœ¨è§†å›¾ä¸Šå®šä¹‰è¯­å¥çº§è§¦å‘å™¨ã€‚</li>
<li>PostgreSQL è¦æ±‚ä½ å®šä¹‰ä¸€ä¸ªç”¨æˆ·å®šä¹‰çš„å‡½æ•°ä½œä¸ºè§¦å‘å™¨çš„åŠ¨ä½œï¼Œè€Œ SQL æ ‡å‡†å…è®¸ä½ ä½¿ç”¨ä»»ä½• SQL å‘½ä»¤ã€‚</li>
</ul>
<h3 id="_2-åˆ›å»ºè§¦å‘å™¨" tabindex="-1"><a class="header-anchor" href="#_2-åˆ›å»ºè§¦å‘å™¨" aria-hidden="true">#</a> [2]åˆ›å»ºè§¦å‘å™¨</h3>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token comment">-- åˆ›å»ºè§¦å‘å™¨</span>
<span class="token keyword">CREATE</span> <span class="token keyword">FUNCTION</span> <span class="token comment">-- é¦–å…ˆï¼Œä½¿ç”¨è¯­å¥åˆ›å»ºä¸€ä¸ªè§¦å‘å‡½æ•°ã€‚</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TRIGGER</span> <span class="token comment">-- å…¶æ¬¡ï¼Œé€šè¿‡usingè¯­å¥å°†è§¦å‘å™¨å‡½æ•°ç»‘å®šåˆ°è¡¨ã€‚</span>

<span class="token comment">-- åˆ›å»ºè§¦å‘å™¨å‡½æ•°è¯­æ³•</span>
<span class="token keyword">CREATE</span> <span class="token keyword">FUNCTION</span> trigger_function<span class="token punctuation">(</span><span class="token punctuation">)</span> 
   <span class="token keyword">RETURNS</span> <span class="token keyword">TRIGGER</span> 
   <span class="token keyword">LANGUAGE</span> PLPGSQL
<span class="token keyword">AS</span> $$
<span class="token keyword">BEGIN</span>
   <span class="token comment">-- trigger logic</span>
<span class="token keyword">END</span><span class="token punctuation">;</span>
$$
<span class="token comment">-- è§¦å‘å‡½æ•°ç±»ä¼¼äºå¸¸è§„çš„ç”¨æˆ·å®šä¹‰å‡½æ•°ã€‚ä½†æ˜¯ï¼Œè§¦å‘å™¨å‡½æ•°ä¸æ¥å—ä»»ä½•å‚æ•°ï¼Œå¹¶ä¸”å…·æœ‰ç±»å‹ä¸ºtriggerçš„è¿”å›å€¼ã€‚</span>
<span class="token comment">-- ä¸€æ—¦å®šä¹‰äº†è§¦å‘å‡½æ•°ï¼Œå°±å¯ä»¥å°†å…¶ç»‘å®šåˆ°ä¸€ä¸ªæˆ–å¤šä¸ªè§¦å‘äº‹ä»¶ï¼Œä¾‹å¦‚INSERTã€UPDATEå’ŒDELETEã€‚</span>

<span class="token comment">-- åˆ›å»ºè§¦å‘å™¨åŸºæœ¬è¯­æ³•</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TRIGGER</span> trigger_name 
   {BEFORE <span class="token operator">|</span> <span class="token keyword">AFTER</span>} { event } <span class="token comment">-- BEFOREã€AFTERï¼šè§¦å‘è§¦å‘å™¨çš„æ—¶é—´ ï¼Œeventï¼šè§¦å‘è§¦å‘å™¨äº‹ä»¶</span>
   <span class="token keyword">ON</span> table_name <span class="token comment">-- è§¦å‘å™¨ç»‘å®šçš„è¡¨</span>
   <span class="token punctuation">[</span><span class="token keyword">FOR</span> <span class="token punctuation">[</span>EACH<span class="token punctuation">]</span> { <span class="token keyword">ROW</span> <span class="token operator">|</span> STATEMENT }<span class="token punctuation">]</span> <span class="token comment">--  ROWï¼šè¡Œçº§è§¦å‘å™¨ï¼ŒSTATEMENTè¯­å¥è§¦å‘å™¨</span>
       <span class="token keyword">EXECUTE</span> <span class="token keyword">PROCEDURE</span> trigger_function <span class="token comment">-- æŒ‡å®šè§¦å‘å™¨å‡½æ•°åç§°</span>
  
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>ç¤ºä¾‹ï¼š</p>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> employees<span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> employees<span class="token punctuation">(</span>
   id <span class="token keyword">INT</span> GENERATED ALWAYS <span class="token keyword">AS</span> <span class="token keyword">IDENTITY</span><span class="token punctuation">,</span>
   first_name <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
   last_name <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
   <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- å‡è®¾å½“å‘˜å·¥çš„å§“åå‘ç”Ÿæ›´æ”¹æ—¶ï¼Œæ‚¨å¸Œæœ›å°†æ›´æ”¹è®°å½•åœ¨åä¸ºçš„å•ç‹¬è¡¨ä¸­employee_auditsï¼š</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> employee_audits <span class="token punctuation">(</span>
   id <span class="token keyword">INT</span> GENERATED ALWAYS <span class="token keyword">AS</span> <span class="token keyword">IDENTITY</span><span class="token punctuation">,</span>
   employee_id <span class="token keyword">INT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
   last_name <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
   changed_on <span class="token keyword">TIMESTAMP</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- åˆ›å»ºè§¦å‘å™¨å‡½æ•°</span>
<span class="token keyword">CREATE</span> <span class="token operator">OR</span> <span class="token keyword">REPLACE</span> <span class="token keyword">FUNCTION</span> log_last_name_changes<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">RETURNS</span> <span class="token keyword">TRIGGER</span> 
  <span class="token keyword">LANGUAGE</span> PLPGSQL
  <span class="token keyword">AS</span>
$$
<span class="token keyword">BEGIN</span>
	<span class="token keyword">IF</span> NEW<span class="token punctuation">.</span>last_name <span class="token operator">&lt;></span> OLD<span class="token punctuation">.</span>last_name <span class="token keyword">THEN</span>
		 <span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> employee_audits<span class="token punctuation">(</span>employee_id<span class="token punctuation">,</span>last_name<span class="token punctuation">,</span>changed_on<span class="token punctuation">)</span>
		 <span class="token keyword">VALUES</span><span class="token punctuation">(</span>OLD<span class="token punctuation">.</span>id<span class="token punctuation">,</span>OLD<span class="token punctuation">.</span>last_name<span class="token punctuation">,</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">END</span> <span class="token keyword">IF</span><span class="token punctuation">;</span>

	<span class="token keyword">RETURN</span> NEW<span class="token punctuation">;</span>
<span class="token keyword">END</span><span class="token punctuation">;</span>
$$

<span class="token comment">-- åˆ›å»ºè§¦å‘å™¨ï¼ˆå°†è§¦å‘å™¨å‡½æ•°ç»‘å®šåˆ°employeesè¡¨</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TRIGGER</span> last_name_changes
  BEFORE <span class="token keyword">UPDATE</span>
  <span class="token keyword">ON</span> employees
  <span class="token keyword">FOR EACH ROW</span>
  <span class="token keyword">EXECUTE</span> <span class="token keyword">PROCEDURE</span> log_last_name_changes<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
<span class="token comment">-- æ’å…¥äº›æµ‹è¯•æ•°æ®</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> employees <span class="token punctuation">(</span>first_name<span class="token punctuation">,</span> last_name<span class="token punctuation">)</span>
<span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'John'</span><span class="token punctuation">,</span> <span class="token string">'Doe'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> employees <span class="token punctuation">(</span>first_name<span class="token punctuation">,</span> last_name<span class="token punctuation">)</span>
<span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'Lily'</span><span class="token punctuation">,</span> <span class="token string">'Bush'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- ä½¿ç”¨è§¦å‘å™¨</span>
<span class="token keyword">UPDATE</span> employees <span class="token keyword">SET</span> last_name <span class="token operator">=</span> <span class="token string">'Brown'</span> <span class="token keyword">WHERE</span> ID <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>

<span class="token comment">-- æ›´æ–°å</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> employees<span class="token punctuation">;</span>
 id <span class="token operator">|</span> first_name <span class="token operator">|</span> last_name
<span class="token comment">----+------------+-----------</span>
  <span class="token number">1</span> <span class="token operator">|</span> John       <span class="token operator">|</span> Doe
  <span class="token number">2</span> <span class="token operator">|</span> Lily       <span class="token operator">|</span> Brown
  
  
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> employee_audits<span class="token punctuation">;</span>
d <span class="token operator">|</span> last_name <span class="token operator">|</span>        changed_on
<span class="token comment">----+-------------+-----------+---------------------------</span>
  <span class="token number">1</span> <span class="token operator">|</span>           <span class="token number">2</span> <span class="token operator">|</span> Bush      <span class="token operator">|</span> <span class="token number">2022</span><span class="token operator">-</span><span class="token number">09</span><span class="token operator">-</span><span class="token number">10</span> <span class="token number">13</span>:<span class="token number">34</span>:<span class="token number">15.19555</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br></div></div><h3 id="_3-åˆ é™¤è§¦å‘å™¨" tabindex="-1"><a class="header-anchor" href="#_3-åˆ é™¤è§¦å‘å™¨" aria-hidden="true">#</a> [3]åˆ é™¤è§¦å‘å™¨</h3>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token comment">-- ä»è¡¨ä¸­åˆ é™¤è§¦å‘å™¨è¯­æ³•</span>
<span class="token keyword">DROP</span> <span class="token keyword">TRIGGER</span> <span class="token punctuation">[</span><span class="token keyword">IF</span> <span class="token keyword">EXISTS</span><span class="token punctuation">]</span> trigger_name 
<span class="token keyword">ON</span> table_name <span class="token punctuation">[</span> <span class="token keyword">CASCADE</span> <span class="token operator">|</span> <span class="token keyword">RESTRICT</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token comment">-- CASCADEè¿åŒåˆ é™¤ä¾èµ–è§¦å‘å™¨çš„å¯¹è±¡ï¼Œé»˜è®¤RESTRICTä¸åˆ é™¤ä¾èµ–å¯¹è±¡</span>

<span class="token comment">-- ç¤ºä¾‹ï¼š</span>
<span class="token comment">-- åˆ›å»ºä¸€ä¸ªéªŒè¯å‘˜å·¥ç”¨æˆ·åçš„å‡½æ•°ã€‚å‘˜å·¥çš„ç”¨æˆ·åä¸èƒ½ä¸ºç©ºï¼Œé•¿åº¦è‡³å°‘ä¸º8ã€‚</span>
<span class="token keyword">CREATE</span> <span class="token keyword">FUNCTION</span> check_staff_user<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">RETURNS</span> <span class="token keyword">TRIGGER</span>
<span class="token keyword">AS</span> $$
<span class="token keyword">BEGIN</span>
    <span class="token keyword">IF</span> length<span class="token punctuation">(</span>NEW<span class="token punctuation">.</span>username<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">8</span> <span class="token operator">OR</span> NEW<span class="token punctuation">.</span>username <span class="token operator">IS</span> <span class="token boolean">NULL</span> <span class="token keyword">THEN</span>
        RAISE EXCEPTION <span class="token string">'The username cannot be less than 8 characters'</span><span class="token punctuation">;</span>
    <span class="token keyword">END</span> <span class="token keyword">IF</span><span class="token punctuation">;</span>
    <span class="token keyword">IF</span> NEW<span class="token punctuation">.</span>NAME <span class="token operator">IS</span> <span class="token boolean">NULL</span> <span class="token keyword">THEN</span>
        RAISE EXCEPTION <span class="token string">'Username cannot be NULL'</span><span class="token punctuation">;</span>
    <span class="token keyword">END</span> <span class="token keyword">IF</span><span class="token punctuation">;</span>
    <span class="token keyword">RETURN</span> NEW<span class="token punctuation">;</span>
<span class="token keyword">END</span><span class="token punctuation">;</span>
$$
<span class="token keyword">LANGUAGE</span> plpgsql<span class="token punctuation">;</span>

<span class="token comment">-- åˆ›å»ºè§¦å‘å™¨ç»‘å®šè§¦å‘å™¨å‡½æ•°</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TRIGGER</span> username_check 
    BEFORE <span class="token keyword">INSERT</span> <span class="token operator">OR</span> <span class="token keyword">UPDATE</span>
<span class="token keyword">ON</span> staff
<span class="token keyword">FOR EACH ROW</span> 
    <span class="token keyword">EXECUTE</span> <span class="token keyword">PROCEDURE</span> check_staff_user<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- åˆ é™¤è§¦å‘å™¨</span>
<span class="token keyword">DROP</span> <span class="token keyword">TRIGGER</span> username_check
<span class="token keyword">ON</span> staff<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><h3 id="_4-é‡å‘½åè§¦å‘å™¨" tabindex="-1"><a class="header-anchor" href="#_4-é‡å‘½åè§¦å‘å™¨" aria-hidden="true">#</a> [4]é‡å‘½åè§¦å‘å™¨</h3>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token comment">-- é‡å‘½åè§¦å‘å™¨åç§°</span>
<span class="token keyword">ALTER</span> <span class="token keyword">TRIGGER</span> trigger_name
<span class="token keyword">ON</span> table_name 
<span class="token keyword">RENAME</span> <span class="token keyword">TO</span> new_trigger_name<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="_5-ç¦ç”¨è§¦å‘å™¨" tabindex="-1"><a class="header-anchor" href="#_5-ç¦ç”¨è§¦å‘å™¨" aria-hidden="true">#</a> [5]ç¦ç”¨è§¦å‘å™¨</h3>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> table_name
<span class="token keyword">DISABLE</span> <span class="token keyword">TRIGGER</span> trigger_name <span class="token operator">|</span> <span class="token keyword">ALL</span>
<span class="token comment">-- ALLç¦ç”¨ä¸è¯¥è¡¨å…³è”çš„æ‰€æœ‰è§¦å‘å™¨</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="_6-å¯ç”¨è§¦å‘å™¨" tabindex="-1"><a class="header-anchor" href="#_6-å¯ç”¨è§¦å‘å™¨" aria-hidden="true">#</a> [6]å¯ç”¨è§¦å‘å™¨</h3>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> table_name
<span class="token keyword">ENABLE</span> <span class="token keyword">TRIGGER</span> trigger_name <span class="token operator">|</span>  <span class="token keyword">ALL</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>å‚è€ƒï¼šhttps://www.postgresqltutorial.com/</p>
</template>
