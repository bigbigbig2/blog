<template><nav class="table-of-contents"><ul><li><RouterLink to="#_1-颜色滤镜">1.颜色滤镜</RouterLink><ul><li><RouterLink to="#_1-灰度图">[1]灰度图</RouterLink></li><li><RouterLink to="#_2-改变图象亮度">[2]改变图象亮度</RouterLink></li></ul></li><li><RouterLink to="#_2-高斯模糊-平滑">2.高斯模糊/平滑</RouterLink></li><li><RouterLink to="#_3-多层滤镜叠加">3.多层滤镜叠加</RouterLink></li></ul></nav>
<p>在对图形进行像素处理之前，需要对其进行像素化。</p>
<p>所谓像素化，就是把一个图像看成是由一组像素点组合而成的。每个像素点负责描述图像上的一个点，并且带有这个点的基本绘图信息。那对于一张 800 像素宽、600 像素高的图片来说，整张图一共就有 48 万个像素点。</p>
<p>每一个像素点都存储着四个颜色通道RGBA</p>
<p>而常见的像素处理应用有：</p>
<ul>
<li>颜色滤镜（灰度图、颜色滤镜等）</li>
<li>高斯滤镜（人像美颜等）</li>
</ul>
<p>在实际的可视化项目中，可以通过像素处理来增强视觉效果</p>
<h2 id="_1-颜色滤镜" tabindex="-1"><a class="header-anchor" href="#_1-颜色滤镜" aria-hidden="true">#</a> 1.颜色滤镜</h2>
<h3 id="_1-灰度图" tabindex="-1"><a class="header-anchor" href="#_1-灰度图" aria-hidden="true">#</a> [1]灰度图</h3>
<p>实现灰度图简单来说就是将一张彩色图片变为灰白色图片。具体的实现思路是，我们先将该图片的每个像素点的 R、G、B 通道的值进行加权平均，然后将这个值作为每个像素点新的 R、G、B 通道值，具体公式如下：</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"></span><span class="mord mathnormal">b</span><span class="mord mathnormal">G</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal">c</span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:0.8019em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8019em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8019em;"></span><span class="mord"><span class="mord mathnormal">G</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8019em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8019em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8019em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.8769em;vertical-align:-0.7693em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.1076em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal">c</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.7693em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p>其中 R、G、B 是原图片中的 R、G、B 通道的色值，V 是加权平均色值，a、b、c 是加权系数，满足 (a + b + c) = 1。</p>
<p>下面使用公式对应的颜色矩阵来实现：</p>
<div class="language-glsl ext-glsl line-numbers-mode"><pre v-pre class="language-glsl"><code><span class="token keyword">precision</span> <span class="token keyword">mediump</span> <span class="token keyword">float</span><span class="token punctuation">;</span> 
<span class="token keyword">uniform</span> <span class="token keyword">sampler2D</span> u_image<span class="token punctuation">;</span>
<span class="token keyword">varying</span> <span class="token keyword">vec2</span> v_texCoord<span class="token punctuation">;</span>  
<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">vec4</span> color <span class="token operator">=</span> <span class="token function">texture2D</span><span class="token punctuation">(</span>u_image<span class="token punctuation">,</span> v_texCoord<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//原色</span>
    <span class="token keyword">float</span> average <span class="token operator">=</span> <span class="token punctuation">(</span>color<span class="token punctuation">.</span>r <span class="token operator">+</span> color<span class="token punctuation">.</span>g <span class="token operator">+</span> color<span class="token punctuation">.</span>b<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">3.0</span><span class="token punctuation">;</span><span class="token comment">//加权平均</span>
    gl_FragColor <span class="token operator">=</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>average<span class="token punctuation">,</span> average<span class="token punctuation">,</span> average<span class="token punctuation">,</span> color<span class="token punctuation">.</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><blockquote>
<p>对于webgl加载纹理图像这里就不过多阐述</p>
</blockquote>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/14778602ab71490395751fcc56533153~tplv-k3u1fbpfcp-zoom-1.image" alt="在这里插入图片描述"></p>
<h3 id="_2-改变图象亮度" tabindex="-1"><a class="header-anchor" href="#_2-改变图象亮度" aria-hidden="true">#</a> [2]改变图象亮度</h3>
<p>实现原理，分别给<code>RGB</code>通道乘一个常数<code>p</code>，大于1时变亮，小于1时变暗</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8019em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8019em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">p</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:0.8019em;"></span><span class="mord"><span class="mord mathnormal">G</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8019em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal">G</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">p</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:0.8019em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8019em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">p</span></span></span></span></span></p>
<div class="language-glsl ext-glsl line-numbers-mode"><pre v-pre class="language-glsl"><code><span class="token keyword">precision</span> <span class="token keyword">mediump</span> <span class="token keyword">float</span><span class="token punctuation">;</span> 
<span class="token keyword">uniform</span> <span class="token keyword">sampler2D</span> u_image<span class="token punctuation">;</span>
<span class="token keyword">varying</span> <span class="token keyword">vec2</span> v_texCoord<span class="token punctuation">;</span>  
<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">vec4</span> color <span class="token operator">=</span> <span class="token function">texture2D</span><span class="token punctuation">(</span>u_image<span class="token punctuation">,</span> v_texCoord<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//原色</span>
    <span class="token keyword">float</span> p <span class="token operator">=</span> <span class="token number">2.0</span><span class="token punctuation">;</span>
    gl_FragColor <span class="token operator">=</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>color<span class="token punctuation">.</span>r <span class="token operator">*</span> p<span class="token punctuation">,</span>color<span class="token punctuation">.</span>g <span class="token operator">*</span> p<span class="token punctuation">,</span> color<span class="token punctuation">.</span>b <span class="token operator">*</span> p<span class="token punctuation">,</span> color<span class="token punctuation">.</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9b8f3fbc6e794eaa94d83dd077024e59~tplv-k3u1fbpfcp-zoom-1.image" alt="在这里插入图片描述"></p>
<p>处理使用公式直接对原图的<code>rgb</code>通道直接修改实现一些简单的图像处理效果</p>
<h2 id="_2-高斯模糊-平滑" tabindex="-1"><a class="header-anchor" href="#_2-高斯模糊-平滑" aria-hidden="true">#</a> 2.高斯模糊/平滑</h2>
<p>上面的滤镜都是一些直接操作图像颜色通道的简单滤镜，而现在一种相对复杂的滤镜——<strong>高斯模糊（Gaussian Blur）</strong>，这个滤镜可以对图像进行平滑处理（美颜）或者是做部分模糊处理，从而突出我们要呈现给用户的内容</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2069f6cc2cd74a888724a3d84703bfaa~tplv-k3u1fbpfcp-zoom-1.image" alt="在这里插入图片描述"></p>
<blockquote>
<p>对于高斯模糊/平滑在之前的计算机图形学文章中有做过笔记记录——<a href="https://www.luxd.fun/posts/Rasterization.html#%E4%BD%8E%E9%A2%91%E6%BB%A4%E6%B3%A2" target="_blank" rel="noopener noreferrer">Rasterization光栅化</a>，也是解决锯齿/走样Alising的一种方法，所以高斯模糊就是一个低通滤波（图像与二维正态分布做卷积），简单理解的话就是按照高斯分布的权重对当前像素点加权平均，而距离当前像素越近的点的权重越高，权重分布满足正态分布，从而达到平滑/模糊效果。</p>
</blockquote>
<p>为了减低算法复杂度和提高性能这里就不对每个像素计算整张图片像素的权重，而是采用——均值模糊/滤波(滤波器/卷积核，整体操作叫卷积)来做简单平滑/模糊，这里以3x3的卷积核方式做测试学习。</p>
<p>卷积内核就是一个 3×3 的矩阵，矩阵中的每一项代表当前处理的像素和周围8个像素的乘法因子， 相乘后将结果加起来除以内核权重（内核中所有值的和或 1.0 ，取二者中较大者）</p>
<p>这里采用最简单的3x3卷积核进行处理（也就是之前学计算机图形学中举的示例的那个卷积核—<a href="https://www.luxd.fun/posts/Rasterization.html#%E4%BD%8E%E9%A2%91%E6%BB%A4%E6%B3%A2" target="_blank" rel="noopener noreferrer">Rasterization光栅化</a>）</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/203f0468ab574d58ad30e90f1e89a677~tplv-k3u1fbpfcp-zoom-1.image" alt="在这里插入图片描述"></p>
<div class="language-glsl ext-glsl line-numbers-mode"><pre v-pre class="language-glsl"><code><span class="token keyword">precision</span> <span class="token keyword">mediump</span> <span class="token keyword">float</span><span class="token punctuation">;</span>

<span class="token comment">// 纹理</span>
<span class="token keyword">uniform</span> <span class="token keyword">sampler2D</span> u_image<span class="token punctuation">;</span>
<span class="token keyword">uniform</span> <span class="token keyword">vec2</span> u_textureSize<span class="token punctuation">;</span>
<span class="token keyword">uniform</span> <span class="token keyword">float</span> u_kernel<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">uniform</span> <span class="token keyword">float</span> u_kernelWeight<span class="token punctuation">;</span> <span class="token comment">//权重</span>

<span class="token comment">// 从顶点着色器传入的纹理坐标</span>
<span class="token keyword">varying</span> <span class="token keyword">vec2</span> v_texCoord<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">vec2</span> onePixel <span class="token operator">=</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span> <span class="token operator">/</span> u_textureSize<span class="token punctuation">;</span>
    <span class="token keyword">vec4</span> colorSum <span class="token operator">=</span>
    <span class="token function">texture2D</span><span class="token punctuation">(</span>u_image<span class="token punctuation">,</span> v_texCoord <span class="token operator">+</span> onePixel <span class="token operator">*</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> u_kernel<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span>
    <span class="token function">texture2D</span><span class="token punctuation">(</span>u_image<span class="token punctuation">,</span> v_texCoord <span class="token operator">+</span> onePixel <span class="token operator">*</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> u_kernel<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span>
    <span class="token function">texture2D</span><span class="token punctuation">(</span>u_image<span class="token punctuation">,</span> v_texCoord <span class="token operator">+</span> onePixel <span class="token operator">*</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> u_kernel<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">+</span>
    <span class="token function">texture2D</span><span class="token punctuation">(</span>u_image<span class="token punctuation">,</span> v_texCoord <span class="token operator">+</span> onePixel <span class="token operator">*</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>  <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> u_kernel<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">+</span>
    <span class="token function">texture2D</span><span class="token punctuation">(</span>u_image<span class="token punctuation">,</span> v_texCoord <span class="token operator">+</span> onePixel <span class="token operator">*</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span> <span class="token number">0</span><span class="token punctuation">,</span>  <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> u_kernel<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">+</span>
    <span class="token function">texture2D</span><span class="token punctuation">(</span>u_image<span class="token punctuation">,</span> v_texCoord <span class="token operator">+</span> onePixel <span class="token operator">*</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span> <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> u_kernel<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">+</span>
    <span class="token function">texture2D</span><span class="token punctuation">(</span>u_image<span class="token punctuation">,</span> v_texCoord <span class="token operator">+</span> onePixel <span class="token operator">*</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>  <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> u_kernel<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">+</span>
    <span class="token function">texture2D</span><span class="token punctuation">(</span>u_image<span class="token punctuation">,</span> v_texCoord <span class="token operator">+</span> onePixel <span class="token operator">*</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span> <span class="token number">0</span><span class="token punctuation">,</span>  <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> u_kernel<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">+</span>
    <span class="token function">texture2D</span><span class="token punctuation">(</span>u_image<span class="token punctuation">,</span> v_texCoord <span class="token operator">+</span> onePixel <span class="token operator">*</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span> <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> u_kernel<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span> <span class="token punctuation">;</span>

    <span class="token comment">// 只把rgb值求和除以权重</span>
    gl_FragColor <span class="token operator">=</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span><span class="token punctuation">(</span>colorSum <span class="token operator">/</span> u_kernelWeight<span class="token punctuation">)</span><span class="token punctuation">.</span>rgb<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><div class="language-javascript ext-js line-numbers-mode"><pre v-pre class="language-javascript"><code><span class="token keyword">const</span> kernelLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">"u_kernel[0]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> kernelWeightLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">"u_kernelWeight"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> gaussianBlur3 <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>


<span class="token keyword">function</span> <span class="token function">computeKernelWeight</span><span class="token punctuation">(</span><span class="token parameter">kernel</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    cosnt weight <span class="token operator">=</span> kernel<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">prev<span class="token punctuation">,</span> curr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    	<span class="token keyword">return</span> prev <span class="token operator">+</span> curr<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> weight <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> weight<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
gl<span class="token punctuation">.</span><span class="token function">uniform1fv</span><span class="token punctuation">(</span>kernelLocation<span class="token punctuation">,</span> gaussianBlur3<span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">uniform1f</span><span class="token punctuation">(</span>kernelWeightLocation<span class="token punctuation">,</span> <span class="token function">computeKernelWeight</span><span class="token punctuation">(</span>gaussianBlur3<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>在不同的需求情况下可以选择不同的卷积内核/矩阵来实现多种多样的处理效果<a href="https://webglfundamentals.org/webgl/lessons/zh_cn/webgl-image-processing.html#toc" target="_blank" rel="noopener noreferrer">webgl fundamentals网站有很多处理的示例</a>。</p>
<h2 id="_3-多层滤镜叠加" tabindex="-1"><a class="header-anchor" href="#_3-多层滤镜叠加" aria-hidden="true">#</a> 3.多层滤镜叠加</h2>
<p>要实现多层滤镜效果叠加可以采用帧缓冲区技术，创建两个或多个纹理，然后将一个纹理渲染的结果传递给另一个纹理，如果还要叠加，在将这个纹理的结果传递回去，依次叠加，像打乒乓球一样。</p>
<p>其实现大致思路为：首先在颜色缓冲区渲染绘制原图像，然后创建两纹理对象并将其分别关联到两个帧缓冲区对象中的颜色关联对象，然后定义一些滤镜卷积内核来叠加效果，先是绘制在定义的一个矩形框内把原始图像作为纹理贴上去（在第一个帧缓冲区中），然后将第一个帧缓冲取中绘制的原始图像做为一个纹理对象传递给第二个帧缓冲区中作为初始纹理图像，接下来在对其进行卷积核处理，处理完后再作为一个纹理图像（对象）传递给回第一个帧缓冲区，它将其看作初始纹理做卷积核处理，一直如此直至将要叠加的效果全都叠加上去，最后将最终结果作为一个纹理对象传递个颜色缓冲区进行绘制<code>gl.bindFramebuffer(gl.FRAMEBUFFER, null);</code>。</p>
<p>下面截取部分核心代码进行说明</p>
<div class="language-javascript ext-js line-numbers-mode"><pre v-pre class="language-javascript"><code><span class="token comment">//从原图开始</span>
gl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> originalImageTexture<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//fbo为null时在颜色缓冲区,为帧缓冲区对象时在帧缓冲区中绘制</span>
<span class="token keyword">function</span> <span class="token function">setFramebuffer</span><span class="token punctuation">(</span><span class="token parameter">fbo<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    gl<span class="token punctuation">.</span><span class="token function">bindFramebuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">FRAMEBUFFER</span><span class="token punctuation">,</span> fbo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//传递给shader帧缓冲区或者颜色缓冲区的高宽</span>
    gl<span class="token punctuation">.</span><span class="token function">uniform2f</span><span class="token punctuation">(</span>resolutionLocation<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//设置屏幕空间为帧缓冲区大小</span>
    gl<span class="token punctuation">.</span><span class="token function">viewport</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//循环叠加绘制多种滤镜</span>
<span class="token keyword">var</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> ii <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> ii <span class="token operator">&lt;</span> tbody<span class="token punctuation">.</span>rows<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>ii<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> checkbox <span class="token operator">=</span> tbody<span class="token punctuation">.</span>rows<span class="token punctuation">[</span>ii<span class="token punctuation">]</span><span class="token punctuation">.</span>firstChild<span class="token punctuation">.</span>firstChild<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>checkbox<span class="token punctuation">.</span>checked<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//在帧缓冲区中绘制</span>
        <span class="token function">setFramebuffer</span><span class="token punctuation">(</span>framebuffers<span class="token punctuation">[</span>count <span class="token operator">%</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> image<span class="token punctuation">.</span>width<span class="token punctuation">,</span> image<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">drawWithKernel</span><span class="token punctuation">(</span>checkbox<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//将前一个绘制</span>
        gl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> textures<span class="token punctuation">[</span>count <span class="token operator">%</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token operator">++</span>count<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">//最后在颜色缓冲区中将所有滤镜叠加的效果作为一个纹理对象传递个颜色缓冲区对象绘制</span>
<span class="token function">setFramebuffer</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>width<span class="token punctuation">,</span> gl<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7c579013394e48ab9d0b51715ce136f7~tplv-k3u1fbpfcp-zoom-1.image" alt="在这里插入图片描述"></p>
<p>示例代码：<a href="https://github.com/bigbigbig2/WebGL-and-shaders-study/tree/master/%E5%83%8F%E7%B4%A0%E5%9B%BE%E8%B1%A1%E5%A4%84%E7%90%86" target="_blank" rel="noopener noreferrer">像素图象处理</a></p>
<p>参考：</p>
<ul>
<li>
<p>https://webglfundamentals.org/webgl/lessons/zh_cn/</p>
</li>
<li>
<p><a href="https://time.geekbang.org/column/intro/100053801" target="_blank" rel="noopener noreferrer">跟月影学可视化</a></p>
</li>
</ul>
</template>
